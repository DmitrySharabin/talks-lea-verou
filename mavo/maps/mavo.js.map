{"version":3,"sources":["bliss.min.js","jsep.min.js","stretchy.js","mavo.js","util.js","permissions.js","backend.js","node.js","group.js","primitive.js","elements.js","collection.js","expression.js","expressiontext.js","expressions.js","mv-if.js","functions.js","prettyprint.js","debug.js","backend.dropbox.js","backend.github.js"],"names":[],"mappings":"AAAA;ACAA;AACA;AACA;ACFA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC9LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AChoBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC1LA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC3IA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7SA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7vBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACxNA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACnuBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC7NA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AClMA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpRA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACpHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACraA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACjYA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AC/YA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;ACvHA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"mavo.js","sourcesContent":["!function(){\"use strict\";function t(e,n,s){return n=void 0===n?1:n,s=s||n+1,1>=s-n?function(){if(arguments.length<=n||\"string\"===r.type(arguments[n]))return e.apply(this,arguments);var t,s=arguments[n];for(var i in s){var o=Array.from(arguments);o.splice(n,1,i,s[i]),t=e.apply(this,o)}return t}:t(t(e,n+1,s),n,s-1)}function e(t,r,s){var i=n(s);if(\"string\"===i){var o=Object.getOwnPropertyDescriptor(r,s);!o||o.writable&&o.configurable&&o.enumerable&&!o.get&&!o.set?t[s]=r[s]:(delete t[s],Object.defineProperty(t,s,o))}else if(\"array\"===i)s.forEach(function(n){n in r&&e(t,r,n)});else for(var a in r)s&&(\"regexp\"===i&&!s.test(a)||\"function\"===i&&!s.call(r,a))||e(t,r,a);return t}function n(t){if(null===t)return\"null\";if(void 0===t)return\"undefined\";var e=(Object.prototype.toString.call(t).match(/^\\[object\\s+(.*?)\\]$/)[1]||\"\").toLowerCase();return\"number\"==e&&isNaN(t)?\"nan\":e}var r=self.Bliss=e(function(t,e){return 2==arguments.length&&!e||!t?null:\"string\"===r.type(t)?(e||document).querySelector(t):t||null},self.Bliss);e(r,{extend:e,overload:t,type:n,property:r.property||\"_\",sources:{},noop:function(){},$:function(t,e){return t instanceof Node||t instanceof Window?[t]:2!=arguments.length||e?Array.from(\"string\"==typeof t?(e||document).querySelectorAll(t):t||[]):[]},defined:function(){for(var t=0;t<arguments.length;t++)if(void 0!==arguments[t])return arguments[t]},create:function(t,e){return t instanceof Node?r.set(t,e):(1===arguments.length&&(\"string\"===r.type(t)?e={}:(e=t,t=e.tag,e=r.extend({},e,function(t){return\"tag\"!==t}))),r.set(document.createElement(t||\"div\"),e))},each:function(t,e,n){n=n||{};for(var r in t)n[r]=e.call(t,r,t[r]);return n},ready:function(t){return t=t||document,new Promise(function(e,n){\"loading\"!==t.readyState?e():t.addEventListener(\"DOMContentLoaded\",function(){e()})})},Class:function(t){var e,n=[\"constructor\",\"extends\",\"abstract\",\"static\"].concat(Object.keys(r.classProps)),s=t.hasOwnProperty(\"constructor\")?t.constructor:r.noop;2==arguments.length?(e=arguments[0],t=arguments[1]):(e=function(){if(this.constructor.__abstract&&this.constructor===e)throw new Error(\"Abstract classes cannot be directly instantiated.\");e[\"super\"]&&e[\"super\"].apply(this,arguments),s.apply(this,arguments)},e[\"super\"]=t[\"extends\"]||null,e.prototype=r.extend(Object.create(e[\"super\"]?e[\"super\"].prototype:Object),{constructor:e}),e.prototype[\"super\"]=e[\"super\"]?e[\"super\"].prototype:null,e.__abstract=!!t[\"abstract\"]);var i=function(t){return this.hasOwnProperty(t)&&-1===n.indexOf(t)};if(t[\"static\"]){r.extend(e,t[\"static\"],i);for(var o in r.classProps)o in t[\"static\"]&&r.classProps[o](e,t[\"static\"][o])}r.extend(e.prototype,t,i);for(var o in r.classProps)o in t&&r.classProps[o](e.prototype,t[o]);return e},classProps:{lazy:t(function(t,e,n){return Object.defineProperty(t,e,{get:function(){var t=n.call(this);return Object.defineProperty(this,e,{value:t,configurable:!0,enumerable:!0,writable:!0}),t},set:function(t){Object.defineProperty(this,e,{value:t,configurable:!0,enumerable:!0,writable:!0})},configurable:!0,enumerable:!0}),t}),live:t(function(t,e,n){return\"function\"===r.type(n)&&(n={set:n}),Object.defineProperty(t,e,{get:function(){var t=this[\"_\"+e],r=n.get&&n.get.call(this,t);return void 0!==r?r:t},set:function(t){var r=this[\"_\"+e],s=n.set&&n.set.call(this,t,r);this[\"_\"+e]=void 0!==s?s:t},configurable:n.configurable,enumerable:n.enumerable}),t})},include:function(){var t=arguments[arguments.length-1],e=2===arguments.length?arguments[0]:!1,n=document.createElement(\"script\");return e?Promise.resolve():new Promise(function(e,s){r.set(n,{async:!0,onload:function(){e(),r.remove(n)},onerror:function(){s()},src:t,inside:document.head})})},fetch:function(t,n){if(!t)throw new TypeError(\"URL parameter is mandatory and cannot be \"+t);var s=e({url:new URL(t,location),data:\"\",method:\"GET\",headers:{},xhr:new XMLHttpRequest},n);s.method=s.method.toUpperCase(),r.hooks.run(\"fetch-args\",s),\"GET\"===s.method&&s.data&&(s.url.search+=s.data),document.body.setAttribute(\"data-loading\",s.url),s.xhr.open(s.method,s.url.href,s.async!==!1,s.user,s.password);for(var i in n)if(i in s.xhr)try{s.xhr[i]=n[i]}catch(o){self.console&&console.error(o)}\"GET\"===s.method||s.headers[\"Content-type\"]||s.headers[\"Content-Type\"]||s.xhr.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\");for(var a in s.headers)s.xhr.setRequestHeader(a,s.headers[a]);return new Promise(function(t,e){s.xhr.onload=function(){document.body.removeAttribute(\"data-loading\"),0===s.xhr.status||s.xhr.status>=200&&s.xhr.status<300||304===s.xhr.status?t(s.xhr):e(r.extend(Error(s.xhr.statusText),{xhr:s.xhr,get status(){return this.xhr.status}}))},s.xhr.onerror=function(){document.body.removeAttribute(\"data-loading\"),e(r.extend(Error(\"Network Error\"),{xhr:s.xhr}))},s.xhr.ontimeout=function(){document.body.removeAttribute(\"data-loading\"),e(r.extend(Error(\"Network Timeout\"),{xhr:s.xhr}))},s.xhr.send(\"GET\"===s.method?null:s.data)})},value:function(t){var e=\"string\"!==r.type(t);return r.$(arguments).slice(+e).reduce(function(t,e){return t&&t[e]},e?t:self)}}),r.Hooks=new r.Class({add:function(t,e,n){(Array.isArray(t)?t:[t]).forEach(function(t){this[t]=this[t]||[],this[t][n?\"unshift\":\"push\"](e)},this)},run:function(t,e){this[t]=this[t]||[],this[t].forEach(function(t){t.call(e&&e.context?e.context:e,e)})}}),r.hooks=new r.Hooks;var s=r.property;r.Element=function(t){this.subject=t,this.data={},this.bliss={}},r.Element.prototype={set:t(function(t,e){t in r.setProps?r.setProps[t].call(this,e):t in this?this[t]=e:this.setAttribute(t,e)},0),transition:function(t,e){return e=+e||400,new Promise(function(n,s){if(\"transition\"in this.style){var i=r.extend({},this.style,/^transition(Duration|Property)$/);r.style(this,{transitionDuration:(e||400)+\"ms\",transitionProperty:Object.keys(t).join(\", \")}),r.once(this,\"transitionend\",function(){clearTimeout(o),r.style(this,i),n(this)});var o=setTimeout(n,e+50,this);r.style(this,t)}else r.style(this,t),n(this)}.bind(this))},fire:function(t,e){var n=document.createEvent(\"HTMLEvents\");return n.initEvent(t,!0,!0),this.dispatchEvent(r.extend(n,e))},unbind:t(function(t,e){(t||\"\").split(/\\s+/).forEach(function(t){if(s in this&&(t.indexOf(\".\")>-1||!e)){t=(t||\"\").split(\".\");var n=t[1];t=t[0];var r=this[s].bliss.listeners=this[s].bliss.listeners||{};for(var i in r)if(!t||i===t)for(var o,a=0;o=r[i][a];a++)n&&n!==o.className||e&&e!==o.callback||(this.removeEventListener(i,o.callback,o.capture),a--)}else this.removeEventListener(t,e)},this)},0)},r.setProps={style:function(t){r.extend(this.style,t)},attributes:function(t){for(var e in t)this.setAttribute(e,t[e])},properties:function(t){r.extend(this,t)},events:function(t){if(t&&t.addEventListener){var e=this;if(t[s]&&t[s].bliss){var n=t[s].bliss.listeners;for(var i in n)n[i].forEach(function(t){e.addEventListener(i,t.callback,t.capture)})}for(var o in t)0===o.indexOf(\"on\")&&(this[o]=t[o])}else if(arguments.length>1&&\"string\"===r.type(t)){var a=arguments[1],u=arguments[2];t.split(/\\s+/).forEach(function(t){this.addEventListener(t,a,u)},this)}else for(var c in t)r.events(this,c,t[c])},once:t(function(t,e){t=t.split(/\\s+/);var n=this,r=function(){return t.forEach(function(t){n.removeEventListener(t,r)}),e.apply(n,arguments)};t.forEach(function(t){n.addEventListener(t,r)})},0),delegate:t(function(t,e,n){this.addEventListener(t,function(t){t.target.closest(e)&&n.call(this,t)})},0,2),contents:function(t){(t||0===t)&&(Array.isArray(t)?t:[t]).forEach(function(t){var e=r.type(t);/^(string|number)$/.test(e)?t=document.createTextNode(t+\"\"):\"object\"===e&&(t=r.create(t)),t instanceof Node&&this.appendChild(t)},this)},inside:function(t){t.appendChild(this)},before:function(t){t.parentNode.insertBefore(this,t)},after:function(t){t.parentNode.insertBefore(this,t.nextSibling)},start:function(t){t.insertBefore(this,t.firstChild)},around:function(t){t.parentNode&&r.before(this,t),(/^template$/i.test(this.nodeName)?this.content||this:this).appendChild(t)}},r.Array=function(t){this.subject=t},r.Array.prototype={all:function(t){var e=$$(arguments).slice(1);return this[t].apply(this,e)}},r.add=t(function(t,e,n,s){n=r.extend({$:!0,element:!0,array:!0},n),\"function\"==r.type(e)&&(!n.element||t in r.Element.prototype&&s||(r.Element.prototype[t]=function(){return this.subject&&r.defined(e.apply(this.subject,arguments),this.subject)}),!n.array||t in r.Array.prototype&&s||(r.Array.prototype[t]=function(){var t=arguments;return this.subject.map(function(n){return n&&r.defined(e.apply(n,t),n)})}),n.$&&(r.sources[t]=r[t]=e,(n.array||n.element)&&(r[t]=function(){var e=[].slice.apply(arguments),s=e.shift(),i=n.array&&Array.isArray(s)?\"Array\":\"Element\";return r[i].prototype[t].apply({subject:s},e)})))},0),r.add(r.Array.prototype,{element:!1}),r.add(r.Element.prototype),r.add(r.setProps),r.add(r.classProps,{element:!1,array:!1});var i=document.createElement(\"_\");r.add(r.extend({},HTMLElement.prototype,function(t){return\"function\"===r.type(i[t])}),null,!0)}(),function(t){\"use strict\";if(Bliss&&!Bliss.shy){var e=Bliss.property;if(t.add({clone:function(){var e=this.cloneNode(!0),n=t.$(\"*\",e).concat(e);return t.$(\"*\",this).concat(this).forEach(function(e,r,s){t.events(n[r],e),n[r]._.data=t.extend({},e._.data)}),e}},{array:!1}),Object.defineProperty(Node.prototype,e,{get:function o(){return Object.defineProperty(Node.prototype,e,{get:void 0}),Object.defineProperty(this,e,{value:new t.Element(this)}),Object.defineProperty(Node.prototype,e,{get:o}),this[e]},configurable:!0}),Object.defineProperty(Array.prototype,e,{get:function(){return Object.defineProperty(this,e,{value:new t.Array(this)}),this[e]},configurable:!0}),self.EventTarget&&\"addEventListener\"in EventTarget.prototype){var n=EventTarget.prototype.addEventListener,r=EventTarget.prototype.removeEventListener,s=function(t,e,n){return n.callback===t&&n.capture==e},i=function(){return!s.apply(this,arguments)};EventTarget.prototype.addEventListener=function(t,r,i){if(this&&this[e]&&this[e].bliss&&r){var o=this[e].bliss.listeners=this[e].bliss.listeners||{};if(t.indexOf(\".\")>-1){t=t.split(\".\");var a=t[1];t=t[0]}o[t]=o[t]||[],0===o[t].filter(s.bind(null,r,i)).length&&o[t].push({callback:r,capture:i,className:a})}return n.call(this,t,r,i)},EventTarget.prototype.removeEventListener=function(t,n,s){if(this&&this[e]&&this[e].bliss&&n){var o=this[e].bliss.listeners=this[e].bliss.listeners||{};o[t]&&(o[t]=o[t].filter(i.bind(null,n,s)))}return r.call(this,t,n,s)}}self.$=self.$||t,self.$$=self.$$||t.$}}(Bliss);","/* jsep v0.3.1 (http://jsep.from.so/) */\n!function(a){\"use strict\";var b=\"Compound\",c=\"Identifier\",d=\"MemberExpression\",e=\"Literal\",f=\"ThisExpression\",g=\"CallExpression\",h=\"UnaryExpression\",i=\"BinaryExpression\",j=\"LogicalExpression\",k=\"ConditionalExpression\",l=\"ArrayExpression\",m=46,n=44,o=39,p=34,q=40,r=41,s=91,t=93,u=63,v=59,w=58,x=function(a,b){var c=new Error(a+\" at character \"+b);throw c.index=b,c.description=a,c},y=!0,z={\"-\":y,\"!\":y,\"~\":y,\"+\":y},A={\"||\":1,\"&&\":2,\"|\":3,\"^\":4,\"&\":5,\"==\":6,\"!=\":6,\"===\":6,\"!==\":6,\"<\":7,\">\":7,\"<=\":7,\">=\":7,\"<<\":8,\">>\":8,\">>>\":8,\"+\":9,\"-\":9,\"*\":10,\"/\":10,\"%\":10},B=function(a){var b,c=0;for(var d in a)(b=d.length)>c&&a.hasOwnProperty(d)&&(c=b);return c},C=B(z),D=B(A),E={\"true\":!0,\"false\":!1,\"null\":null},F=\"this\",G=function(a){return A[a]||0},H=function(a,b,c){var d=\"||\"===a||\"&&\"===a?j:i;return{type:d,operator:a,left:b,right:c}},I=function(a){return a>=48&&a<=57},J=function(a){return 36===a||95===a||a>=65&&a<=90||a>=97&&a<=122||a>=128&&!A[String.fromCharCode(a)]},K=function(a){return 36===a||95===a||a>=65&&a<=90||a>=97&&a<=122||a>=48&&a<=57||a>=128&&!A[String.fromCharCode(a)]},L=function(a){for(var i,j,y=0,B=a.charAt,L=a.charCodeAt,M=function(b){return B.call(a,b)},N=function(b){return L.call(a,b)},O=a.length,P=function(){for(var a=N(y);32===a||9===a;)a=N(++y)},Q=function(){var a,b,c=S();return P(),N(y)!==u?c:(y++,a=Q(),a||x(\"Expected expression\",y),P(),N(y)===w?(y++,b=Q(),b||x(\"Expected expression\",y),{type:k,test:c,consequent:a,alternate:b}):void x(\"Expected :\",y))},R=function(){P();for(var b=a.substr(y,D),c=b.length;c>0;){if(A.hasOwnProperty(b))return y+=c,b;b=b.substr(0,--c)}return!1},S=function(){var a,b,c,d,e,f,g,h;if(f=T(),b=R(),!b)return f;for(e={value:b,prec:G(b)},g=T(),g||x(\"Expected expression after \"+b,y),d=[f,e,g];(b=R())&&(c=G(b),0!==c);){for(e={value:b,prec:c};d.length>2&&c<=d[d.length-2].prec;)g=d.pop(),b=d.pop().value,f=d.pop(),a=H(b,f,g),d.push(a);a=T(),a||x(\"Expected expression after \"+b,y),d.push(e,a)}for(h=d.length-1,a=d[h];h>1;)a=H(d[h-1].value,d[h-2],a),h-=2;return a},T=function(){var b,c,d;if(P(),b=N(y),I(b)||b===m)return U();if(b===o||b===p)return V();if(J(b)||b===q)return Y();if(b===s)return $();for(c=a.substr(y,C),d=c.length;d>0;){if(z.hasOwnProperty(c))return y+=d,{type:h,operator:c,argument:T(),prefix:!0};c=c.substr(0,--d)}return!1},U=function(){for(var a,b,c=\"\";I(N(y));)c+=M(y++);if(N(y)===m)for(c+=M(y++);I(N(y));)c+=M(y++);if(a=M(y),\"e\"===a||\"E\"===a){for(c+=M(y++),a=M(y),\"+\"!==a&&\"-\"!==a||(c+=M(y++));I(N(y));)c+=M(y++);I(N(y-1))||x(\"Expected exponent (\"+c+M(y)+\")\",y)}return b=N(y),J(b)?x(\"Variable names cannot start with a number (\"+c+M(y)+\")\",y):b===m&&x(\"Unexpected period\",y),{type:e,value:parseFloat(c),raw:c}},V=function(){for(var a,b=\"\",c=M(y++),d=!1;y<O;){if(a=M(y++),a===c){d=!0;break}if(\"\\\\\"===a)switch(a=M(y++)){case\"n\":b+=\"\\n\";break;case\"r\":b+=\"\\r\";break;case\"t\":b+=\"\\t\";break;case\"b\":b+=\"\\b\";break;case\"f\":b+=\"\\f\";break;case\"v\":b+=\"\\x0B\";break;default:b+=\"\\\\\"+a}else b+=a}return d||x('Unclosed quote after \"'+b+'\"',y),{type:e,value:b,raw:c+b+c}},W=function(){var b,d=N(y),g=y;for(J(d)?y++:x(\"Unexpected \"+M(y),y);y<O&&(d=N(y),K(d));)y++;return b=a.slice(g,y),E.hasOwnProperty(b)?{type:e,value:E[b],raw:b}:b===F?{type:f}:{type:c,name:b}},X=function(a){for(var c,d,e=[],f=!1;y<O;){if(P(),c=N(y),c===a){f=!0,y++;break}c===n?y++:(d=Q(),d&&d.type!==b||x(\"Expected comma\",y),e.push(d))}return f||x(\"Expected \"+String.fromCharCode(a),y),e},Y=function(){var a,b;for(a=N(y),b=a===q?Z():W(),P(),a=N(y);a===m||a===s||a===q;)y++,a===m?(P(),b={type:d,computed:!1,object:b,property:W()}):a===s?(b={type:d,computed:!0,object:b,property:Q()},P(),a=N(y),a!==t&&x(\"Unclosed [\",y),y++):a===q&&(b={type:g,arguments:X(r),callee:b}),P(),a=N(y);return b},Z=function(){y++;var a=Q();return P(),N(y)===r?(y++,a):void x(\"Unclosed (\",y)},$=function(){return y++,{type:l,elements:X(t)}},_=[];y<O;)i=N(y),i===v||i===n?y++:(j=Q())?_.push(j):y<O&&x('Unexpected \"'+M(y)+'\"',y);return 1===_.length?_[0]:{type:b,body:_}};if(L.version=\"0.3.1\",L.toString=function(){return\"JavaScript Expression Parser (JSEP) v\"+L.version},L.addUnaryOp=function(a){return C=Math.max(a.length,C),z[a]=y,this},L.addBinaryOp=function(a,b){return D=Math.max(a.length,D),A[a]=b,this},L.addLiteral=function(a,b){return E[a]=b,this},L.removeUnaryOp=function(a){return delete z[a],a.length===C&&(C=B(z)),this},L.removeBinaryOp=function(a){return delete A[a],a.length===D&&(D=B(A)),this},L.removeLiteral=function(a){return delete E[a],this},\"undefined\"==typeof exports){var M=a.jsep;a.jsep=L,L.noConflict=function(){return a.jsep===L&&(a.jsep=M),L}}else\"undefined\"!=typeof module&&module.exports?exports=module.exports=L:exports.parse=L}(this);\n//# sourceMappingURL=jsep.min.js.map","/*\n * Stretchy: Form element autosizing, the way it should be.\n * by Lea Verou http://lea.verou.me\n * MIT license\n */\n(function() {\n\nif (!self.Element) {\n\treturn; // super old browser\n}\n\nif (!Element.prototype.matches) {\n\tElement.prototype.matches = Element.prototype.webkitMatchesSelector || Element.prototype.mozMatchesSelector || Element.prototype.msMatchesSelector || Element.prototype.oMatchesSelector || null;\n}\n\nif (!Element.prototype.matches) {\n\treturn;\n}\n\nfunction $$(expr, con) {\n\treturn expr instanceof Node || expr instanceof Window? [expr] :\n\t       [].slice.call(typeof expr == \"string\"? (con || document).querySelectorAll(expr) : expr || []);\n}\n\nvar _ = self.Stretchy = {\n\tselectors: {\n\t\tbase: 'textarea, select:not([size]), input:not([type]), input[type=\"' + \"text url email tel\".split(\" \").join('\"], input[type=\"') + '\"]',\n\t\tfilter: \"*\"\n\t},\n\n\t// Script element this was included with, if any\n\tscript: document.currentScript || $$(\"script\").pop(),\n\n\t// Autosize one element. The core of Stretchy.\n\tresize: function(element) {\n\t\tif (!_.resizes(element)) {\n\t\t\treturn;\n\t\t}\n\n\t\tvar cs = getComputedStyle(element);\n\t\tvar offset = 0;\n\n\t\tif (!element.value && element.placeholder) {\n\t\t\tvar empty = true;\n\t\t\telement.value = element.placeholder;\n\t\t}\n\n\t\tvar type = element.nodeName.toLowerCase();\n\n\t\tif (type == \"textarea\") {\n\t\t\telement.style.height = \"0\";\n\n\t\t\tif (cs.boxSizing == \"border-box\") {\n\t\t\t\toffset = element.offsetHeight;\n\t\t\t}\n\t\t\telse if (cs.boxSizing == \"content-box\") {\n\t\t\t\toffset = -element.clientHeight;\n\t\t\t}\n\n\t\t\telement.style.height = element.scrollHeight + offset + \"px\";\n\t\t}\n\t\telse if(type == \"input\") {\n\t\t\telement.style.width = \"0\";\n\n\t\t\tif (cs.boxSizing == \"border-box\") {\n\t\t\t\toffset = element.offsetWidth;\n\t\t\t}\n\t\t\telse if (cs.boxSizing == \"padding-box\") {\n\t\t\t\toffset = element.clientWidth;\n\t\t\t}\n\n\t\t\t// Safari misreports scrollWidth, so we will instead set scrollLeft to a\n\t\t\t// huge number, and read that back to see what it was clipped to\n\t\t\telement.scrollLeft = 1e+10;\n\n\t\t\tvar width = Math.max(element.scrollLeft + offset, element.scrollWidth - element.clientWidth);\n\n\t\t\telement.style.width = width + \"px\";\n\t\t}\n\t\telse if (type == \"select\") {\n\t\t\tvar selectedIndex = element.selectedIndex > 0? element.selectedIndex : 0;\n\n\t\t\t// Need to use dummy element to measure :(\n\t\t\tvar option = document.createElement(\"_\");\n\t\t\toption.textContent = element.options[selectedIndex].textContent;\n\t\t\telement.parentNode.insertBefore(option, element.nextSibling);\n\n\t\t\t// The name of the appearance property, as it might be prefixed\n\t\t\tvar appearance;\n\n\t\t\tfor (var property in cs) {\n\t\t\t\tvar value = cs[property];\n\t\t\t\tif (!/^(width|webkitLogicalWidth|length)$/.test(property) && typeof value == \"string\") {\n\t\t\t\t\t//console.log(property, option.offsetWidth, cs[property]);\n\t\t\t\t\toption.style[property] = value;\n\n\t\t\t\t\tif (/appearance$/i.test(property)) {\n\t\t\t\t\t\tappearance = property;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toption.style.width = \"\";\n\n\t\t\tif (option.offsetWidth > 0) {\n\t\t\t\telement.style.width = option.offsetWidth + \"px\";\n\n\t\t\t\tif (!cs[appearance] || cs[appearance] !== \"none\") {\n\t\t\t\t\t// Account for arrow\n\t\t\t\t\telement.style.width = \"calc(\" + element.style.width + \" + 2em)\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toption.parentNode.removeChild(option);\n\t\t\toption = null;\n\t\t}\n\n\t\tif (empty) {\n\t\t\telement.value = \"\";\n\t\t}\n\t},\n\n\t// Autosize multiple elements\n\tresizeAll: function(elements) {\n\t\t$$(elements || _.selectors.base).forEach(function (element) {\n\t\t\t_.resize(element);\n\t\t});\n\t},\n\n\tactive: true,\n\n\t// Will stretchy do anything for this element?\n\tresizes: function(element) {\n\t\treturn element &&\n\t\t       element.parentNode &&\n\t\t       element.matches &&\n\t\t       element.matches(_.selectors.base) &&\n\t\t       element.matches(_.selectors.filter);\n\t},\n\n\tinit: function(){\n\t\t_.selectors.filter = _.script.getAttribute(\"data-filter\") ||\n\t\t                     ($$(\"[data-stretchy-filter]\").pop() || document.body).getAttribute(\"data-stretchy-filter\") || Stretchy.selectors.filter || \"*\";\n\n\t\t_.resizeAll();\n\t},\n\n\t$$: $$\n};\n\n// Autosize all elements once the DOM is loaded\n\n// DOM already loaded?\nif (document.readyState !== \"loading\") {\n\t_.init();\n}\nelse {\n\t// Wait for it\n\tdocument.addEventListener(\"DOMContentLoaded\", _.init);\n}\n\n// Listen for changes\nvar listener = function(evt) {\n\tif (_.active) {\n\t\t_.resize(evt.target);\n\t}\n};\n\ndocument.documentElement.addEventListener(\"input\", listener);\n\n// Firefox fires a change event instead of an input event\ndocument.documentElement.addEventListener(\"change\", listener);\n\n// Listen for new elements\nif (self.MutationObserver) {\n\t(new MutationObserver(function(mutations) {\n\t\tif (_.active) {\n\t\t\tmutations.forEach(function(mutation) {\n\t\t\t\tif (mutation.type == \"childList\") {\n\t\t\t\t\tStretchy.resizeAll(mutation.addedNodes);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t})).observe(document.documentElement, {\n\t\tchildList: true,\n\t\tsubtree: true\n\t});\n}\n\n})();\n","(function ($, $$) {\n\n\"use strict\";\n\nvar _ = self.Mavo = $.Class({\n\tconstructor: function (element) {\n\t\tthis.treeBuilt = Mavo.defer();\n\n\t\tthis.element = element;\n\n\t\t// Index among other mavos in the page, 1 is first\n\t\tthis.index = _.all.push(this);\n\n\t\t// Convert any data-mv-* attributes to mv-*\n\t\tvar dataMv = _.attributes.map(attribute => `[data-${attribute}]`);\n\t\tfor (let element of $$(dataMv.join(\", \"), this.element).concat(this.element)) {\n\t\t\tfor (let attribute of _.attributes) {\n\t\t\t\tlet value = element.getAttribute(\"data-\" + attribute);\n\n\t\t\t\tif (value !== null) {\n\t\t\t\t\telement.setAttribute(attribute, value);\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\n\t\t// Assign a unique (for the page) id to this mavo instance\n\t\t_.allIds.push(this.id = Mavo.getAttribute(this.element, \"mv-app\", \"id\") || `mavo${this.index}`);\n\t\tthis.element.setAttribute(\"mv-app\", this.id);\n\n\t\tthis.unhandled = this.element.classList.contains(\"mv-keep-unhandled\");\n\t\tthis.autoEdit = this.element.classList.contains(\"mv-autoedit\");\n\n\t\tif (this.index == 1) {\n\t\t\tthis.storage = _.Functions.urlOption(\"store\");\n\t\t\tthis.source = _.Functions.urlOption(\"source\");\n\t\t}\n\n\t\tthis.storage = this.storage || _.Functions.urlOption(`${this.id}_store`) || this.element.getAttribute(\"mv-storage\") || null;\n\t\tthis.source = this.source || _.Functions.urlOption(`${this.id}_source`) || this.element.getAttribute(\"mv-init\") || null;\n\n\t\tif (this.storage) {\n\t\t\tthis.storage = this.storage.trim();\n\n\t\t\tthis.storage = this.storage == \"none\"? null : _.Backend.create(this.storage, this);\n\t\t}\n\n\t\tif (this.source) {\n\t\t\tthis.source = _.Backend.create(this.source, this);\n\t\t}\n\n\t\tthis.permissions = this.storage ? this.storage.permissions : new Mavo.Permissions();\n\n\t\t// Ctrl + S or Cmd + S to save\n\t\tthis.element.addEventListener(\"keydown\", evt => {\n\t\t\tif (evt.keyCode == 83 && evt[_.superKey]) {\n\t\t\t\tevt.preventDefault();\n\t\t\t\tthis.save();\n\t\t\t}\n\t\t});\n\n\t\tthis.element.setAttribute(\"typeof\", \"\");\n\n\t\t// Apply heuristic for groups\n\t\t$$(_.selectors.primitive, element).forEach(element => {\n\t\t\tvar hasChildren = $(`${_.selectors.not(_.selectors.formControl)}, ${_.selectors.property}`, element);\n\n\t\t\tif (hasChildren) {\n\t\t\t\tvar defaults = Mavo.Primitive.getDefaults(element);\n\t\t\t\tvar isCollection = Mavo.is(\"multiple\", element);\n\n\t\t\t\tif (isCollection || !Mavo.Primitive.getValueAttribute(element, defaults) && !defaults.hasChildren) {\n\t\t\t\t\telement.setAttribute(\"typeof\", \"\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tthis.ui = {\n\t\t\tbar: $(\".mv-bar\", this.element) || $.create({\n\t\t\t\tclassName: \"mv-bar mv-ui\",\n\t\t\t\tstart: this.element\n\t\t\t})\n\t\t};\n\n\t\tthis.ui.status = $(\".mv-status\", this.ui.bar) || $.create(\"span\", {\n\t\t\tclassName: \"mv-status\",\n\t\t\tinside: this.ui.bar\n\t\t});\n\n\t\tif (this.storage) {\n\t\t\t// Reflect backend permissions in global permissions\n\t\t\tthis.authControls = {};\n\n\t\t\tthis.permissions.can(\"login\", () => {\n\t\t\t\t// #login authenticates if only 1 mavo on the page, or if the first.\n\t\t\t\t// Otherwise, we have to generate a slightly more complex hash\n\t\t\t\tthis.loginHash = \"#login\" + (Mavo.all[0] === this? \"\" : \"-\" + this.id);\n\n\t\t\t\tthis.authControls.login = $.create({\n\t\t\t\t\ttag: \"a\",\n\t\t\t\t\thref: this.loginHash,\n\t\t\t\t\ttextContent: \"Login\",\n\t\t\t\t\tclassName: \"mv-login mv-button\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: evt => {\n\t\t\t\t\t\t\tevt.preventDefault();\n\t\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tafter: $(\".mv-status\", this.ui.bar)\n\t\t\t\t});\n\n\t\t\t\t// We also support a hash to trigger login, in case the user doesn't want visible login UI\n\t\t\t\tvar login;\n\t\t\t\t(login = () => {\n\t\t\t\t\tif (location.hash === this.loginHash) {\n\t\t\t\t\t\t// This just does location.hash = \"\" without getting a pointless # at the end of the URL\n\t\t\t\t\t\thistory.replaceState(null, document.title, new URL(\"\", location) + \"\");\n\t\t\t\t\t\tthis.storage.login();\n\t\t\t\t\t}\n\t\t\t\t})();\n\t\t\t\twindow.addEventListener(\"hashchange.mavo\", login);\n\t\t\t}, () => {\n\t\t\t\t$.remove(this.authControls.login);\n\t\t\t\tthis.element._.unbind(\"hashchange.mavo\");\n\t\t\t});\n\n\t\t\t// Update login status\n\t\t\tthis.element.addEventListener(\"mavo:login.mavo\", evt => {\n\t\t\t\tif (evt.backend == this.storage) { // ignore logins from source backend\n\t\t\t\t\tvar status = $(\".mv-status\", this.ui.bar);\n\t\t\t\t\tstatus.innerHTML = \"\";\n\t\t\t\t\tstatus._.contents([\n\t\t\t\t\t\t\"Logged in to \" + evt.backend.id + \" as \",\n\t\t\t\t\t\t{tag: \"strong\", innerHTML: evt.name},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\t\ttextContent: \"Logout\",\n\t\t\t\t\t\t\tclassName: \"mv-logout\",\n\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\tclick: e => evt.backend.logout()\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t}\n\t\t\t\t\t]);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"mavo:logout.mavo\", evt => {\n\t\t\t\t$(\".mv-status\", this.ui.bar).textContent = \"\";\n\t\t\t});\n\t\t}\n\n\t\t// Prevent editing properties inside <summary> to open and close the summary (fix bug #82)\n\t\tif ($(\"summary [property]:not([typeof])\")) {\n\t\t\tthis.element.addEventListener(\"click\", evt => {\n\t\t\t\tif (evt.target != document.activeElement) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Build mavo objects\n\t\tMavo.hooks.run(\"init-tree-before\", this);\n\n\t\tthis.root = new Mavo.Group(this.element, this);\n\t\tthis.treeBuilt.resolve();\n\n\t\tMavo.hooks.run(\"init-tree-after\", this);\n\n\t\t// Is there any control that requires an edit button?\n\t\tthis.needsEdit = this.some(obj => obj.modes == \"read edit\" || obj.modes === undefined);\n\n\t\tthis.setUnsavedChanges(false);\n\n\t\tthis.permissions.onchange(({action, value}) => {\n\t\t\tvar permissions = this.element.getAttribute(\"mv-permissions\") || \"\";\n\t\t\tpermissions = permissions.trim().split(/\\s+/).filter(a => a != action);\n\n\t\t\tif (value) {\n\t\t\t\tpermissions.push(action);\n\t\t\t}\n\n\t\t\tthis.element.setAttribute(\"mv-permissions\", permissions.join(\" \"));\n\t\t});\n\n\t\tthis.permissions.can([\"edit\", \"add\", \"delete\"], () => {\n\t\t\tthis.ui.edit = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-edit\",\n\t\t\t\ttextContent: \"Edit\",\n\t\t\t\tonclick: e => this.editing? this.done() : this.edit(),\n\t\t\t\tinside: this.ui.bar\n\t\t\t});\n\n\t\t\tif (this.autoEdit) {\n\t\t\t\tthis.ui.edit.click();\n\t\t\t}\n\t\t}, () => { // cannot\n\t\t\t$.remove(this.ui.edit);\n\n\t\t\tif (this.editing) {\n\t\t\t\tthis.done();\n\t\t\t}\n\t\t});\n\n\t\tif (this.needsEdit) {\n\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\tthis.ui.save = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-save\",\n\t\t\t\t\ttextContent: \"Save\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.save(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.element.classList.add(\"mv-highlight-unsaved\");\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-highlight-unsaved\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\n\t\t\t\tthis.ui.revert = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-revert\",\n\t\t\t\t\ttextContent: \"Revert\",\n\t\t\t\t\tdisabled: true,\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tclick: e => this.revert(),\n\t\t\t\t\t\t\"mouseenter focus\": e => {\n\t\t\t\t\t\t\tthis.element.classList.add(\"mv-highlight-unsaved\");\n\t\t\t\t\t\t},\n\t\t\t\t\t\t\"mouseleave blur\": e => this.element.classList.remove(\"mv-highlight-unsaved\")\n\t\t\t\t\t},\n\t\t\t\t\tinside: this.ui.bar\n\t\t\t\t});\n\t\t\t}, () => {\n\t\t\t\t$.remove([this.ui.save, this.ui.revert]);\n\t\t\t\tthis.ui.save = this.ui.revert = null;\n\t\t\t});\n\t\t}\n\n\t\tthis.permissions.can(\"delete\", () => {\n\t\t\tthis.ui.clear = $.create(\"button\", {\n\t\t\t\tclassName: \"mv-clear\",\n\t\t\t\ttextContent: \"Clear\",\n\t\t\t\tonclick: e => this.clear()\n\t\t\t});\n\n\t\t\tthis.ui.bar.appendChild(this.ui.clear);\n\t\t});\n\n\t\tthis.permissions.cannot([\"delete\", \"edit\"], () => {\n\t\t\t$.remove(this.ui.clear);\n\t\t});\n\n\t\tif (this.storage || this.source) {\n\t\t\t// Fetch existing data\n\t\t\tif (!this.storage) {\n\t\t\t\tthis.source.permissions.can(\"read\", () => this.permissions.read = true);\n\t\t\t}\n\n\t\t\tthis.permissions.can(\"read\", () => this.load());\n\t\t}\n\t\telse {\n\t\t\t// No storage\n\t\t\tthis.permissions.on([\"read\", \"edit\"]);\n\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t}\n\n\t\tif (!this.needsEdit) {\n\t\t\t// If there's no edit mode, we must save immediately when properties change\n\t\t\tthis.element.addEventListener(\"mavo:load\", evt => {\n\t\t\t\tvar debouncedSave = _.debounce(() => {\n\t\t\t\t\tthis.save();\n\t\t\t\t}, 3000);\n\n\t\t\t\tvar callback = evt => {\n\t\t\t\t\tif (evt.node.saved) {\n\t\t\t\t\t\tdebouncedSave();\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\tthis.permissions.can(\"save\", () => {\n\t\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t}, () => {\n\t\t\t\t\t\tthis.element.removeEventListener(\"mavo:datachange\", callback);\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tMavo.hooks.run(\"init-end\", this);\n\t},\n\n\tget editing() {\n\t\treturn this.root.editing;\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tgetData: function(o) {\n\t\treturn this.root.getData(o);\n\t},\n\n\ttoJSON: function(data = this.data) {\n\t\treturn _.toJSON(data);\n\t},\n\n\terror: function(message, ...log) {\n\t\tvar close = () => $.transition(error, {opacity: 0}).then($.remove);\n\t\tvar closeTimeout;\n\t\tvar error = $.create(\"p\", {\n\t\t\tclassName: \"mv-error mv-ui\",\n\t\t\tcontents: [\n\t\t\t\tmessage,\n\t\t\t\t{\n\t\t\t\t\ttag: \"button\",\n\t\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\t\ttextContent: \"×\",\n\t\t\t\t\tevents: {\n\t\t\t\t\t\t\"click\": close\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tmouseenter: e => clearTimeout(closeTimeout),\n\t\t\t\tmouseleave: _.rr(e => closeTimeout = setTimeout(close, 5000))\n\t\t\t},\n\t\t\tstart: this.element\n\t\t});\n\n\t\t// Log more info for programmers\n\t\tif (log.length > 0) {\n\t\t\tconsole.log(\"%c\" + message, \"color: red; font-weight: bold\", ...log);\n\t\t}\n\t},\n\n\trender: function(data) {\n\t\t_.hooks.run(\"render-start\", {context: this, data});\n\n\t\tif (data) {\n\t\t\tthis.root.render(data);\n\t\t}\n\n\t\tthis.unsavedChanges = false;\n\n\t\t_.hooks.run(\"render-end\", {context: this, data});\n\t},\n\n\tclear: function() {\n\t\tif (confirm(\"This will delete all your data. Are you sure?\")) {\n\t\t\tthis.store(null).then(() => this.root.clear());\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.root.edit();\n\n\t\t$.events(this.element, \"mouseenter.mavo:edit mouseleave.mavo:edit\", evt => {\n\t\t\tif (evt.target.matches(\".mv-item-controls *\")) {\n\t\t\t\tvar item = evt.target.closest(_.selectors.item);\n\t\t\t\titem.classList.toggle(\"mv-highlight\", evt.type == \"mouseenter\");\n\t\t\t}\n\n\t\t\tif (evt.target.matches(_.selectors.item)) {\n\t\t\t\tevt.target.classList.remove(\"mv-has-hovered-item\");\n\n\t\t\t\tvar parent = evt.target.parentNode.closest(_.selectors.item);\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tparent.classList.toggle(\"mv-has-hovered-item\", evt.type == \"mouseenter\");\n\t\t\t\t}\n\t\t\t}\n\t\t}, true);\n\n\t\tthis.setUnsavedChanges();\n\t},\n\n\t/**\n\t * Set this mavo instance’s unsavedChanges flag.\n\t * @param {Boolean} [value]\n\t *        If true, just sets the flag to true, no traversal.\n\t *        If false, sets the flag of the Mavo instance and every tree node to false\n\t *        If not provided, traverses the tree and recalculates the flag value.\n\t */\n\tsetUnsavedChanges: function(value) {\n\t\tvar unsavedChanges = !!value;\n\n\t\tif (!value) {\n\t\t\tthis.walk(obj => {\n\t\t\t\tif (obj.unsavedChanges) {\n\t\t\t\t\tunsavedChanges = true;\n\n\t\t\t\t\tif (value === false) {\n\t\t\t\t\t\tobj.unsavedChanges = false;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\treturn this.unsavedChanges = unsavedChanges;\n\t},\n\n\t// Conclude editing\n\tdone: function() {\n\t\tthis.root.done();\n\t\t$.unbind(this.element, \".mavo:edit\");\n\t\tthis.unsavedChanges = false;\n\t},\n\n\t/**\n\t * load - Fetch data from source and render it.\n\t *\n\t * @return {Promise}  A promise that resolves when the data is loaded.\n\t */\n\tload: function() {\n\t\tthis.inProgress = \"Loading\";\n\n\t\tvar backend = this.storage || this.source;\n\n\t\treturn backend.ready.then(() => backend.get())\n\t\t.catch(err => {\n\t\t\t// Try again with source\n\t\t\tif (this.source && backend !== this.source) {\n\t\t\t\treturn this.source.ready.then(() => this.source.get());\n\t\t\t}\n\n\t\t\treturn Promise.reject(err);\n\t\t})\n\t\t.then(response => {\n\t\t\tif (response && $.type(response) == \"string\") {\n\t\t\t\ttry {\n\t\t\t\t\tresponse = JSON.parse(response);\n\t\t\t\t}\n\t\t\t\tcatch (e) {\n\t\t\t\t\tthis.error(\"The data is corrupted.\", e, response);\n\t\t\t\t\tresponse = \"\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.render(response);\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tif (err.xhr && err.xhr.status == 404) {\n\t\t\t\t\tthis.render(\"\");\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tthis.error(\"The data could not be loaded.\", err);\n\t\t\t\t}\n\t\t\t}\n\t\t})\n\t\t.then(() => {\n\t\t\tthis.inProgress = false;\n\t\t\t$.fire(this.element, \"mavo:load\");\n\t\t});\n\t},\n\n\tstore: function() {\n\t\tif (!this.storage) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.inProgress = \"Saving\";\n\n\t\treturn this.storage.login()\n\t\t.then(() => this.storage.put())\n\t\t.then(file => {\n\t\t\tthis.inProgress = false;\n\t\t\treturn file;\n\t\t})\n\t\t.catch(err => {\n\t\t\tif (err) {\n\t\t\t\tvar message = \"Problem saving data\";\n\n\t\t\t\tif (err.status && err.statusText) {\n\t\t\t\t\tmessage += ` (HTTP ${err.status}: ${err.statusText})`;\n\t\t\t\t}\n\n\t\t\t\tthis.error(message, err);\n\t\t\t}\n\n\t\t\tthis.inProgress = false;\n\t\t\treturn Promise.reject(err);\n\t\t});\n\t},\n\n\tsave: function() {\n\t\treturn this.store().then(file => {\n\t\t\tif (file) {\n\t\t\t\t$.fire(this.element, \"mavo:save\", {\n\t\t\t\t\tdata: file.data,\n\t\t\t\t\tdataString: file.dataString\n\t\t\t\t});\n\n\t\t\t\tthis.lastSaved = Date.now();\n\t\t\t\tthis.root.save();\n\t\t\t\tthis.unsavedChanges = false;\n\t\t\t}\n\t\t});\n\t},\n\n\trevert: function() {\n\t\tthis.root.revert();\n\t},\n\n\twalk: function(callback) {\n\t\treturn this.root.walk(callback);\n\t},\n\n\t/**\n\t * Executes a test on every node. If ANY node passes (test returns true),\n\t * the function returns true. Otherwise, it returns false.\n\t * Similar semantics to Array.prototype.some().\n\t */\n\tsome: function(test) {\n\t\treturn !this.walk((obj, path) => {\n\t\t\tvar ret = test(obj, path);\n\n\t\t\tif (ret === true) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t});\n\t},\n\n\tlive: {\n\t\tinProgress: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-progress\", value, value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\tif (this.ui && this.ui.save) {\n\t\t\t\tthis.ui.save.classList.toggle(\"mv-unsaved-changes\", value);\n\t\t\t\tthis.ui.revert.disabled = !value;\n\t\t\t}\n\t\t},\n\n\t\tneedsEdit: function(value) {\n\t\t\t$.toggleAttribute(this.ui.bar, \"hidden\", \"\", !value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: [],\n\n\t\tallIds: [],\n\n\t\tget: function(id) {\n\t\t\tfor (let mavo of _.all) {\n\t\t\t\tif (mavo.id === id) {\n\t\t\t\t\treturn mavo;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn null;\n\t\t},\n\n\t\tsuperKey: navigator.platform.indexOf(\"Mac\") === 0? \"metaKey\" : \"ctrlKey\",\n\n\t\tinit: function(container) {\n\t\t\treturn $$(_.selectors.init, container || document)\n\t\t\t\t.filter(element => element == document.documentElement || !element.parentNode.closest(_.selectors.init))\n\t\t\t\t.map(element => new _(element));\n\t\t},\n\n\t\tplugin: function(o) {\n\t\t\tfor (let hook in o.hooks) {\n\t\t\t\t_.hooks.add(hook, o.hooks[hook]);\n\t\t\t}\n\n\t\t\tfor (let Class in o.extend) {\n\t\t\t\t$.Class(Mavo[Class], o.extend[Class]);\n\t\t\t}\n\t\t},\n\n\t\thooks: new $.Hooks(),\n\n\t\tattributes: [\n\t\t\t\"mv-app\", \"mv-storage\", \"mv-init\", \"mv-attribute\",\n\t\t\t\"mv-default\", \"mv-mode\", \"mv-edit\", \"mv-permisssions\"\n\t\t]\n\t}\n});\n\n{\n\nlet s = _.selectors = {\n\tinit: \".mv-app, [mv-app], [data-mv-app], [mv-storage], [data-mv-storage]\",\n\tproperty: \"[property], [itemprop]\",\n\tspecificProperty: name => `[property=${name}], [itemprop=${name}]`,\n\tgroup: \"[typeof], [itemscope], [itemtype], .mv-group\",\n\tmultiple: \"[mv-multiple], .mv-multiple\",\n\tformControl: \"input, select, option, textarea\",\n\titem: \".mv-item\",\n\tui: \".mv-ui\",\n\tcontainer: {\n\t\t// \"li\": \"ul, ol\",\n\t\t\"tr\": \"table\",\n\t\t\"option\": \"select\",\n\t\t// \"dt\": \"dl\",\n\t\t// \"dd\": \"dl\"\n\t}\n};\n\nlet arr = s.arr = selector => selector.split(/\\s*,\\s*/g);\nlet not = s.not = selector => arr(selector).map(s => `:not(${s})`).join(\"\");\nlet or = s.or = (selector1, selector2) => selector1 + \", \" + selector2;\nlet and = s.and = (selector1, selector2) => {\n\tvar ret = [], arr2 = arr(selector2);\n\n\tarr(selector1).forEach(s1 => ret.push(...arr2.map(s2 => s1 + s2)));\n\n\treturn ret.join(\", \");\n};\nlet andNot = s.andNot = (selector1, selector2) => and(selector1, not(selector2));\n\n$.extend(_.selectors, {\n\tprimitive: andNot(s.property, s.group),\n\trootGroup: andNot(s.group, s.property),\n\toutput: or(s.specificProperty(\"output\"), \".mv-output, .mv-value\")\n});\n\n}\n\n// Init mavo\nPromise.all([\n\t$.ready(),\n\t$.include(Array.from && window.Intl && document.documentElement.closest, \"https://cdn.polyfill.io/v2/polyfill.min.js?features=blissfuljs,Intl.~locale.en\")\n])\n.catch(err => console.error(err))\n.then(() => Mavo.init());\n\nStretchy.selectors.filter = \".mv-editor:not([property])\";\n\n})(Bliss, Bliss.$);\n","(function ($, $$) {\n\nvar _ = $.extend(Mavo, {\n\ttoJSON: data => {\n\t\tif (data === null) {\n\t\t\treturn \"\";\n\t\t}\n\n\t\tif (typeof data === \"string\") {\n\t\t\t// Do not stringify twice!\n\t\t\treturn data;\n\t\t}\n\n\t\treturn JSON.stringify(data, null, \"\\t\");\n\t},\n\n\t// Convert an identifier to readable text that can be used as a label\n\treadable: function (identifier) {\n\t\t// Is it camelCase?\n\t\treturn identifier && identifier\n\t\t\t\t .replace(/([a-z])([A-Z])(?=[a-z])/g, ($0, $1, $2) => $1 + \" \" + $2.toLowerCase()) // camelCase?\n\t\t\t\t .replace(/([a-z])[_\\/-](?=[a-z])/g, \"$1 \") // Hyphen-separated / Underscore_separated?\n\t\t\t\t .replace(/^[a-z]/, $0 => $0.toUpperCase()); // Capitalize\n\t},\n\n\tqueryJSON: function(data, path) {\n\t\tif (!path || !data) {\n\t\t\treturn data;\n\t\t}\n\n\t\treturn $.value.apply($, [data].concat(path.split(\"/\")));\n\t},\n\n\t// If the passed value is not an array, convert to an array\n\ttoArray: arr => {\n\t\treturn arr === undefined? [] : Array.isArray(arr)? arr : [arr];\n\t},\n\n\tdelete: (arr, element) => {\n\t\tvar index = arr && arr.indexOf(element);\n\n\t\tif (index > -1) {\n\t\t\tarr.splice(index, 1);\n\t\t}\n\t},\n\n\thasIntersection: (arr1, arr2) => !arr1.every(el => arr2.indexOf(el) == -1),\n\n\t// Recursively flatten a multi-dimensional array\n\tflatten: arr => {\n\t\tif (!Array.isArray(arr)) {\n\t\t\treturn [arr];\n\t\t}\n\n\t\treturn arr.reduce((prev, c) => _.toArray(prev).concat(_.flatten(c)), []);\n\t},\n\n\tis: function(thing, ...elements) {\n\t\tfor (let element of elements) {\n\t\t\tif (element && element.matches && element.matches(_.selectors[thing])) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tdata: (element, name, value) => {\n\t\tif (value === undefined) {\n\t\t\treturn $.value(element, \"_\", \"data\", \"mavo\", name);\n\t\t}\n\t\telse {\n\t\t\telement._.data.mavo = element._.mavo || {};\n\t\t\telement._.data.mavo[name] = value;\n\t\t}\n\t},\n\n\tinViewport: element => {\n\t\tvar r = element.getBoundingClientRect();\n\n\t\treturn (0 <= r.bottom && r.bottom <= innerHeight || 0 <= r.top && r.top <= innerHeight) // vertical\n\t\t       && (0 <= r.right && r.right <= innerWidth || 0 <= r.left && r.left <= innerWidth); // horizontal\n\t},\n\n\tpushUnique: (arr, item) => {\n\t\tif (arr.indexOf(item) === -1) {\n\t\t\tarr.push(item);\n\t\t}\n\t},\n\n\t/**\n\t * Get the value of an attribute, with fallback attributes in priority order.\n\t */\n\tgetAttribute: function(element, ...attributes) {\n\t\tfor (let i=0, attribute; attribute = attributes[i]; i++) {\n\t\t\tlet value = element.getAttribute(attribute);\n\n\t\t\tif (value) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\n\t// Credit: https://remysharp.com/2010/07/21/throttling-function-calls\n\tdebounce: function (fn, delay) {\n\t\tvar timer = null, code;\n\n\t\treturn function () {\n\t\t\tvar context = this, args = arguments;\n\t\t\tcode = function () {\n\t\t\t\tfn.apply(context, args);\n\t\t\t\tremoveEventListener(\"beforeunload\", code);\n\t\t\t};\n\n\t\t\tclearTimeout(timer);\n\t\t\ttimer = setTimeout(code, delay);\n\t\t\taddEventListener(\"beforeunload\", code);\n\t\t};\n\t},\n\n\tescapeRegExp: s => s.replace(/[-\\/\\\\^$*+?.()|[\\]{}]/g, \"\\\\$&\"),\n\n\tObserver: $.Class({\n\t\tconstructor: function(element, attribute, callback, oldValue) {\n\t\t\tif (callback instanceof MutationObserver) {\n\t\t\t\tthis.observer = callback;\n\t\t\t}\n\n\t\t\tthis.observer = this.observer || new MutationObserver(callback);\n\t\t\tthis.element = element;\n\t\t\tthis.callback = callback;\n\t\t\tthis.attribute = attribute;\n\t\t\tthis.oldValue = oldValue;\n\n\t\t\tthis.options = {};\n\n\t\t\tif (attribute) {\n\t\t\t\t$.extend(this.options, {\n\t\t\t\t\tattributes: true,\n\t\t\t\t\tattributeFilter: this.attribute == \"all\"? undefined : [this.attribute],\n\t\t\t\t\tattributeOldValue: !!this.oldValue\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tif (!this.attribute || this.attribute == \"all\") {\n\t\t\t\t$.extend(this.options, {\n\t\t\t\t\tcharacterData: true,\n\t\t\t\t\tchildList: true,\n\t\t\t\t\tsubtree: true,\n\t\t\t\t\tcharacterDataOldValue: !!this.oldValue\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tthis.run();\n\t\t},\n\n\t\tstop: function() {\n\t\t\tif (this.running) {\n\t\t\t\tthis.observer.disconnect();\n\t\t\t\tthis.running = false;\n\t\t\t}\n\n\t\t\treturn this;\n\t\t},\n\n\t\trun: function() {\n\t\t\tif (!this.running) {\n\t\t\t\tthis.observer.observe(this.element, this.options);\n\t\t\t\tthis.running = true;\n\t\t\t}\n\n\t\t\treturn this;\n\t\t},\n\n\t\t/**\n\t\t * Disconnect an observer, run some code, then observe again\n\t\t */\n\t\tsneak: function(callback) {\n\t\t\tif (this.running) {\n\t\t\t\tthis.stop();\n\t\t\t\tvar ret = callback();\n\t\t\t\trequestAnimationFrame(() => this.run());\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar ret = callback();\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t}\n\t}),\n\n\tdefer: function(constructor) {\n\t\tvar res, rej;\n\n\t\tvar promise = new Promise((resolve, reject) => {\n\t\t\tif (constructor) {\n\t\t\t\tconstructor(resolve, reject);\n\t\t\t}\n\n\t\t\tres = resolve;\n\t\t\trej = reject;\n\t\t});\n\n\t\tpromise.resolve = a => {\n\t\t\tres(a);\n\t\t\treturn promise;\n\t\t};\n\n\t\tpromise.reject = a => {\n\t\t\trej(a);\n\t\t\treturn promise;\n\t\t};\n\n\t\treturn promise;\n\t},\n\n\t/**\n\t * Run & Return a function\n\t */\n\trr: function(f) {\n\t\tf();\n\t\treturn f;\n\t}\n});\n\n// Bliss plugins\n\n$.add(\"toggleAttribute\", function(name, value, test = value !== null) {\n\tif (test) {\n\t\tthis.setAttribute(name, value);\n\t}\n\telse {\n\t\tthis.removeAttribute(name);\n\t}\n});\n\n// Provide shortcuts to long property chains\n$.proxy = $.classProps.proxy = $.overload(function(obj, property, proxy) {\n\tObject.defineProperty(obj, property, {\n\t\tget: function() {\n\t\t\treturn this[proxy][property];\n\t\t},\n\t\tset: function(value) {\n\t\t\tthis[proxy][property] = value;\n\t\t},\n\t\tconfigurable: true,\n\t\tenumerable: true\n\t});\n\n\treturn obj;\n});\n\n$.classProps.propagated = function(proto, names) {\n\tMavo.toArray(names).forEach(name => {\n\t\tvar existing = proto[name];\n\n\t\tproto[name] = function() {\n\t\t\tvar ret = existing && existing.apply(this, arguments);\n\n\t\t\tif (this.propagate && ret !== false) {\n\t\t\t\tthis.propagate(name);\n\t\t\t}\n\t\t};\n\t});\n};\n\n// :focus-within and :target-within shim\nfunction updateWithin(cl, element) {\n\tcl = \"mv-\" + cl + \"-within\";\n\t$$(\".\" + cl).forEach(el => el.classList.remove(cl));\n\n\twhile (element && element.classList) {\n\t\telement.classList.add(cl);\n\t\telement = element.parentNode;\n\t}\n};\n\ndocument.addEventListener(\"focus\", evt => {\n\tupdateWithin(\"focus\", evt.target);\n}, true);\n\ndocument.addEventListener(\"blur\", evt => {\n\tupdateWithin(\"focus\", null);\n}, true);\n\naddEventListener(\"hashchange\", evt => {\n\tupdateWithin(\"target\", $(location.hash));\n});\n\ndocument.documentElement.addEventListener(\"mavo:datachange\", evt => {\n\t// TODO debounce\n\tupdateWithin(\"target\", $(location.hash));\n});\n\nupdateWithin(\"focus\", document.activeElement !== document.body? document.activeElement : null);\n\n})(Bliss, Bliss.$);\n","(function($) {\n\nvar _ = Mavo.Permissions = $.Class({\n\tconstructor: function(o) {\n\t\tthis.triggers = [];\n\n\t\tthis.set(o);\n\n\t\tthis.hooks = new $.Hooks();\n\t},\n\n\t// Set multiple permissions at once\n\tset: function(o) {\n\t\tfor (var action in o) {\n\t\t\tthis[action] = o[action];\n\t\t}\n\t},\n\n\t// Set a bunch of permissions to true. Chainable.\n\ton: function(actions) {\n\t\tMavo.toArray(actions).forEach(action => this[action] = true);\n\n\t\treturn this;\n\t},\n\n\t// Set a bunch of permissions to false. Chainable.\n\toff: function(actions) {\n\t\tactions = Array.isArray(actions)? actions : [actions];\n\n\t\tactions.forEach(action => this[action] = false);\n\n\t\treturn this;\n\t},\n\n\t// Fired once at least one of the actions passed can be performed\n\t// Kind of like a Promise that can be resolved multiple times.\n\tcan: function(actions, callback, cannot) {\n\t\tthis.observe(actions, true, callback);\n\n\t\tif (cannot) {\n\t\t\t// Fired once the action cannot be done anymore, even though it could be done before\n\t\t\tthis.cannot(actions, cannot);\n\t\t}\n\t},\n\n\t// Fired once NONE of the actions can be performed\n\tcannot: function(actions, callback) {\n\t\tthis.observe(actions, false, callback);\n\t},\n\n\t// Like this.can(), but returns a promise\n\t// Useful for things that you want to do only once\n\twhen: function(actions) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.can(actions, resolve, reject);\n\t\t});\n\t},\n\n\t// Schedule a callback for when a set of permissions changes value\n\tobserve: function(actions, value, callback) {\n\t\tactions = Mavo.toArray(actions);\n\n\t\tif (this.is(actions, value)) {\n\t\t\t// Should be fired immediately\n\t\t\tcallback();\n\t\t}\n\n\t\t// For future transitions\n\t\tthis.triggers.push({ actions, value, callback, active: true });\n\t},\n\n\t// Compare a set of permissions with true or false\n\t// If comparing with true, we want at least one to be true, i.e. OR\n\t// If comparing with false, we want ALL to be false, i.e. NOR\n\tis: function(actions, able) {\n\t\tvar or = actions.map(action => !!this[action])\n\t\t                .reduce((prev, current) => prev || current);\n\n\t\treturn able? or : !or;\n\t},\n\n\t// Monitor all changes\n\tonchange: function(callback) {\n\t\tthis.hooks.add(\"change\", callback);\n\n\t\tfor (let action of _.actions) {\n\t\t\tcallback.call(this, {\n\t\t\t\taction,\n\t\t\t\tvalue: this[action],\n\t\t\t\tpermissions: this\n\t\t\t});\n\t\t}\n\t},\n\n\t// A single permission changed value\n\tchanged: function(action, value, from) {\n\t\tfrom = !!from;\n\t\tvalue = !!value;\n\n\t\tif (value == from) {\n\t\t\t// Nothing changed\n\t\t\treturn;\n\t\t}\n\n\t\t// $.live() calls the setter before the actual property is set so we\n\t\t// need to set it manually, otherwise it still has its previous value\n\t\tthis[\"_\" + action] = value;\n\n\t\t// TODO add classes to element\n\t\tthis.triggers.forEach(trigger => {\n\t\t\tvar match = this.is(trigger.actions, trigger.value);\n\n\t\t\tif (trigger.active && trigger.actions.indexOf(action) > -1 && match) {\n\n\t\t\t\ttrigger.active = false;\n\t\t\t\ttrigger.callback();\n\t\t\t}\n\t\t\telse if (!match) {\n\t\t\t\t// This is so that triggers can only be executed in an actual transition\n\t\t\t\t// And that if there is a trigger for [a,b] it won't be executed twice\n\t\t\t\t// if a and b are set to true one after the other\n\t\t\t\ttrigger.active = true;\n\t\t\t}\n\t\t});\n\n\t\tthis.hooks.run(\"change\", {action, value, permissions: this});\n\t},\n\n\tor: function(permissions) {\n\t\tfor (let action of _.actions) {\n\t\t\tthis[action] = this[action] || permissions[action];\n\t\t}\n\n\t\treturn this;\n\t},\n\n\tstatic: {\n\t\tactions: [],\n\n\t\t// Register a new permission type\n\t\tregister: function(action, setter) {\n\t\t\tif (Array.isArray(action)) {\n\t\t\t\taction.forEach(action => _.register(action, setter));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$.live(_.prototype, action, function(able, previous) {\n\t\t\t\tif (setter) {\n\t\t\t\t\tsetter.call(this, able, previous);\n\t\t\t\t}\n\n\t\t\t\tthis.changed(action, able, previous);\n\t\t\t});\n\n\t\t\t_.actions.push(action);\n\t\t}\n\t}\n});\n\n_.register([\"read\", \"save\"]);\n\n_.register(\"login\", function(can) {\n\tif (can && this.logout) {\n\t\tthis.logout = false;\n\t}\n});\n\n_.register(\"logout\", function(can) {\n\tif (can && this.login) {\n\t\tthis.login = false;\n\t}\n});\n\n_.register(\"edit\", function(can) {\n\tif (can) {\n\t\tthis.add = this.delete = true;\n\t}\n});\n\n_.register([\"add\", \"delete\"], function(can) {\n\tif (!can) {\n\t\tthis.edit = false;\n\t}\n});\n\n})(Bliss);\n","(function($) {\n\n/**\n * Base class for all backends\n */\nvar _ = Mavo.Backend = $.Class({\n\tconstructor: function(url, mavo) {\n\t\tthis.url = url;\n\t\tthis.mavo = mavo;\n\n\t\t// Permissions of this particular backend.\n\t\tthis.permissions = new Mavo.Permissions();\n\t},\n\n\tget: function() {\n\t\treturn $.fetch(this.url.href, {\n\t\t\tresponseType: \"json\"\n\t\t})\n\t\t.then(xhr => Promise.resolve(xhr.response), () => Promise.resolve(null));\n\t},\n\n\t// To be be overriden by subclasses\n\tready: Promise.resolve(),\n\tlogin: () => Promise.resolve(),\n\tlogout: () => Promise.resolve(),\n\n\tgetFile: function() {\n\t\tvar data = this.mavo.getData({unhandled: true});\n\n\t\treturn {\n\t\t\tdata,\n\t\t\tdataString: Mavo.toJSON(data),\n\t\t\tpath: this.path || \"\"\n\t\t};\n\t},\n\n\ttoString: function() {\n\t\treturn `${this.id} (${this.url})`;\n\t},\n\n\tstatic: {\n\t\t// Return the appropriate backend(s) for this url\n\t\tcreate: function(url, mavo) {\n\t\t\tif (!url.indexOf) {\n\t\t\t\tconsole.log(url);\n\t\t\t}\n\t\t\tif (url) {\n\t\t\t\tvar Backend = _.types.filter(Backend => Backend.test(url))[0] || _.Remote;\n\n\t\t\t\treturn new Backend(url, mavo);\n\t\t\t}\n\n\t\t\treturn null;\n\t\t},\n\n\t\ttypes: [],\n\n\t\tregister: function(Class) {\n\t\t\t_[Class.prototype.id] = Class;\n\t\t\t_.types.push(Class);\n\t\t\treturn Class;\n\t\t}\n\t}\n});\n\n/**\n * Save in an HTML element\n */\n_.register($.Class({\n\tid: \"Element\",\n\textends: _,\n\tconstructor: function () {\n\t\tthis.permissions.on([\"read\", \"edit\", \"save\"]);\n\n\t\tthis.element = $(this.url) || $.create(\"script\", {\n\t\t\ttype: \"application/json\",\n\t\t\tid: this.url.slice(1),\n\t\t\tinside: document.body\n\t\t});\n\t},\n\n\tget: function() {\n\t\treturn Promise.resolve(this.element.textContent);\n\t},\n\n\tput: function(file = this.getFile()) {\n\t\tthis.element.textContent = file.dataString;\n\t\treturn Promise.resolve(file);\n\t},\n\n\tstatic: {\n\t\ttest: url => url.indexOf(\"#\") === 0\n\t}\n}));\n\n// Load from a remote URL, no save\n_.register($.Class({\n\tid: \"Remote\",\n\textends: _,\n\tconstructor: function() {\n\t\tthis.permissions.on(\"read\");\n\t\tthis.url = new URL(this.url, location);\n\t},\n\n\tstatic: {\n\t\ttest: url => false\n\t}\n}));\n\n// Save in localStorage\n_.register($.Class({\n\textends: _,\n\tid: \"Local\",\n\tconstructor: function() {\n\t\tthis.permissions.on([\"read\", \"edit\", \"save\"]);\n\t\tthis.key = this.mavo.id;\n\t},\n\n\tget: function() {\n\t\treturn Promise[this.key in localStorage? \"resolve\" : \"reject\"](localStorage[this.key]);\n\t},\n\n\tput: function(file = this.getFile()) {\n\t\tif (file.data === null) {\n\t\t\tdelete localStorage[this.key];\n\t\t}\n\t\telse {\n\t\t\tlocalStorage[this.key] = file.dataString;\n\t\t}\n\n\t\treturn Promise.resolve(file);\n\t},\n\n\tstatic: {\n\t\ttest: value => value == \"local\"\n\t}\n}));\n\n})(Bliss);\n","(function($, $$) {\n\nvar _ = Mavo.Node = $.Class({\n\tabstract: true,\n\tconstructor: function (element, mavo, options = {}) {\n\t\tif (!element || !mavo) {\n\t\t\tthrow new Error(\"Mavo.Node constructor requires an element argument and a mavo object\");\n\t\t}\n\n\t\tvar env = {context: this, options};\n\n\t\tthis.uid = ++_.maxId;\n\n\t\t_.all.set(element, [...(_.all.get(this.element) || []), this]);\n\n\t\tthis.element = element;\n\t\tthis.template = env.options.template;\n\n\t\tif (this.template) {\n\t\t\t// TODO remove if this is deleted\n\t\t\tthis.template.copies.push(this);\n\t\t}\n\t\telse {\n\t\t\tthis.copies = [];\n\t\t}\n\n\t\tthis.mavo = mavo;\n\n\t\tif (!this.fromTemplate(\"property\", \"type\", \"modes\")) {\n\t\t\tthis.property = _.getProperty(element);\n\t\t\tthis.type = Mavo.Group.normalize(element);\n\t\t\tthis.store = this.element.getAttribute(\"mv-storage\");\n\t\t\tthis.modes = this.element.getAttribute(\"mv-mode\");\n\t\t}\n\n\t\tthis.modeObserver = new Mavo.Observer(this.element, \"mv-mode\", records => {\n\t\t\tconsole.log(\"%cmutation observer on\", \"color:purple;\", this.property, this.uid, this.template);\n\t\t\tthis.mode = this.element.getAttribute(\"mv-mode\");\n\t\t\tthis[this.mode == \"edit\"? \"edit\" : \"done\"]();\n\t\t});\n\n\t\tthis.mode = this.modes || \"read\";\n\n\t\tthis.group = this.parentGroup = env.options.group;\n\n\t\tMavo.hooks.run(\"node-init-end\", env);\n\t},\n\n\tget editing() {\n\t\treturn this.mode == \"edit\";\n\t},\n\n\tget constant() {\n\t\t// Is a \"constant\" if only allowed mode is read\n\t\treturn this.modes == \"read\";\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tget name() {\n\t\treturn Mavo.readable(this.property || this.type).toLowerCase();\n\t},\n\n\tget data() {\n\t\treturn this.getData();\n\t},\n\n\tget saved() {\n\t\treturn this.store !== \"none\";\n\t},\n\n\tget path() {\n\t\tvar path = this.parentGroup? this.parentGroup.path : [];\n\n\t\treturn this.property? [...path, this.property] : path;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tif (this.isDataNull(o)) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// Check if any of the parent groups doesn't return data\n\t\tthis.walkUp(group => {\n\t\t\tif (group.isDataNull(o)) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t});\n\t},\n\n\tisDataNull: function(o) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tresult: this.deleted || !this.saved && (o.store != \"*\")\n\t\t};\n\n\t\tMavo.hooks.run(\"unit-isdatanull\", env);\n\n\t\treturn env.result;\n\t},\n\n\t/**\n\t * Execute a callback on every node of the Mavo tree\n\t * If callback returns (strict) false, walk stops.\n\t * @return false if was stopped via a false return value, true otherwise\n\t */\n\twalk: function(callback, path = []) {\n\t\tvar walker = (obj, path) => {\n\t\t\tvar ret = callback(obj, path);\n\n\t\t\tif (ret !== false) {\n\t\t\t\tfor (let i in obj.children) {\n\t\t\t\t\tlet node = obj.children[i];\n\n\t\t\t\t\tif (node instanceof Mavo.Node) {\n\t\t\t\t\t\tvar ret = walker.call(node, node, [...path, i]);\n\n\t\t\t\t\t\tif (ret === false) {\n\t\t\t\t\t\t\treturn false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret !== false;\n\t\t};\n\n\t\treturn walker(this, path);\n\t},\n\n\twalkUp: function(callback) {\n\t\tvar group = this;\n\n\t\twhile (group = group.parentGroup) {\n\t\t\tvar ret = callback(group);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\t},\n\n\tedit: function() {\n\t\tthis.mode = \"edit\";\n\n\t\tthis.propagate(\"edit\");\n\n\t\tMavo.hooks.run(\"node-edit-end\", this);\n\t},\n\n\tdone: function() {\n\t\tthis.mode = \"read\";\n\t\t$.unbind(this.element, \".mavo:edit\");\n\n\t\tthis.propagate(\"done\");\n\n\t\tMavo.hooks.run(\"node-done-end\", this);\n\t},\n\n\tpropagate: function(callback) {\n\t\tfor (let i in this.children) {\n\t\t\tlet node = this.children[i];\n\n\t\t\tif (node instanceof Mavo.Node) {\n\t\t\t\tif (typeof callback === \"function\") {\n\t\t\t\t\tcallback.call(node, node);\n\t\t\t\t}\n\t\t\t\telse if (callback in node) {\n\t\t\t\t\tnode[callback]();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\", \"revert\"],\n\n\ttoJSON: Mavo.prototype.toJSON,\n\n\tfromTemplate: function(...properties) {\n\t\tif (this.template) {\n\t\t\tfor (let property of properties) {\n\t\t\t\tthis[property] = this.template[property];\n\t\t\t}\n\t\t}\n\n\t\treturn !!this.template;\n\t},\n\n\trender: function(data) {\n\t\tMavo.hooks.run(\"node-render-start\", this);\n\n\t\tthis.rendering = true;\n\n\t\tif (this.editing) {\n\t\t\tthis.done();\n\t\t\tthis.dataRender(data);\n\t\t\tthis.edit();\n\t\t}\n\t\telse {\n\t\t\tthis.dataRender(data);\n\t\t}\n\n\t\tthis.save();\n\n\t\tthis.rendering = false;\n\n\t\tMavo.hooks.run(\"node-render-end\", this);\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\tif (!this.rendering) {\n\t\t\t$.fire(o.element || this.element, \"mavo:datachange\", $.extend({\n\t\t\t\tproperty: this.property,\n\t\t\t\taction,\n\t\t\t\tmavo: this.mavo,\n\t\t\t\tnode: this\n\t\t\t}, o));\n\t\t}\n\t},\n\n\ttoString: function() {\n\t\treturn `#${this.uid}: ${this.nodeType} (${this.property})`;\n\t},\n\n\tlive: {\n\t\tstore: function(value) {\n\t\t\t$.toggleAttribute(this.element, \"mv-storage\", value);\n\t\t},\n\n\t\tunsavedChanges: function(value) {\n\t\t\tif (value && (!this.saved || !this.editing)) {\n\t\t\t\tvalue = false;\n\t\t\t}\n\n\t\t\tthis.element.classList.toggle(\"mv-unsaved-changes\", value);\n\n\t\t\treturn value;\n\t\t},\n\n\t\tmode: function (value) {\n\t\t\tif (this._mode != value) {\n\t\t\t\t// If we don't do this, calling setAttribute below will\n\t\t\t\t// result in infinite recursion\n\t\t\t\tthis._mode = value;\n\n\t\t\t\tthis.modeObserver.sneak(() => {\n\t\t\t\t\tvar set = this.modes || this.mode == \"edit\";\n\t\t\t\t\t$.toggleAttribute(this.element, \"mv-mode\", value, set);\n\t\t\t\t});\n\t\t\t}\n\t\t},\n\t},\n\n\tstatic: {\n\t\tmaxId: 0,\n\n\t\tall: new WeakMap(),\n\n\t\tcreate: function(element, mavo, o = {}) {\n\t\t\tif (Mavo.is(\"multiple\", element) && !o.collection) {\n\t\t\t\treturn new Mavo.Collection(element, mavo, o);\n\t\t\t}\n\n\t\t\treturn new Mavo[Mavo.is(\"group\", element)? \"Group\" : \"Primitive\"](element, mavo, o);\n\t\t},\n\n\t\t/**\n\t\t * Get & normalize property name, if exists\n\t\t */\n\t\tgetProperty: function(element) {\n\t\t\tvar property = element.getAttribute(\"property\") || element.getAttribute(\"itemprop\");\n\n\t\t\tif (!property && element.hasAttribute(\"property\")) {\n\t\t\t\tproperty = element.name || element.id || element.classList[0];\n\t\t\t}\n\n\t\t\tif (property) {\n\t\t\t\telement.setAttribute(\"property\", property);\n\t\t\t}\n\n\t\t\treturn property;\n\t\t},\n\n\t\tget: function(element, prioritizePrimitive) {\n\t\t\tvar nodes = (_.all.get(element) || []).filter(node => !(node instanceof Mavo.Collection));\n\n\t\t\tif (nodes.length < 2 || !prioritizePrimitive) {\n\t\t\t\treturn nodes[0];\n\t\t\t}\n\n\t\t\tif (nodes[0] instanceof Mavo.Group) {\n\t\t\t\treturn node[1];\n\t\t\t}\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Group = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Group\",\n\tconstructor: function (element, mavo, o) {\n\t\tthis.children = {};\n\n\t\tthis.group = this;\n\n\t\tMavo.hooks.run(\"group-init-start\", this);\n\n\t\t// Should this element also create a primitive?\n\t\tif (Mavo.Primitive.getValueAttribute(this.element)) {\n\t\t\tvar obj = this.children[this.property] = new Mavo.Primitive(this.element, this.mavo, {group: this});\n\t\t}\n\n\t\t// Create Mavo objects for all properties in this group (primitives orgroups),\n\t\t// but not properties in descendantgroups (they will be handled by their group)\n\t\t$$(Mavo.selectors.property, this.element).forEach(element => {\n\t\t\tvar property = Mavo.Node.getProperty(element);\n\n\t\t\tif (this.contains(element)) {\n\t\t\t\tvar existing = this.children[property];\n\t\t\t\tvar template = this.template? this.template.children[property] : null;\n\t\t\t\tvar constructorOptions = {template, group: this};\n\n\t\t\t\tif (existing) {\n\t\t\t\t\t// Twogroups with the same property, convert to static collection\n\t\t\t\t\tvar collection = existing;\n\n\t\t\t\t\tif (!(existing instanceof Mavo.Collection)) {\n\t\t\t\t\t\tcollection = new Mavo.Collection(existing.element, this.mavo, constructorOptions);\n\t\t\t\t\t\tthis.children[property] = existing.collection = collection;\n\t\t\t\t\t\tcollection.add(existing);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!collection.mutable && Mavo.is(\"multiple\", element)) {\n\t\t\t\t\t\tcollection.mutable = true;\n\t\t\t\t\t}\n\n\t\t\t\t\tcollection.add(element);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// No existing properties with this id, normal case\n\t\t\t\t\tvar obj = Mavo.Node.create(element, this.mavo, constructorOptions);\n\n\t\t\t\t\tthis.children[property] = obj;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tvar vocabElement = (this.isRoot? this.element.closest(\"[vocab]\") : null) || this.element;\n\t\tthis.vocab = vocabElement.getAttribute(\"vocab\");\n\n\t\tMavo.hooks.run(\"group-init-end\", this);\n\t},\n\n\tget isRoot() {\n\t\treturn !this.property;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = {};\n\n\t\tthis.propagate(obj => {\n\t\t\tif ((obj.saved || o.store == \"*\") && !(obj.property in env.data)) {\n\t\t\t\tvar data = obj.getData(o);\n\n\t\t\t\tif (data !== null || env.options.null) {\n\t\t\t\t\tenv.data[obj.property] = data;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (env.options.unhandled) {\n\t\t\t$.extend(env.data, this.unhandled);\n\t\t}\n\n\t\t// JSON-LD stuff\n\t\tif (this.type && this.type != _.DEFAULT_TYPE) {\n\t\t\tenv.data[\"@type\"] = this.type;\n\t\t}\n\n\t\tif (this.vocab) {\n\t\t\tenv.data[\"@context\"] = this.vocab;\n\t\t}\n\n\t\t// Special summary property works like toString\n\t\tif (env.data.summary) {\n\t\t\tenv.data.toString = function() {\n\t\t\t\treturn this.summary;\n\t\t\t};\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t/**\n\t * Search entire subtree for property, return relative value\n\t * @return {Mavo.Node}\n\t */\n\tfind: function(property, o = {}) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\n\t\tif (property in this.children) {\n\t\t\treturn this.children[property].find(property, o);\n\t\t}\n\n\t\tvar all = [];\n\n\t\tfor (var prop in this.children) {\n\t\t\tvar ret = this.children[prop].find(property, o);\n\n\t\t\tif (ret !== undefined) {\n\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\tall.push(...ret);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (all.length) {\n\t\t\treturn all;\n\t\t}\n\t},\n\n\tsave: function() {\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tpropagated: [\"save\", \"import\", \"clear\"],\n\n\t// Do not call directly, call this.render() instead\n\tdataRender: function(data) {\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\t// TODO retain dropped elements\n\t\tdata = Array.isArray(data)? data[0] : data;\n\n\t\t// TODO what if it was a primitive and now it's a group?\n\t\t// In that case, render the this.children[this.property] with it\n\n\t\tthis.unhandled = $.extend({}, data, property => {\n\t\t\treturn !(property in this.children);\n\t\t});\n\n\t\tthis.propagate(obj => {\n\t\t\tobj.render(data[obj.property]);\n\t\t});\n\t},\n\n\t// Check if this group contains a property\n\tcontains: function(property) {\n\t\tif (property instanceof Mavo.Node) {\n\t\t\treturn property.parentGroup === this;\n\t\t}\n\n\t\treturn property.parentNode && (this.element === property.parentNode.closest(Mavo.selectors.group));\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tDEFAULT_TYPE: \"Item\",\n\n\t\tnormalize: function(element) {\n\t\t\t// Get & normalize typeof name, if exists\n\t\t\tif (Mavo.is(\"group\", element)) {\n\t\t\t\tvar type = Mavo.getAttribute(element, \"typeof\", \"itemtype\") || _.DEFAULT_TYPE;\n\n\t\t\t\telement.setAttribute(\"typeof\", type);\n\n\t\t\t\treturn type;\n\t\t\t}\n\n\t\t\treturn null;\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Primitive\",\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"defaults\", \"attribute\", \"templateValue\")) {\n\t\t\tthis.defaults = _.getDefaults(element);\n\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = _.getValueAttribute(this.element, this.defaults);\n\t\t}\n\n\t\tthis.datatype = this.defaults.datatype;\n\t\tthis.modes = this.modes || this.defaults.modes;\n\t\tthis.mode = this.modes || \"read\";\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\tif (this.defaults.init) {\n\t\t\tthis.defaults.init.call(this, this.element);\n\t\t}\n\n\t\tif (this.defaults.changeEvents) {\n\t\t\t$.events(this.element, this.defaults.changeEvents, evt => {\n\t\t\t\tif (evt.target === this.element) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"mv-edit\")) {\n\t\t\tvar original = $(this.element.getAttribute(\"mv-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tnew Mavo.Observer(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis._default = this.element.getAttribute(\"mv-default\");\n\n\t\tif (this.default === null) { // no mv-default\n\t\t\tthis._default = this.constant? this.templateValue : (this.editor? this.editorValue : undefined);\n\t\t}\n\t\telse if (this.default === \"\") { // mv-default exists, no value, default is template value\n\t\t\tthis._default = this.templateValue;\n\t\t}\n\t\telse { // mv-default with value\n\t\t\tnew Mavo.Observer(this.element, \"mv-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"mv-default\");\n\t\t\t});\n\t\t}\n\n\t\t// if (!this.constant) {\n\t\t// \tthis.setValue(this.templateValue, {silent: true});\n\t\t// }\n\n\n\t\tthis.initialValue = (!this.template && this.default === undefined? this.templateValue : this.default) || this.emptyValue;\n\n\t\tthis.setValue(this.initialValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observer = new Mavo.Observer(this.element, this.attribute, records => {\n\t\t\tif (this.attribute || !this.editing) {\n\t\t\t\tthis.value = this.getValue();\n\t\t\t}\n\t\t});\n\n\t\tMavo.hooks.run(\"primitive-init-end\", this);\n\t},\n\n\tget editorValue() {\n\t\tif (this.defaults.getEditorValue) {\n\t\t\treturn this.defaults.getEditorValue.call(this);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, {datatype: this.datatype});\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.defaults.setEditorValue) {\n\t\t\treturn this.defaults.setEditorValue.call(this, value);\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value, {defaults: this.editorDefaults});\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: this.super.getData.call(this, o)\n\t\t};\n\n\t\tif (env.data !== undefined) {\n\t\t\treturn env.data;\n\t\t}\n\n\t\tenv.data = this.value;\n\n\t\tif (env.data === \"\") {\n\t\t\tenv.data = null;\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\tsave: function() {\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function () {\n\t\tthis.super.done.call(this);\n\n\t\tif (\"preEdit\" in this) {\n\t\t\t$.unbind(this.element, \".mavo:preedit .mavo:edit\");\n\t\t}\n\n\t\tthis.sneak(() => {\n\t\t\tif (this.defaults.done) {\n\t\t\t\tthis.defaults.done.call(this);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.close();\n\t\t\t}\n\t\t\telse if (!this.attribute && this.editor) {\n\t\t\t\t$.remove(this.editor);\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t}\n\t\t});\n\n\t\t// Revert tabIndex\n\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t}\n\t\telse {\n\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t}\n\t},\n\n\trevert: function() {\n\t\tif (this.unsavedChanges && this.savedValue !== undefined) {\n\t\t\t// FIXME if we have a collection of properties (not groups), this will cause\n\t\t\t// cancel to not remove new unsaved items\n\t\t\t// This should be fixed by handling this on the collection level.\n\t\t\tthis.value = this.savedValue;\n\t\t\tthis.unsavedChanges = false;\n\t\t}\n\t},\n\n\tsneak: function(callback) {\n\t\tthis.observer? this.observer.sneak(callback) : callback();\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = this.defaults.editor || Mavo.Elements[\"*\"].editor;\n\n\t\t\tthis.editor = $.create($.type(editor) === \"function\"? editor.call(this) : editor);\n\t\t\tthis.editorValue = this.value;\n\t\t}\n\n\t\t$.events(this.editor, {\n\t\t\t\"input change\": evt => {\n\t\t\t\tthis.value = this.editorValue;\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\t// Copy any data-input-* attributes from the element to the editor\n\t\tvar dataInput = /^mv-edit-/i;\n\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t}\n\t\t}, this);\n\n\t\tif (this.attribute) {\n\t\t\tthis.popup = new _.Popup(this);\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.constant) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.super.edit.call(this);\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\tthis.element.tabIndex = 0;\n\n\t\t// Prevent default actions while editing\n\t\t// e.g. following links etc\n\t\tthis.element.addEventListener(\"click.mavo:edit\", evt => evt.preventDefault());\n\n\t\tthis.preEdit = Mavo.defer((resolve, reject) => {\n\t\t\t// Empty properties should become editable immediately\n\t\t\t// otherwise they could be invisible!\n\t\t\tif (this.empty && !this.attribute) {\n\t\t\t\treturn resolve();\n\t\t\t}\n\n\t\t\tvar timer;\n\n\t\t\t$.events(this.element, {\n\t\t\t\t\"click.mavo:preedit\": resolve,\n\t\t\t\t\"focus.mavo:preedit\": resolve\n\t\t\t});\n\n\t\t\tif (!this.attribute) {\n\t\t\t\t// Hovering over the element for over 150ms will trigger edit\n\t\t\t\t$.events(this.element, {\n\t\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t\ttimer = setTimeout(resolve, 150);\n\t\t\t\t\t},\n\t\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tif (this.defaults.edit) {\n\t\t\tthis.defaults.edit.call(this);\n\t\t\treturn;\n\t\t}\n\n\t\tthis.preEdit.then(() => {\n\t\t\t// Actual edit\n\t\t\t$.unbind(this.element, \".mavo:preedit\");\n\n\t\t\tif (this.initEdit) {\n\t\t\t\tthis.initEdit();\n\t\t\t}\n\n\t\t\tif (this.popup) {\n\t\t\t\tthis.popup.show();\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.editor.focus();\n\t\t\t}\n\n\t\t\tif (!this.attribute) {\n\t\t\t\tif (this.editor.parentNode != this.element) {\n\t\t\t\t\tthis.editorValue = this.value;\n\t\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}, // edit\n\n\tclear: function() {\n\t\tif (!this.constant) {\n\t\t\tthis.value = this.emptyValue;\n\t\t}\n\t},\n\n\tdataRender: function(data) {\n\t\tif (Array.isArray(data)) {\n\t\t\tdata = data[0]; // TODO what is gonna happen to the rest? Lost?\n\t\t}\n\n\t\tif (typeof data === \"object\") {\n\t\t\tdata = data[this.property];\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, {\n\t\t\tdefaults: this.defaults,\n\t\t\tattribute: this.attribute,\n\t\t\tdatatype: this.datatype\n\t\t});\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t},\n\n\t\teditorDefaults: function() {\n\t\t\treturn this.editor && _.getDefaults(this.editor);\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.sneak(() => {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tvalue = value || value === 0? value : \"\";\n\t\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\t\tif (value == this._value && !o.force) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\t\tthis.editorValue = value;\n\t\t\t}\n\n\t\t\tif (this.defaults.humanReadable && this.attribute) {\n\t\t\t\tpresentational = this.defaults.humanReadable.call(this, value);\n\t\t\t}\n\n\t\t\tif (!this.editing || this.attribute || !this.editor) {\n\t\t\t\tif (this.defaults.setValue) {\n\t\t\t\t\tthis.defaults.setValue.call(this, this.element, value);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!o.dataOnly) {\n\t\t\t\t\t\t_.setValue(this.element, {value, presentational}, {\n\t\t\t\t\t\t\tdefaults: this.defaults,\n\t\t\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\t\t\tdatatype: this.datatype\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.empty = value === \"\";\n\n\t\t\tthis._value = value;\n\n\t\t\tif (!o.silent) {\n\t\t\t\tif (this.saved) {\n\t\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t\t}\n\n\t\t\t\tthis.dataChanged(\"propertychange\", {value});\n\t\t\t}\n\t\t});\n\n\t\treturn value;\n\t},\n\n\tdataChanged: function(action = \"propertychange\", o) {\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tlive: {\n\t\tdefault: function (value) {\n\t\t\tif (this.value == this._default) {\n\n\t\t\t\tthis.value = value;\n\t\t\t}\n\t\t},\n\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function (value) {\n\t\t\tvar hide = value && // is empty\n\t\t\t!this.constant && // and editable\n\t\t\t!(this.attribute && $(Mavo.selectors.property, this.element)); // and has no property inside\n\n\t\t\tthis.element.classList.toggle(\"mv-empty\", hide);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetDefaults: function (element) {\n\t\t\tvar ret = null;\n\n\t\t\tfor (var selector in Mavo.Elements) {\n\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\tret = Mavo.Elements[selector];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetValueAttribute: function (element, defaults = _.getDefaults(element)) {\n\t\t\tvar ret = element.getAttribute(\"mv-attribute\") || defaults.attribute;\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, {\n\t\t\tdefaults = _.getDefaults(element),\n\t\t\tattribute = _.getValueAttribute(element, defaults),\n\t\t\tdatatype = defaults.datatype\n\t\t}) {\n\t\t\tif (defaults.getValue && attribute == defaults.attribute) {\n\t\t\t\treturn defaults.getValue(element);\n\t\t\t}\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tsetValue: function (element, value, {defaults, attribute, datatype}) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (element.nodeType === 1) {\n\t\t\t\tdefaults = defaults || _.getDefaults(element);\n\t\t\t\tattribute = attribute !== undefined? attribute : _.getValueAttribute(element, defaults);\n\t\t\t\tdatatype = datatype !== undefined? datatype : defaults.datatype;\n\n\t\t\t\tif (defaults.setValue && attribute == defaults.attribute) {\n\t\t\t\t\treturn defaults.setValue(element, value);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (attribute) {\n\t\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] !== value) {\n\t\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\t\ttry {\n\t\t\t\t\t\telement[attribute] = value;\n\t\t\t\t\t}\n\t\t\t\t\tcatch (e) {}\n\t\t\t\t}\n\n\t\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\t\tif (datatype == \"boolean\") {\n\t\t\t\t\tif (value != element.hasAttribute(attribute)) {\n\t\t\t\t\t\t$.toggleAttribute(element, attribute, value, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse if (element.getAttribute(attribute) != value) {  // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n_.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\tthis.popup = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: [\n\t\t\t\tthis.primitive.label + \":\",\n\t\t\t\tthis.editor\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\n\t\t\t // TODO what if it doesn’t fit?\n\t\t\t$.style(this.popup, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.position();\n\n\t\tdocument.body.appendChild(this.popup);\n\n\t\trequestAnimationFrame(e => this.popup.removeAttribute(\"hidden\")); // trigger transition\n\n\t\t$.events(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position);\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position);\n\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.popup);\n\t\t}, parseFloat(getComputedStyle(this.popup).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\n\t\t$.events(this.element, {\n\t\t\t\"click.mavo:showpopup\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:showpopup\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\",\n\t\t\"element\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n","/**\n * Configuration for different types of elements. Options:\n * - attribute {String}\n * - useProperty {Boolean}\n * - datatype {\"number\"|\"boolean\"|\"string\"} Default is \"string\"\n * - modes\n * - editor {Object|Function}\n * - setEditorValue temporary\n * - edit\n * - done\n * - observe\n * @\n */\n(function($, $$) {\n\nMavo.Elements = {\n\t\"*\": {\n\t\teditor: {\n\t\t\ttag: \"input\"\n\t\t}\n\t},\n\n\t\"img, video, audio\": {\n\t\tattribute: \"src\",\n\t\teditor: {\n\t\t\t\"tag\": \"input\",\n\t\t\t\"type\": \"url\",\n\t\t\t\"placeholder\": \"http://\"\n\t\t}\n\t},\n\n\t\"a, link\": {\n\t\tattribute: \"href\"\n\t},\n\n\t\"select, input\": {\n\t\tattribute: \"value\",\n\t\tmodes: \"read\",\n\t\tchangeEvents: \"input change\"\n\t},\n\n\t\"textarea\": {\n\t\tmodes: \"read\",\n\t\tchangeEvents: \"input\",\n\t\tgetValue: element => element.value,\n\t\tsetValue: (element, value) => element.value = value\n\t},\n\n\t\"input[type=range], input[type=number]\": {\n\t\tattribute: \"value\",\n\t\tdatatype: \"number\",\n\t\tmodes: \"read\",\n\t\tchangeEvents: \"input change\"\n\t},\n\n\t\"button, .counter\": {\n\t\tattribute: \"mv-clicked\",\n\t\tdatatype: \"number\",\n\t\tmodes: \"read\",\n\t\tinit: function(element) {\n\t\t\tif (this.attribute === \"mv-clicked\") {\n\t\t\t\telement.setAttribute(\"mv-clicked\", \"0\");\n\n\t\t\t\telement.addEventListener(\"click\", evt => {\n\t\t\t\t\tlet clicked = +element.getAttribute(\"mv-clicked\") || 0;\n\t\t\t\t\tthis.value = ++clicked;\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t},\n\n\t\"input[type=checkbox]\": {\n\t\tattribute: \"checked\",\n\t\tdatatype: \"boolean\",\n\t\tmodes: \"read\",\n\t\tchangeEvents: \"click\"\n\t},\n\n\t\"meter, progress\": {\n\t\tattribute: \"value\",\n\t\tdatatype: \"number\",\n\t\tedit: function() {\n\t\t\tvar min = +this.element.getAttribute(\"min\") || 0;\n\t\t\tvar max = +this.element.getAttribute(\"max\") || 1;\n\t\t\tvar range = max - min;\n\t\t\tvar step = +this.element.getAttribute(\"mv-edit-step\") || (range > 1? 1 : range/100);\n\n\t\t\tthis.element.addEventListener(\"mousemove.mavo:edit\", evt => {\n\t\t\t\t// Change property as mouse moves\n\t\t\t\tvar left = this.element.getBoundingClientRect().left;\n\t\t\t\tvar offset = Math.max(0, (evt.clientX - left) / this.element.offsetWidth);\n\t\t\t\tvar newValue = min + range * offset;\n\t\t\t\tvar mod = newValue % step;\n\n\t\t\t\tnewValue += mod > step/2? step - mod : -mod;\n\t\t\t\tnewValue = Math.max(min, Math.min(newValue, max));\n\n\t\t\t\tthis.sneak(() => this.element.setAttribute(\"value\", newValue));\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"mouseleave.mavo:edit\", evt => {\n\t\t\t\t// Return to actual value\n\t\t\t\tthis.sneak(() => this.element.setAttribute(\"value\", this.value));\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"click.mavo:edit\", evt => {\n\t\t\t\t// Register change\n\t\t\t\tthis.value = this.getValue();\n\t\t\t});\n\n\t\t\tthis.element.addEventListener(\"keydown.mavo:edit\", evt => {\n\t\t\t\t// Edit with arrow keys\n\t\t\t\tif (evt.target == this.element && (evt.keyCode == 37 || evt.keyCode == 39)) {\n\t\t\t\t\tvar increment = step * (evt.keyCode == 39? 1 : -1) * (evt.shiftKey? 10 : 1);\n\t\t\t\t\tvar newValue = this.value + increment;\n\t\t\t\t\tnewValue = Math.max(min, Math.min(newValue, max));\n\n\t\t\t\t\tthis.element.setAttribute(\"value\", newValue);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tdone: function() {\n\t\t\t$.unbind(this.element, \".mavo:edit\");\n\t\t}\n\t},\n\n\t\"meta\": {\n\t\tattribute: \"content\"\n\t},\n\n\t\"p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address\": {\n\t\teditor: function() {\n\t\t\tvar display = getComputedStyle(this.element).display;\n\t\t\tvar tag = display.indexOf(\"inline\") === 0? \"input\" : \"textarea\";\n\t\t\tvar editor = $.create(tag);\n\n\t\t\tif (tag == \"textarea\") {\n\t\t\t\t// Actually multiline\n\t\t\t\tvar width = this.element.offsetWidth;\n\n\t\t\t\tif (width) {\n\t\t\t\t\teditor.width = width;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn editor;\n\t\t},\n\n\t\tsetEditorValue: function(value) {\n\t\t\tif (this.datatype && this.datatype != \"string\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar cs = getComputedStyle(this.element);\n\t\t\tvalue = value || \"\";\n\n\t\t\tif ([\"normal\", \"nowrap\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse lines\n\t\t\t\tvalue = value.replace(/\\r?\\n/g, \" \");\n\t\t\t}\n\n\t\t\tif ([\"normal\", \"nowrap\", \"pre-line\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse whitespace\n\t\t\t\tvalue = value.replace(/^[ \\t]+|[ \\t]+$/gm, \"\").replace(/[ \\t]+/g, \" \");\n\t\t\t}\n\n\t\t\tthis.editor.value = value;\n\t\t\treturn true;\n\t\t}\n\t},\n\n\t\"time\": {\n\t\tattribute: \"datetime\",\n\t\teditor: function() {\n\t\t\tvar types = {\n\t\t\t\t\"date\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2}$/i,\n\t\t\t\t\"month\": /^[Y\\d]{4}-[M\\d]{2}$/i,\n\t\t\t\t\"time\": /^[H\\d]{2}:[M\\d]{2}/i,\n\t\t\t\t\"week\": /[Y\\d]{4}-W[W\\d]{2}$/i,\n\t\t\t\t\"datetime-local\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2} [H\\d]{2}:[M\\d]{2}/i\n\t\t\t};\n\n\t\t\tvar datetime = this.element.getAttribute(\"datetime\") || \"YYYY-MM-DD\";\n\n\t\t\tfor (var type in types) {\n\t\t\t\tif (types[type].test(datetime)) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {tag: \"input\", type};\n\t\t},\n\t\thumanReadable: function (value) {\n\t\t\tvar date = new Date(value);\n\n\t\t\tif (!value || isNaN(date)) {\n\t\t\t\treturn \"(No \" + this.label + \")\";\n\t\t\t}\n\n\t\t\t// TODO do this properly (account for other datetime datatypes and different formats)\n\t\t\tvar options = {\n\t\t\t\t\"date\": {day: \"numeric\", month: \"short\", year: \"numeric\"},\n\t\t\t\t\"month\": {month: \"long\"},\n\t\t\t\t\"time\": {hour: \"numeric\", minute: \"numeric\"},\n\t\t\t\t\"datetime-local\": {day: \"numeric\", month: \"short\", year: \"numeric\", hour: \"numeric\", minute: \"numeric\"}\n\t\t\t};\n\n\t\t\tvar format = options[this.editor && this.editor.type] || options.date;\n\t\t\tformat.timeZone = \"UTC\";\n\n\t\t\treturn date.toLocaleString(\"en-GB\", format);\n\t\t}\n\t}\n};\n\n})(Bliss, Bliss.$);\n","(function($, $$) {\n\nMavo.attributes.push(\"mv-multiple\", \"mv-order\", \"mv-accepts\");\n\nvar _ = Mavo.Collection = $.Class({\n\textends: Mavo.Node,\n\tnodeType: \"Collection\",\n\tconstructor: function (element, mavo, o) {\n\t\t/*\n\t\t * Create the template, remove it from the DOM and store it\n\t\t */\n\t\tthis.templateElement = this.element;\n\n\t\tthis.children = [];\n\n\t\t// ALL descendant property names as an array\n\t\tif (!this.fromTemplate(\"properties\", \"mutable\", \"templateElement\", \"accepts\")) {\n\t\t\tthis.properties = $$(Mavo.selectors.property, this.templateElement).map(Mavo.Node.getProperty);\n\t\t\tthis.mutable = this.templateElement.matches(Mavo.selectors.multiple);\n\t\t\tthis.accepts = (this.templateElement.getAttribute(\"mv-accepts\") || \"\").split(/\\s+/);\n\n\t\t\t// Must clone because otherwise once expressions are parsed on the template element\n\t\t\t// we will not be able to pick them up from subsequent items\n\t\t\tthis.templateElement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\tvar item = this.createItem(this.element);\n\t\t\tthis.add(item);\n\t\t\tthis.itemTemplate = item.template || item;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-init-end\", this);\n\t},\n\n\tget length() {\n\t\treturn this.children.length;\n\t},\n\n\tgetData: function(o = {}) {\n\t\tvar env = {\n\t\t\tcontext: this,\n\t\t\toptions: o,\n\t\t\tdata: []\n\t\t};\n\n\t\tfor (item of this.children) {\n\t\t\tif (!item.deleted) {\n\t\t\t\tlet itemData = item.getData(env.options);\n\n\t\t\t\tif (itemData) {\n\t\t\t\t\tenv.data.push(itemData);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (this.unhandled && env.options.unhandled) {\n\t\t\tenv.data = this.unhandled.before.concat(env.data, this.unhandled.after);\n\t\t}\n\n\t\tif (!this.mutable && env.data.length == 1) {\n\t\t\t// See https://github.com/LeaVerou/mavo/issues/50#issuecomment-266079652\n\t\t\tenv.data = env.data[0];\n\t\t}\n\n\t\tMavo.hooks.run(\"node-getdata-end\", env);\n\n\t\treturn env.data;\n\t},\n\n\t// Create item but don't insert it anywhere\n\t// Mostly used internally\n\tcreateItem: function (element) {\n\t\tif (!element) {\n\t\t\telement = this.templateElement.cloneNode(true);\n\t\t}\n\n\t\tvar item = Mavo.Node.create(element, this.mavo, {\n\t\t\tcollection: this,\n\t\t\ttemplate: this.itemTemplate || (this.template? this.template.itemTemplate : null),\n\t\t\tproperty: this.property,\n\t\t\ttype: this.type\n\t\t});\n\n\t\treturn item;\n\t},\n\n\t/**\n\t * Add a new item to this collection\n\t * @param item {Node|Mavo.Node} Optional. Element or Mavo object for the new item\n\t * @param index {Number} Optional. Index of existing item, will be added opposite to list direction\n\t * @param silent {Boolean} Optional. Throw a datachange event? Mainly used internally.\n\t */\n\tadd: function(item, index, o = {}) {\n\t\tif (item instanceof Node) {\n\t\t\titem = Mavo.Node.get(item) || this.createItem(item);\n\t\t}\n\t\telse {\n\t\t\titem = item || this.createItem();\n\t\t}\n\n\t\tif (item.collection != this) {\n\t\t\tthis.adopt(item);\n\t\t}\n\n\t\tif (index === undefined) {\n\t\t\tindex = this.bottomUp? 0 : this.length;\n\t\t}\n\n\t\tif (this.mutable) {\n\t\t\t// Add it to the DOM, or fix its place\n\t\t\tvar nextItem = this.children[index];\n\n\t\t\titem.element._.before(nextItem && nextItem.element || this.marker);\n\t\t}\n\n\t\tvar env = {context: this, item};\n\n\t\tenv.previousIndex = item.index;\n\n\t\t// Update internal data model\n\t\tenv.changed = this.splice({\n\t\t\tremove: env.item\n\t\t}, {\n\t\t\tindex: index,\n\t\t\tadd: env.item\n\t\t});\n\n\t\tif (!o.silent) {\n\t\t\tenv.changed.forEach(i => {\n\t\t\t\ti.dataChanged(i == env.item && env.previousIndex === undefined? \"add\" : \"move\");\n\t\t\t\ti.unsavedChanges = true;\n\t\t\t});\n\n\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t}\n\n\t\tMavo.hooks.run(\"collection-add-end\", env);\n\n\t\treturn env.item;\n\t},\n\n\tsplice: function(...actions) {\n\t\tfor (let action of actions) {\n\t\t\tif (action.index === undefined && action.remove && isNaN(action.remove)) {\n\t\t\t\t// Remove is an item\n\t\t\t\taction.index = this.children.indexOf(action.remove);\n\t\t\t\taction.remove = 1;\n\t\t\t}\n\t\t}\n\n\t\t// Sort in reverse index order\n\t\tactions.sort((a, b) => b.index - a.index);\n\n\t\t// FIXME this could still result in buggy behavior.\n\t\t// Think of e.g. adding items on i, then removing > 1 items on i-1.\n\t\t// The new items would get removed instead of the old ones.\n\t\t// Not a pressing issue though since we always remove 1 max when adding things too.\n\t\tfor (let action of actions) {\n\t\t\tif (action.index > -1 && (action.remove || action.add)) {\n\t\t\t\taction.remove = action.remove || 0;\n\t\t\t\taction.add = Mavo.toArray(action.add);\n\n\t\t\t\tthis.children.splice(action.index, +action.remove, ...action.add);\n\t\t\t}\n\t\t}\n\n\t\tvar changed = [];\n\n\t\tfor (let i = 0; i < this.length; i++) {\n\t\t\tlet item = this.children[i];\n\n\t\t\tif (item && item.index !== i) {\n\t\t\t\titem.index = i;\n\t\t\t\tchanged.push(item);\n\t\t\t}\n\t\t}\n\n\t\treturn changed;\n\t},\n\n\tadopt: function(item) {\n\t\tif (item.collection) {\n\t\t\t// It belongs to another collection, delete from there first\n\t\t\titem.collection.splice({remove: item});\n\t\t\titem.collection.dataChanged(\"delete\");\n\t\t}\n\n\t\t // Update collection & closestCollection properties\n\t\tthis.walk(obj => {\n\t\t\tif (obj.closestCollection === item.collection) {\n\t\t\t\tobj.closestCollection = this;\n\t\t\t}\n\n\t\t\t// Belongs to another Mavo?\n\t\t\tif (item.mavo != this.mavo) {\n\t\t\t\titem.mavo = this.mavo;\n\t\t\t}\n\t\t});\n\n\t\titem.collection = this;\n\n\t\t// Adjust templates and their copies\n\t\tif (item.template) {\n\t\t\tMavo.delete(item.template.copies, item);\n\n\t\t\titem.template = this.itemTemplate;\n\t\t}\n\t},\n\n\tdelete: function(item, hard) {\n\t\tif (hard) {\n\t\t\t// Hard delete\n\t\t\t$.remove(item.element);\n\t\t\tthis.splice({remove: item});\n\t\t\treturn;\n\t\t}\n\n\t\treturn $.transition(item.element, {opacity: 0}).then(() => {\n\t\t\titem.deleted = true; // schedule for deletion\n\t\t\titem.element.style.opacity = \"\";\n\n\t\t\titem.dataChanged(\"delete\");\n\n\t\t\tthis.unsavedChanges = item.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t});\n\t},\n\n\tedit: function() {\n\t\tthis.super.edit.call(this);\n\n\t\tif (this.mutable) {\n\t\t\t// Insert the add button if it's not already in the DOM\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\tif (this.bottomUp) {\n\t\t\t\t\tthis.addButton._.before($.value(this.children[0], \"element\") || this.marker);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tvar tag = this.element.tagName.toLowerCase();\n\t\t\t\t\tvar containerSelector = Mavo.selectors.container[tag];\n\n\t\t\t\t\tif (containerSelector) {\n\t\t\t\t\t\tvar after = this.marker.parentNode.closest(containerSelector);\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.addButton._.after(after && after.parentNode? after : this.marker);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Set up drag & drop\n\t\t\t_.dragula.then(() => {\n\t\t\t\tthis.getDragula();\n\t\t\t});\n\t\t}\n\t},\n\n\tdone: function() {\n\t\tthis.super.done.call(this);\n\n\t\tif (this.mutable) {\n\t\t\tif (this.addButton.parentNode) {\n\t\t\t\tthis.addButton.remove();\n\t\t\t}\n\t\t}\n\t},\n\n\t/**\n\t * Delete all items in the collection.\n\t */\n\tclear: function() {\n\t\tif (this.mutable) {\n\t\t\tthis.propagate(item => {\n\t\t\t\tif (item.element.remove) {\n\t\t\t\t\titem.element.remove();\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Document fragment, remove all children\n\t\t\t\t\tfor (let node of item.element.childNodes) {\n\t\t\t\t\t\tnode => node.remove();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.children = [];\n\n\t\t\tthis.dataChanged(\"clear\");\n\t\t}\n\t},\n\n\tdataChanged: function(action, o = {}) {\n\t\to.element = o.element || this.marker;\n\t\treturn this.super.dataChanged.call(this, action, o);\n\t},\n\n\tsave: function() {\n\t\tfor (let item of this.children) {\n\t\t\tif (item.deleted) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\titem.unsavedChanges = false;\n\t\t\t}\n\t\t}\n\t},\n\n\tpropagated: [\"save\"],\n\n\trevert: function() {\n\t\tfor (let item of this.children) {\n\t\t\t// Delete added items\n\t\t\tif (item.unsavedChanges) {\n\t\t\t\tthis.delete(item, true);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Bring back deleted items\n\t\t\t\tif (item.deleted) {\n\t\t\t\t\titem.deleted = false;\n\t\t\t\t}\n\n\t\t\t\t// Revert all properties\n\t\t\t\titem.revert();\n\t\t\t}\n\t\t}\n\t},\n\n\tdataRender: function(data) {\n\t\tthis.unhandled = {before: [], after: []};\n\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\n\t\tdata = Mavo.toArray(data);\n\n\t\tif (!this.mutable) {\n\t\t\tthis.children.forEach((item, i) => item.render(data && data[i]));\n\n\t\t\tif (data) {\n\t\t\t\tthis.unhandled.after = data.slice(this.length);\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tthis.clear();\n\n\t\t\t// Using document fragments improved rendering performance by 60%\n\t\t\tvar fragment = document.createDocumentFragment();\n\n\t\t\tdata.forEach((datum, i) => {\n\t\t\t\tvar item = this.createItem();\n\n\t\t\t\titem.render(datum);\n\n\t\t\t\tthis.children.push(item);\n\t\t\t\titem.index = i;\n\n\t\t\t\tfragment.appendChild(item.element);\n\n\t\t\t\tvar env = {context: this, item};\n\t\t\t\tMavo.hooks.run(\"collection-add-end\", env);\n\t\t\t});\n\n\t\t\tthis.marker.parentNode.insertBefore(fragment, this.marker);\n\t\t}\n\t},\n\n\tfind: function(property, o = {}) {\n\t\tvar items = this.children.filter(item => !item.deleted);\n\n\t\tif (this.property == property) {\n\t\t\treturn o.collections? this : items;\n\t\t}\n\n\t\tif (this.properties.indexOf(property) > -1) {\n\t\t\tvar ret = items.map(item => item.find(property, o));\n\n\t\t\treturn Mavo.flatten(ret);\n\t\t}\n\t},\n\n\tisCompatible: function(c) {\n\t\treturn c && this.itemTemplate.nodeType == c.itemTemplate.nodeType && (c === this\n\t\t       || c.template == this || this.template == c || this.template && this.template == c.template\n\t\t       || this.accepts.indexOf(c.property) > -1);\n\t},\n\n\tlive: {\n\t\tmutable: function(value) {\n\t\t\tif (value && value !== this.mutable) {\n\t\t\t\t// Why is all this code here? Because we want it executed\n\t\t\t\t// every time mutable changes, not just in the constructor\n\t\t\t\t// (think multiple elements with the same property name, where only one has mv-multiple)\n\t\t\t\tthis._mutable = value;\n\n\t\t\t\t// Keep position of the template in the DOM, since we might remove it\n\t\t\t\tthis.marker = document.createComment(\"mv-marker\");\n\t\t\t\tMavo.data(this.marker, \"collection\", this);\n\t\t\t\t$.after(this.marker, this.templateElement);\n\n\t\t\t\tthis.templateElement.classList.add(\"mv-item\");\n\t\t\t}\n\t\t}\n\t},\n\n\t// Make sure to only call after dragula has loaded\n\tgetDragula: function() {\n\t\tif (this.dragula) {\n\t\t\treturn this.dragula;\n\t\t}\n\n\t\tif (this.template) {\n\t\t\tMavo.pushUnique(this.template.getDragula().containers, this.marker.parentNode);\n\t\t\treturn this.dragula = this.template.dragula || this.template.getDragula();\n\t\t}\n\n\t\tvar me = this;\n\t\tthis.dragula = dragula({\n\t\t\tcontainers: [this.marker.parentNode],\n\t\t\tisContainer: el => {\n\t\t\t\tif (this.accepts.length) {\n\t\t\t\t\treturn Mavo.flatten(this.accepts.map(property => this.mavo.root.find(property, {collections: true})))\n\t\t\t\t\t\t\t\t.filter(c => c && c instanceof _)\n\t\t\t\t\t\t\t\t.map(c => c.marker.parentNode)\n\t\t\t\t\t\t\t\t.indexOf(el) > -1;\n\t\t\t\t}\n\n\t\t\t\treturn false;\n\t\t\t},\n\t\t\tmoves: (el, container, handle) => {\n\t\t\t\treturn handle.classList.contains(\"mv-drag-handle\") && handle.closest(Mavo.selectors.item) == el;\n\t\t\t},\n\t\t\taccepts: function(el, target, source, next) {\n\t\t\t\tif (el.contains(target)) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar previous = next? next.previousElementSibling : target.lastElementChild;\n\n\t\t\t\tvar collection = _.get(previous) || _.get(next);\n\n\t\t\t\tif (!collection) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tvar item = Mavo.Node.get(el);\n\n\t\t\t\treturn item && item.collection.isCompatible(collection);\n\t\t\t}\n\t\t});\n\n\t\tthis.dragula.on(\"drop\", (el, target, source) => {\n\t\t\tvar item = Mavo.Node.get(el);\n\t\t\tvar oldIndex = item && item.index;\n\t\t\tvar next = el.nextElementSibling;\n\t\t\tvar previous = el.previousElementSibling;\n\t\t\tvar collection = _.get(previous) || _.get(next);\n\t\t\tvar closestItem = Mavo.Node.get(previous) || Mavo.Node.get(next);\n\n\t\t\tif (closestItem && closestItem.collection != collection) {\n\t\t\t\tclosestItem = null;\n\t\t\t}\n\n\t\t\tif (item.collection.isCompatible(collection)) {\n\t\t\t\tvar index = closestItem? closestItem.index + (closestItem.element === previous) : collection.length;\n\t\t\t\tcollection.add(item, index);\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn this.dragula.cancel(true);\n\t\t\t}\n\t\t});\n\n\t\t_.dragulas.push(this.dragula);\n\n\t\treturn this.dragula;\n\t},\n\n\tlazy: {\n\t\tbottomUp: function() {\n\t\t\t/*\n\t\t\t * Add new items at the top or bottom?\n\t\t\t */\n\n\t\t\tif (!this.mutable) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tvar order = this.templateElement.getAttribute(\"mv-order\");\n\t\t\tif (order !== null) {\n\t\t\t\t// Attribute has the highest priority and overrides any heuristics\n\t\t\t\treturn /^desc\\b/i.test(order);\n\t\t\t}\n\n\t\t\tif (!this.addButton.parentNode) {\n\t\t\t\t// If add button not in DOM, do the default\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\t// If add button is already in the DOM and *before* our template, then we default to prepending\n\t\t\treturn !!(this.addButton.compareDocumentPosition(this.templateElement) & Node.DOCUMENT_POSITION_FOLLOWING);\n\t\t},\n\n\t\tclosestCollection: function() {\n\t\t\tvar parent = this.marker? this.marker.parentNode : this.templateElement.parentNode;\n\n\t\t\treturn parent.closest(Mavo.selectors.item);\n\t\t},\n\n\t\taddButton: function() {\n\t\t\t// Find add button if provided, or generate one\n\t\t\tvar selector = `button.mv-add-${this.property}`;\n\t\t\tvar group = this.closestCollection || this.marker.parentNode.closest(Mavo.selectors.group);\n\n\t\t\tif (group) {\n\t\t\t\tvar button = $$(selector, group).filter(button => {\n\t\t\t\t\treturn !this.templateElement.contains(button);\n\t\t\t\t})[0];\n\t\t\t}\n\n\t\t\tif (!button) {\n\t\t\t\tbutton = $.create(\"button\", {\n\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\ttextContent: \"Add \" + this.name\n\t\t\t\t});\n\t\t\t};\n\n\t\t\tbutton.classList.add(\"mv-ui\", \"mv-add\");\n\t\t\tMavo.data(button, \"collection\", this);\n\n\t\t\tif (this.property) {\n\t\t\t\tbutton.classList.add(`mv-add-${this.property}`);\n\t\t\t}\n\n\t\t\tbutton.addEventListener(\"click\", evt => {\n\t\t\t\tevt.preventDefault();\n\n\t\t\t\tthis.add().edit();\n\t\t\t});\n\n\t\t\treturn button;\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdragulas: [],\n\t\tget: element => {\n\t\t\t// Is it an add button or a marker?\n\t\t\tvar collection = Mavo.data(element, \"collection\");\n\n\t\t\tif (collection) {\n\t\t\t\treturn collection;\n\t\t\t}\n\n\t\t\t// Maybe it's a collection item?\n\t\t\tvar item = Mavo.Node.get(element);\n\n\t\t\treturn item && item.collection || null;\n\t\t},\n\n\t\tlazy: {\n\t\t\tdragula: () => $.include(self.dragula, \"https://cdnjs.cloudflare.com/ajax/libs/dragula/3.7.2/dragula.min.js\")\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"primitive-init-end\", function() {\n\tif (this.collection && !this.attribute) {\n\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\tvar swapUI = callback => {\n\t\t\tvar ret;\n\n\t\t\tthis.sneak(() => {\n\t\t\t\tvar ui = $.remove($(\".mv-item-controls\", this.element));\n\n\t\t\t\tret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t});\n\n\t\t\treturn ret;\n\t\t};\n\n\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\tget: function() {\n\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t},\n\n\t\t\t\tset: function(value) {\n\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"node-edit-end\", function() {\n\tif (this.collection) {\n\t\tif (!this.itemControls) {\n\t\t\tthis.itemControls = $$(\".mv-item-controls\", this.element)\n\t\t\t\t\t\t\t\t   .filter(el => el.closest(Mavo.selectors.item) == this.element)[0];\n\n\t\t\tthis.itemControls = this.itemControls || $.create({\n\t\t\t\tclassName: \"mv-item-controls mv-ui\"\n\t\t\t});\n\n\t\t\t$.set(this.itemControls, {\n\t\t\t\tcontents: [\n\t\t\t\t\t{\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Delete this \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-delete\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => this.collection.delete(this)\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: `Add new ${this.name.replace(/s$/i, \"\")} ${this.collection.bottomUp? \"after\" : \"before\"}`,\n\t\t\t\t\t\tclassName: \"mv-add\",\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\"click\": evt => {\n\t\t\t\t\t\t\t\tvar item = this.collection.add(null, this.index + this.collection.bottomUp);\n\n\t\t\t\t\t\t\t\tif (evt[Mavo.superKey]) {\n\t\t\t\t\t\t\t\t\titem.render(this.data);\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (!Mavo.inViewport(item.element)) {\n\t\t\t\t\t\t\t\t\titem.element.scrollIntoView({behavior: \"smooth\"});\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\treturn item.edit();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}, {\n\t\t\t\t\t\ttag: \"button\",\n\t\t\t\t\t\ttitle: \"Drag to reorder \" + this.name,\n\t\t\t\t\t\tclassName: \"mv-drag-handle\"\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t\t});\n\t\t}\n\n\t\tif (!this.itemControls.parentNode) {\n\t\t\tthis.element.appendChild(this.itemControls);\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"node-done-end\", function() {\n\tif (this.collection) {\n\t\tif (this.itemControls) {\n\t\t\tthis.itemControls.remove();\n\t\t}\n\t}\n});\n\nMavo.Node.prototype.getClosestCollection = function() {\n\treturn this.collection ||\n\t\t   this.group.collection ||\n\t\t   (this.parentGroup? this.parentGroup.closestCollection : null);\n};\n\n$.lazy(Mavo.Node.prototype, \"closestCollection\", function() {\n\treturn this.getClosestCollection();\n});\n\n$.live(Mavo.Node.prototype, \"deleted\", function(value) {\n\tthis.element.classList.toggle(\"mv-deleted\", value);\n\n\tif (value) {\n\t\t// Soft delete, store element contents in a fragment\n\t\t// and replace them with an undo prompt.\n\t\tthis.elementContents = document.createDocumentFragment();\n\t\t$$(this.element.childNodes).forEach(node => {\n\t\t\tthis.elementContents.appendChild(node);\n\t\t});\n\n\t\t$.contents(this.element, [\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-close mv-ui\",\n\t\t\t\ttextContent: \"×\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": function(evt) {\n\t\t\t\t\t\t$.remove(this.parentNode);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"Deleted \" + this.name,\n\t\t\t{\n\t\t\t\ttag: \"button\",\n\t\t\t\tclassName: \"mv-undo mv-ui\",\n\t\t\t\ttextContent: \"Undo\",\n\t\t\t\tevents: {\n\t\t\t\t\t\"click\": evt => this.deleted = false\n\t\t\t\t}\n\t\t\t}\n\t\t]);\n\n\t\tthis.element.classList.remove(\"mv-highlight\");\n\t}\n\telse if (this.deleted) {\n\t\t// Undelete\n\t\tthis.element.textContent = \"\";\n\t\tthis.element.appendChild(this.elementContents);\n\n\t\t// otherwise expressions won't update because this will still seem as deleted\n\t\t// Alternatively, we could fire datachange with a timeout.\n\t\tthis._deleted = false;\n\n\t\tthis.dataChanged(\"undelete\");\n\t}\n});\n\n/**\n * Check if this unit is either deleted or inside a deleted group\n */\nMavo.Node.prototype.isDeleted = function() {\n\tvar ret = this.deleted;\n\n\tif (this.deleted) {\n\t\treturn true;\n\t}\n\n\treturn !!this.parentGroup && this.parentGroup.isDeleted();\n};\n\nMavo.hooks.add(\"node-init-end\", function(env) {\n\tthis.collection = env.options.collection;\n\n\tif (this.collection) {\n\t\t// This is a collection item\n\t\tthis.group = this.parentGroup = this.collection.parentGroup;\n\t}\n});\n\n})(Bliss, Bliss.$);\n","(function($) {\n\nMavo.attributes.push(\"mv-expressions\");\n\nvar _ = Mavo.Expression = $.Class({\n\tconstructor: function(expression) {\n\t\tthis.expression = expression;\n\t},\n\n\teval: function(data) {\n\t\tthis.oldValue = this.value;\n\n\t\tMavo.hooks.run(\"expression-eval-beforeeval\", this);\n\n\t\ttry {\n\t\t\tif (!this.function) {\n\t\t\t\tthis.function = _.compile(this.expression);\n\t\t\t\tthis.identifiers = this.expression.match(/[$a-z][$\\w]*/ig) || [];\n\t\t\t}\n\n\t\t\tthis.value = this.function(data);\n\t\t}\n\t\tcatch (exception) {\n\t\t\tconsole.log(exception);\n\t\t\tMavo.hooks.run(\"expression-eval-error\", {context: this, exception});\n\n\t\t\tthis.value = exception;\n\t\t}\n\n\t\treturn this.value;\n\t},\n\n\ttoString() {\n\t\treturn this.expression;\n\t},\n\n\tchangedBy: function(evt) {\n\t\tif (!this.identifiers || !evt) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (this.identifiers.indexOf(evt.property) > -1) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (evt.action != \"propertychange\") {\n\t\t\tif (Mavo.hasIntersection([\"$index\", \"$all\", \"$previous\", \"$next\"], this.identifiers)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tvar collection = evt.node.collection || evt.node;\n\n\t\t\tif (Mavo.hasIntersection(collection.properties, this.identifiers)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\tif (Mavo.hasIntersection(Mavo.allIds, this.identifiers)) {\n\t\t\treturn true; // contains a Mavo id\n\t\t}\n\n\t\treturn false;\n\t},\n\n\tlive: {\n\t\texpression: function(value) {\n\t\t\tvar code = value = value;\n\n\t\t\tthis.function = null;\n\t\t}\n\t},\n\n\tstatic: {\n\t\t/**\n\t\t * These serializers transform the AST into JS\n\t\t */\n\t\tserializers: {\n\t\t\t\"BinaryExpression\": node => `${_.serialize(node.left)} ${node.operator} ${_.serialize(node.right)}`,\n\t\t\t\"UnaryExpression\": node => `${node.operator}${_.serialize(node.argument)}`,\n\t\t\t\"CallExpression\": node => `${_.serialize(node.callee)}(${node.arguments.map(_.serialize).join(\", \")})`,\n\t\t\t\"ConditionalExpression\": node => `${_.serialize(node.test)}? ${_.serialize(node.consequent)} : ${_.serialize(node.alternate)}`,\n\t\t\t\"MemberExpression\": node => `get(${_.serialize(node.object)}, \"${node.property.name || node.property.value}\")`,\n\t\t\t\"ArrayExpression\": node => `[${node.elements.map(_.serialize).join(\", \")}]`,\n\t\t\t\"Literal\": node => node.raw,\n\t\t\t\"Identifier\": node => node.name,\n\t\t\t\"ThisExpression\": node => \"this\",\n\t\t\t\"Compound\": node => node.body.map(_.serialize).join(\" \")\n\t\t},\n\n\t\t/**\n\t\t * These are run before the serializers and transform the expression to support MavoScript\n\t\t */\n\t\ttransformations: {\n\t\t\t\"BinaryExpression\": node => {\n\t\t\t\tlet name = Mavo.Script.getOperatorName(node.operator);\n\t\t\t\tlet details = Mavo.Script.operators[name];\n\n\t\t\t\t// Flatten same operator calls\n\t\t\t\tvar nodeLeft = node;\n\t\t\t\tvar args = [];\n\n\t\t\t\tdo {\n\t\t\t\t\targs.unshift(nodeLeft.right);\n\t\t\t\t\tnodeLeft = nodeLeft.left;\n\t\t\t\t} while (Mavo.Script.getOperatorName(nodeLeft.operator) === name);\n\n\t\t\t\targs.unshift(nodeLeft);\n\n\t\t\t\tif (args.length > 1) {\n\t\t\t\t\treturn `${name}(${args.map(_.serialize).join(\", \")})`;\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"CallExpression\": node => {\n\t\t\t\tif (node.callee.type == \"Identifier\" && node.callee.name == \"if\") {\n\t\t\t\t\tnode.callee.name = \"iff\";\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tserialize: node => {\n\t\t\tif (_.transformations[node.type]) {\n\t\t\t\tvar ret = _.transformations[node.type](node);\n\n\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn _.serializers[node.type](node);\n\t\t},\n\n\t\trewrite: function(code) {\n\t\t\ttry {\n\t\t\t\treturn _.serialize(_.parse(code));\n\t\t\t}\n\t\t\tcatch (e) {\n\t\t\t\t// Parsing as MavoScript failed, falling back to plain JS\n\t\t\t\treturn code;\n\t\t\t}\n\t\t},\n\n\t\tcompile: function(code) {\n\t\t\tcode = _.rewrite(code);\n\n\t\t\treturn new Function(\"data\", `with(Mavo.Functions._Trap)\n\t\t\t\t\twith(data) {\n\t\t\t\t\t\treturn ${code};\n\t\t\t\t\t}`);\n\t\t},\n\n\t\tparse: self.jsep,\n\t}\n});\n\nif (self.jsep) {\n\tjsep.addBinaryOp(\"and\", 2);\n\tjsep.addBinaryOp(\"or\", 2);\n\tjsep.addBinaryOp(\"=\", 6);\n\tjsep.addBinaryOp(\"mod\", 10);\n\tjsep.removeBinaryOp(\"===\");\n}\n\n_.serializers.LogicalExpression = _.serializers.BinaryExpression;\n_.transformations.LogicalExpression = _.transformations.BinaryExpression;\n\n_.Syntax = $.Class({\n\tconstructor: function(start, end) {\n\t\tthis.start = start;\n\t\tthis.end = end;\n\t\tthis.regex = RegExp(`${Mavo.escapeRegExp(start)}([\\\\S\\\\s]+?)${Mavo.escapeRegExp(end)}`, \"gi\");\n\t},\n\n\ttest: function(str) {\n\t\tthis.regex.lastIndex = 0;\n\n\t\treturn this.regex.test(str);\n\t},\n\n\ttokenize: function(str) {\n\t\tvar match, ret = [], lastIndex = 0;\n\n\t\tthis.regex.lastIndex = 0;\n\n\t\twhile ((match = this.regex.exec(str)) !== null) {\n\t\t\t// Literal before the expression\n\t\t\tif (match.index > lastIndex) {\n\t\t\t\tret.push(str.substring(lastIndex, match.index));\n\t\t\t}\n\n\t\t\tlastIndex = this.regex.lastIndex;\n\n\t\t\tret.push(new Mavo.Expression(match[1]));\n\t\t}\n\n\t\t// Literal at the end\n\t\tif (lastIndex < str.length) {\n\t\t\tret.push(str.substring(lastIndex));\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tstatic: {\n\t\tcreate: function(element) {\n\t\t\tif (element) {\n\t\t\t\tvar syntax = element.getAttribute(\"mv-expressions\");\n\n\t\t\t\tif (syntax) {\n\t\t\t\t\tsyntax = syntax.trim();\n\t\t\t\t\treturn /\\s/.test(syntax)? new _.Syntax(...syntax.split(/\\s+/)) : _.Syntax.ESCAPE;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\tESCAPE: -1\n\t}\n});\n\n_.Syntax.default = new _.Syntax(\"[\", \"]\");\n\n})(Bliss);\n","(function($) {\n\nvar _ = Mavo.ExpressionText = $.Class({\n\tconstructor: function(o = {}) {\n\t\tthis.mavo = o.mavo;\n\t\tthis.template = o.template && o.template.template || o.template;\n\n\t\tfor (let prop of [\"item\", \"path\", \"syntax\", \"fallback\", \"attribute\"]) {\n\t\t\tthis[prop] = o[prop] === undefined && this.template? this.template[prop] : o[prop];\n\t\t}\n\n\t\tthis.node = o.node;\n\n\t\tif (!this.node) {\n\t\t\t// No node provided, figure it out from path\n\t\t\tthis.node = this.path.reduce((node, index) => {\n\t\t\t\treturn node.childNodes[index];\n\t\t\t}, this.item.element);\n\t\t}\n\n\t\tthis.element = this.node;\n\t\tthis.attribute = this.attribute || null;\n\n\t\tMavo.hooks.run(\"expressiontext-init-start\", this);\n\n\t\tif (!this.expression) { // Still unhandled?\n\t\t\tif (this.node.nodeType === 3) {\n\t\t\t\tthis.element = this.node.parentNode;\n\n\t\t\t\t// If no element siblings make this.node the element, which is more robust\n\t\t\t\t// Same if attribute, there are no attributes on a text node!\n\t\t\t\tif (!this.node.parentNode.children.length || this.attribute) {\n\t\t\t\t\tthis.node = this.element;\n\t\t\t\t\tthis.element.normalize();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.expression = this.node.getAttribute(this.attribute).trim();\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Move whitespace outside to prevent it from messing with types\n\t\t\t\tthis.node.normalize();\n\n\t\t\t\tif (this.node.firstChild && this.node.childNodes.length === 1 && this.node.firstChild.nodeType === 3) {\n\t\t\t\t\tvar whitespace = this.node.firstChild.textContent.match(/^\\s*|\\s*$/g);\n\n\t\t\t\t\tif (whitespace[1]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(this.node.firstChild.textContent.length - whitespace[1].length);\n\t\t\t\t\t\t$.after(this.node.lastChild, this.node);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (whitespace[0]) {\n\t\t\t\t\t\tthis.node.firstChild.splitText(whitespace[0].length);\n\t\t\t\t\t\tthis.node.parentNode.insertBefore(this.node.firstChild, this.node);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthis.expression = this.node.textContent;\n\t\t\t}\n\n\n\t\t\tthis.parsed = o.template? o.template.parsed : this.syntax.tokenize(this.expression);\n\t\t}\n\n\t\tthis.oldValue = this.value = this.parsed.map(x => x instanceof Mavo.Expression? x.expression : x);\n\n\t\tMavo.hooks.run(\"expressiontext-init-end\", this);\n\n\t\t_.elements.set(this.element, [...(_.elements.get(this.element) || []), this]);\n\t},\n\n\tchangedBy: function(evt) {\n\t\treturn !this.parsed.every(expr => !(expr instanceof Mavo.Expression) || !expr.changedBy(evt));\n\t},\n\n\tupdate: function(data = this.data, evt) {\n\t\tthis.data = data;\n\n\t\tvar ret = {};\n\n\t\tMavo.hooks.run(\"expressiontext-update-start\", this);\n\n\t\tthis.oldValue = this.value;\n\n\t\tret.value = this.value = this.parsed.map((expr, i) => {\n\t\t\tif (expr instanceof Mavo.Expression) {\n\t\t\t\tif (expr.changedBy(evt)) {\n\t\t\t\t\tvar env = {context: this, expr};\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-beforeeval\", env);\n\n\t\t\t\t\tenv.value = env.expr.eval(data);\n\n\t\t\t\t\tMavo.hooks.run(\"expressiontext-update-aftereval\", env);\n\n\t\t\t\t\tif (env.value instanceof Error) {\n\t\t\t\t\t\treturn this.fallback !== undefined? this.fallback : env.expr.expression;\n\t\t\t\t\t}\n\t\t\t\t\tif (env.value === undefined || env.value === null) {\n\t\t\t\t\t\t// Don’t print things like \"undefined\" or \"null\"\n\t\t\t\t\t\treturn \"\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn env.value;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn this.oldValue[i];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn expr;\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\t// Separate presentational & actual values only apply when content is variable\n\t\t\tret.presentational = this.value.map(value => {\n\t\t\t\tif (Array.isArray(value)) {\n\t\t\t\t\treturn value.join(\", \");\n\t\t\t\t}\n\n\t\t\t\tif (typeof value == \"number\") {\n\t\t\t\t\treturn Mavo.Primitive.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t});\n\n\t\t\tret.presentational = ret.presentational.length === 1? ret.presentational[0] : ret.presentational.join(\"\");\n\t\t}\n\n\t\tret.value = ret.value.length === 1? ret.value[0] : ret.value.join(\"\");\n\n\t\tif (this.primitive && this.parsed.length === 1) {\n\t\t\tif (typeof ret.value === \"number\") {\n\t\t\t\tthis.primitive.datatype = \"number\";\n\t\t\t}\n\t\t\telse if (typeof ret.value === \"boolean\") {\n\t\t\t\tthis.primitive.datatype = \"boolean\";\n\t\t\t}\n\t\t}\n\n\t\tif (ret.presentational === ret.value) {\n\t\t\tret = ret.value;\n\t\t}\n\n\t\tif (this.primitive) {\n\t\t\tthis.primitive.value = ret;\n\t\t}\n\t\telse {\n\t\t\tMavo.Primitive.setValue(this.node, ret, {attribute: this.attribute});\n\t\t}\n\n\t\tMavo.hooks.run(\"expressiontext-update-end\", this);\n\t},\n\n\tstatic: {\n\t\telements: new WeakMap(),\n\n\t\t/**\n\t\t * Search for Mavo.ExpressionText object(s) associated with a given element\n\t\t * and optionally an attribute.\n\t\t *\n\t\t * @return If one argument, array of matching ExpressionText objects.\n\t\t *         If two arguments, the matching ExpressionText object or null\n\t\t */\n\t\tsearch: function(element, attribute) {\n\t\t\tvar all = _.elements.get(element) || [];\n\n\t\t\tif (arguments.length > 1) {\n\t\t\t\tif (!all.length) {\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\n\t\t\t\treturn all.filter(et => et.attribute === attribute)[0] || null;\n\t\t\t}\n\n\t\t\treturn all;\n\t\t}\n\t}\n});\n\n// Link primitive with its expressionText object\nMavo.hooks.add(\"primitive-init-start\", function() {\n\tthis.expressionText = Mavo.ExpressionText.search(this.element, this.attribute);\n\n\tif (this.expressionText) {\n\t\tthis.expressionText.primitive = this;\n\t\tthis.store = this.store || \"none\";\n\t\tthis.modes = \"read\";\n\t}\n});\n\n})(Bliss);\n","(function($, $$) {\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\n\t\tthis.expressions = [];\n\n\t\tvar syntax = Mavo.Expression.Syntax.create(this.mavo.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\tthis.traverse(this.mavo.element, undefined, syntax);\n\n\t\tthis.scheduled = new Set();\n\n\t\t// Watch changes and update value\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tfor (let et of this.expressions) {\n\t\t\t\tet.item = Mavo.Node.get(et.element.closest(Mavo.selectors.multiple + \", \" + Mavo.selectors.group));\n\t\t\t\tet.item.expressions = et.item.expressions || [];\n\t\t\t\tet.item.expressions.push(et);\n\n\t\t\t\tvar mavoNode = Mavo.Node.get(et.element, true);\n\n\t\t\t\tif (mavoNode && mavoNode instanceof Mavo.Primitive && mavoNode.attribute == et.attribute) {\n\t\t\t\t\tet.primitive = mavoNode;\n\t\t\t\t\tmavoNode.store = mavoNode.store || \"none\";\n\t\t\t\t\tmavoNode.modes = \"read\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.mavo.element.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t\tif (evt.action == \"propertychange\" && evt.node.closestCollection) {\n\t\t\t\t\t// Throttle propertychange events in collections\n\t\t\t\t\tif (!this.scheduled.has(evt.property)) {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tthis.scheduled.delete(evt.property);\n\t\t\t\t\t\t\tthis.update(evt);\n\t\t\t\t\t\t}, _.PROPERTYCHANGE_THROTTLE);\n\n\t\t\t\t\t\tthis.scheduled.add(evt.property);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\trequestAnimationFrame(() => this.update(evt));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.update();\n\t\t});\n\t},\n\n\tupdate: function callee(evt) {\n\t\tvar root, rootGroup;\n\n\t\tif (evt instanceof Element) {\n\t\t\troot = evt.closest(Mavo.selectors.group);\n\t\t\tevt = null;\n\t\t}\n\n\t\troot = root || this.mavo.element;\n\t\trootGroup = Mavo.Node.get(root);\n\n\t\tvar data = rootGroup.getData({\n\t\t\trelative: true,\n\t\t\tstore: \"*\",\n\t\t\tnull: true,\n\t\t\tunhandled: this.mavo.unhandled\n\t\t});\n\n\t\trootGroup.walk((obj, path) => {\n\t\t\tif (obj.expressions && obj.expressions.length && !obj.isDeleted()) {\n\t\t\t\tlet env = { context: this, data: $.value(data, ...path) };\n\n\t\t\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\n\t\t\t\tfor (let et of obj.expressions) {\n\t\t\t\t\tif (et.changedBy(evt)) {\n\t\t\t\t\t\tet.update(env.data, evt);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.expressions.push(new Mavo.ExpressionText({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: path? path.slice(1).split(\"/\").map(i => +i) : [],\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\telse {\n\t\t\tnode.normalize();\n\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (Mavo.is(\"multiple\", node)) {\n\t\t\t\tpath = \"\";\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: [],\n\n\t\tPROPERTYCHANGE_THROTTLE: 50,\n\n\t\tdirective: function(name, o) {\n\t\t\t_.directives.push(name);\n\t\t\tMavo.attributes.push(name);\n\n\t\t\tMavo.plugin(o);\n\t\t}\n\t}\n});\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.relative && (env.data && typeof env.data === \"object\" || this.collection)) {\n\t\t\tvar data = env.data;\n\n\t\t\tif (this instanceof Mavo.Primitive) {\n\t\t\t\tenv.data = {\n\t\t\t\t\t[Symbol.toPrimitive]: () => data,\n\t\t\t\t\t[this.property]: data\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\treturn data[property] = (this.index || 0) + 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$all\") {\n\t\t\t\t\t\treturn data[property] = this.closestCollection? this.closestCollection.getData(env.options) : [env.data];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$next\" || property == \"$previous\") {\n\t\t\t\t\t\tif (this.closestCollection) {\n\t\t\t\t\t\t\treturn data[property] = this.closestCollection.getData(env.options)[this.index + (property == \"$next\"? 1 : -1)];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn data[property] = null;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == this.mavo.id) {\n\t\t\t\t\t\treturn data[property] = this.mavo.root.getData(env.options);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this instanceof Mavo.Group && property == this.property && this.collection) {\n\t\t\t\t\t\treturn data[property] = env.data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn group.children[property];\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret === undefined) {\n\t\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\t\tret = this.find(property);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\t\tret = ret.getData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You can’t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nMavo.hooks.add(\"init-tree-before\", function() {\n\tthis.expressions = new Mavo.Expressions(this);\n});\n\n// Must be at a hook that collections don't have a marker yet which messes up paths\nMavo.hooks.add(\"node-init-end\", function() {\n\tvar template = this.template;\n\n\tif (template && template.expressions) {\n\t\t// We know which expressions we have, don't traverse again\n\t\tthis.expressions = template.expressions.map(et => new Mavo.ExpressionText({\n\t\t\ttemplate: et,\n\t\t\titem: this,\n\t\t\tmavo: this.mavo\n\t\t}));\n\t}\n});\n\n// TODO what about granular rendering?\nMavo.hooks.add(\"render-end\", function() {\n\tthis.expressions.update();\n});\n\nMavo.hooks.add(\"collection-add-end\", function(env) {\n\tthis.mavo.expressions.update(env.item.element);\n});\n\n})(Bliss, Bliss.$);\n\n// mv-value plugin\nMavo.Expressions.directive(\"mv-value\", {\n\thooks: {\n\t\t\"expressiontext-init-start\": function() {\n\t\t\tif (this.attribute == \"mv-value\") {\n\t\t\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\t\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\t\t\tthis.expression = this.element.getAttribute(\"mv-value\");\n\n\t\t\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\t\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\t\t\t}\n\t\t}\n\t}\n});\n","// mv-if plugin\n(function($, $$) {\n\nMavo.Expressions.directive(\"mv-if\", {\n\textend: {\n\t\t\"Primitive\": {\n\t\t\tlive: {\n\t\t\t\t\"hidden\": function(value) {\n\t\t\t\t\tif (this._hidden !== value) {\n\t\t\t\t\t\tthis._hidden = value;\n\t\t\t\t\t\tthis.dataChanged();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\t\"ExpressionText\": {\n\t\t\tlazy: {\n\t\t\t\t\"childProperties\": function() {\n\t\t\t\t\tif (this.attribute != \"mv-if\") {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tvar properties = $$(Mavo.selectors.property, this.element)\n\t\t\t\t\t\t\t\t\t.filter(el => el.closest(\"[mv-if]\") == this.element)\n\t\t\t\t\t\t\t\t\t.map(el => Mavo.Node.get(el));\n\n\t\t\t\t\t// When the element is detached, datachange events from properties\n\t\t\t\t\t// do not propagate up to the group so expressions do not recalculate.\n\t\t\t\t\t// We must do this manually.\n\t\t\t\t\tthis.element.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t\t\t\t// Cannot redispatch synchronously [why??]\n\t\t\t\t\t\trequestAnimationFrame(() => {\n\t\t\t\t\t\t\tif (!this.element.parentNode) { // out of the DOM?\n\t\t\t\t\t\t\tthis.item.element.dispatchEvent(evt);\n\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\treturn properties;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\thooks: {\n\t\t\"expressiontext-init-start\": function() {\n\t\t\tif (this.attribute != \"mv-if\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.expression = this.element.getAttribute(\"mv-if\");\n\t\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\n\t\t\tthis.parentIf = this.element.parentNode && Mavo.ExpressionText.search(this.element.parentNode.closest(\"[mv-if]\"), \"mv-if\");\n\n\t\t\tif (this.parentIf) {\n\t\t\t\tthis.parentIf.childIfs = (this.parentIf.childIfs || new Set()).add(this);\n\t\t\t}\n\t\t},\n\t\t\"expressiontext-update-end\": function() {\n\t\t\tif (this.attribute != \"mv-if\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar value = this.value[0];\n\t\t\tvar oldValue = this.oldValue[0];\n\n\t\t\t// Only apply this after the tree is built, otherwise any properties inside the if will go missing!\n\t\t\tthis.item.mavo.treeBuilt.then(() => {\n\t\t\t\tif (this.parentIf) {\n\t\t\t\t\tvar parentValue = this.parentIf.value[0];\n\t\t\t\t\tthis.value[0] = value = value && parentValue;\n\t\t\t\t}\n\n\t\t\t\tif (value === oldValue) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (parentValue !== false) { // If parent if was false, it wouldn't matter whether this is in the DOM or not\n\t\t\t\t\tif (value) {\n\t\t\t\t\t\tif (this.comment && this.comment.parentNode) {\n\t\t\t\t\t\t\t// Is removed from the DOM and needs to get back\n\t\t\t\t\t\t\tthis.comment.parentNode.replaceChild(this.element, this.comment);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse if (this.element.parentNode) {\n\t\t\t\t\t\t// Is in the DOM and needs to be removed\n\t\t\t\t\t\tif (!this.comment) {\n\t\t\t\t\t\t\tthis.comment = document.createComment(\"mv-if\");\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.element.parentNode.replaceChild(this.comment, this.element);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// Mark any properties inside as hidden or not\n\t\t\t\tif (this.childProperties) {\n\t\t\t\t\tfor (let property of this.childProperties) {\n\t\t\t\t\t\tproperty.hidden = !value;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (this.childIfs) {\n\t\t\t\t\tfor (let childIf of this.childIfs) {\n\t\t\t\t\t\tchildIf.update();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\t\"unit-isdatanull\": function(env) {\n\t\t\tenv.result = env.result || (this.hidden && env.options.store == \"*\");\n\t\t}\n\t}\n});\n\n})(Bliss, Bliss.$);\n","/**\n * Functions available inside Mavo expressions\n */\n\n(function() {\n\nvar _ = Mavo.Functions = {\n\toperators: {\n\t\t\"=\": \"eq\"\n\t},\n\n\tget $now() {\n\t\treturn new Date();\n\t},\n\n\turlOption: function(...names) {\n\t\tvar searchParams = \"searchParams\" in URL.prototype? new URL(location).searchParams : null;\n\t\tvar value = null;\n\n\t\tfor (let name of names) {\n\t\t\tif (searchParams) {\n\t\t\t\tvalue = searchParams.get(name);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tvar match = location.search.match(RegExp(`[?&]${name}(?:=([^&]+))?(?=&|$)`, \"i\"));\n\t\t\t\tvalue = match && (match[1] || \"\");\n\t\t\t}\n\n\t\t\tif (value !== null) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t},\n\n\t/**\n\t * Get a property of an object. Used by the . operator to prevent TypeErrors\n\t */\n\tget: function(obj, property) {\n\t\treturn obj && obj[property] !== undefined? obj[property] : null;\n\t},\n\n\t/*********************\n\t * Number functions\n\t *********************/\n\n\t/**\n\t * Aggregate sum\n\t */\n\tsum: function(array) {\n\t\treturn numbers(array, arguments).reduce((prev, current) => {\n\t\t\treturn +prev + (+current || 0);\n\t\t}, 0);\n\t},\n\n\t/**\n\t * Average of an array of numbers\n\t */\n\taverage: function(array) {\n\t\tarray = numbers(array, arguments);\n\n\t\treturn array.length && _.sum(array) / array.length;\n\t},\n\n\t/**\n\t * Min of an array of numbers\n\t */\n\tmin: function(array) {\n\t\treturn Math.min(...numbers(array, arguments));\n\t},\n\n\t/**\n\t * Max of an array of numbers\n\t */\n\tmax: function(array) {\n\t\treturn Math.max(...numbers(array, arguments));\n\t},\n\n\tcount: function(array) {\n\t\treturn Mavo.toArray(array).filter(a => a !== null && a !== false && a !== \"\").length;\n\t},\n\n\tround: function(num, decimals) {\n\t\tif (!num || !decimals || !isFinite(num)) {\n\t\t\treturn Math.round(num);\n\t\t}\n\n\t\treturn +num.toLocaleString(\"en-US\", {\n\t\t\tuseGrouping: false,\n\t\t\tmaximumFractionDigits: decimals\n\t\t});\n\t},\n\n\tiff: function(condition, iftrue, iffalse=\"\") {\n\t\tif (Array.isArray(condition)) {\n\t\t\treturn condition.map((c, i) => {\n\t\t\t\tvar ret = c? iftrue : iffalse;\n\n\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\treturn ret[Math.min(i, ret.length - 1)];\n\t\t\t\t}\n\n\t\t\t\treturn ret;\n\t\t\t});\n\t\t}\n\n\t\treturn condition? iftrue : iffalse;\n\t},\n\n\t/*********************\n\t * String functions\n\t *********************/\n\n\t/**\n\t * Replace all occurences of a string with another string\n\t */\n\treplace: function(haystack, needle, replacement, iterations = 1) {\n\t\tif (Array.isArray(haystack)) {\n\t\t\treturn haystack.map(item => _.replace(item, needle, replacement));\n\t\t}\n\n\t\t// Simple string replacement\n\t\tvar needleRegex = RegExp(Mavo.escapeRegExp(needle), \"g\");\n\t\tvar ret = haystack, prev;\n\t\tvar counter = 0;\n\n\t\twhile (ret != prev && (counter++ < iterations)) {\n\t\t\tprev = ret; // foo\n\t\t\tret = ret.replace(needleRegex, replacement); // fo\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tjoin: function(array, glue = \"\") {\n\t\treturn Mavo.toArray(array).join(glue);\n\t},\n\n\tidify: readable => ((readable || \"\") + \"\")\n\t\t.replace(/\\s+/g, \"-\") // Convert whitespace to hyphens\n\t\t.replace(/[^\\w-]/g, \"\") // Remove weird characters\n\t\t.toLowerCase(),\n\n\tuppercase: str => (str + \"\").toUpperCase(),\n\tlowercase: str => (str + \"\").toLowerCase(),\n};\n\nMavo.Script = {\n\taddUnaryOperator: function(name, o) {\n\t\treturn operand => Array.isArray(operand)? operand.map(o.scalar) : o.scalar(operand);\n\t},\n\n\t/**\n\t * Extend a scalar operator to arrays, or arrays and scalars\n\t * The operation between arrays is applied element-wise.\n\t * The operation operation between a scalar and an array will result in\n\t * the operation being applied between the scalar and every array element.\n\t */\n\taddBinaryOperator: function(name, o) {\n\t\tif (o.symbol) {\n\t\t\t// Build map of symbols to function names for easy rewriting\n\t\t\tfor (let symbol of Mavo.toArray(o.symbol)) {\n\t\t\t\tMavo.Script.symbols[symbol] = name;\n\t\t\t}\n\t\t}\n\n\t\to.identity = o.identity === undefined? 0 : o.identity;\n\n\t\treturn _[name] = o.code || function(...operands) {\n\t\t\tif (operands.length === 1) {\n\t\t\t\tif (Array.isArray(operands[0])) {\n\t\t\t\t\t// Operand is an array of operands, expand it out\n\t\t\t\t\toperands = [...operands[0]];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tvar prev = o.logical? o.identity : operands[0], result;\n\n\t\t\tfor (let i = 1; i < operands.length; i++) {\n\t\t\t\tlet a = o.logical? operands[i - 1] : prev;\n\t\t\t\tlet b = operands[i];\n\n\t\t\t\tif (Array.isArray(b)) {\n\t\t\t\t\tif (typeof o.identity == \"number\") {\n\t\t\t\t\t\tb = numbers(b);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (Array.isArray(a)) {\n\t\t\t\t\t\tresult = [\n\t\t\t\t\t\t\t...b.map((n, i) => o.scalar(a[i] === undefined? o.identity : a[i], n)),\n\t\t\t\t\t\t\t...a.slice(b.length)\n\t\t\t\t\t\t];\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tresult = b.map(n => o.scalar(a, n));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Operand is scalar\n\t\t\t\t\tif (typeof o.identity == \"number\") {\n\t\t\t\t\t\tb = +b;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (Array.isArray(a)) {\n\t\t\t\t\t\tresult = a.map(n => o.scalar(n, b));\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tresult = o.scalar(a, b);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (o.reduce) {\n\t\t\t\t\tprev = o.reduce(prev, result, a, b);\n\t\t\t\t}\n\t\t\t\telse if (o.logical) {\n\t\t\t\t\tprev = prev && result;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tprev = result;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn prev;\n\t\t};\n\t},\n\n\t/**\n\t * Mapping of operator symbols to function name.\n\t * Populated via addOperator() and addLogicalOperator()\n\t */\n\tsymbols: {},\n\n\tgetOperatorName: op => Mavo.Script.symbols[op] || op,\n\n\t/**\n\t * Operations for elements and scalars.\n\t * Operations between arrays happen element-wise.\n\t * Operations between a scalar and an array will result in the operation being performed between the scalar and every array element.\n\t * Ordered by precedence (higher to lower)\n\t * @param scalar {Function} The operation between two scalars\n\t * @param identity The operation’s identity element. Defaults to 0.\n\t */\n\toperators: {\n\t\t\"not\": {\n\t\t\tscalar: a => a => !a\n\t\t},\n\t\t\"multiply\": {\n\t\t\tscalar: (a, b) => a * b,\n\t\t\tidentity: 1,\n\t\t\tsymbol: \"*\"\n\t\t},\n\t\t\"divide\": {\n\t\t\tscalar: (a, b) => a / b,\n\t\t\tidentity: 1,\n\t\t\tsymbol: \"/\"\n\t\t},\n\t\t\"add\": {\n\t\t\tscalar: (a, b) => +a + +b,\n\t\t\tsymbol: \"+\"\n\t\t},\n\t\t\"subtract\": {\n\t\t\tscalar: (a, b) => a - b,\n\t\t\tsymbol: \"-\"\n\t\t},\n\t\t\"mod\": {\n\t\t\tscalar: (a, b) => a % b\n\t\t},\n\t\t\"lte\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a <= b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \"<=\"\n\t\t},\n\t\t\"lt\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a < b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \"<\"\n\t\t},\n\t\t\"gte\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a >= b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \">=\"\n\t\t},\n\t\t\"gt\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => {\n\t\t\t\t[a, b] = Mavo.Script.getNumericalOperands(a, b);\n\t\t\t\treturn a > b;\n\t\t\t},\n\t\t\tidentity: true,\n\t\t\tsymbol: \">\"\n\t\t},\n\t\t\"eq\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => a == b,\n\t\t\tsymbol: [\"=\", \"==\"],\n\t\t\tidentity: true\n\t\t},\n\t\t\"neq\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => a != b,\n\t\t\tsymbol: [\"!=\"],\n\t\t\tidentity: true\n\t\t},\n\t\t\"and\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => !!a && !!b,\n\t\t\tidentity: true,\n\t\t\tsymbol: \"&&\"\n\t\t},\n\t\t\"or\": {\n\t\t\tlogical: true,\n\t\t\tscalar: (a, b) => !!a || !!b,\n\t\t\treduce: (p, r) => p || r,\n\t\t\tidentity: false,\n\t\t\tsymbol: \"||\"\n\t\t},\n\t\t\"concatenate\": {\n\t\t\tsymbol: \"&\",\n\t\t\tidentity: \"\",\n\t\t\tscalar: (a, b) => \"\" + a + b\n\t\t},\n\t\t\"filter\": {\n\t\t\tscalar: (a, b) => b? a : null\n\t\t}\n\t},\n\n\tgetNumericalOperands: function(a, b) {\n\t\tif (isNaN(a) || isNaN(b)) {\n\t\t\t// Try comparing as dates\n\t\t\tvar da = new Date(a), db = new Date(b);\n\n\t\t\tif (!isNaN(da) && !isNaN(db)) {\n\t\t\t\t// Both valid dates\n\t\t\t\treturn [da, db];\n\t\t\t}\n\t\t}\n\n\t\treturn [a, b];\n\t}\n};\n\nfor (let name in Mavo.Script.operators) {\n\tlet details = Mavo.Script.operators[name];\n\n\tif (details.scalar.length < 2) {\n\t\tMavo.Script.addUnaryOperator(name, details);\n\t}\n\telse {\n\t\tMavo.Script.addBinaryOperator(name, details);\n\t}\n}\n\nvar aliases = {\n\taverage: \"avg\",\n\tiff: \"iff IF\",\n\tsubtract: \"minus\",\n\tmultiply: \"mult product\",\n\tdivide: \"div\",\n\tlt: \"lessThan smaller\",\n\tgt: \"moreThan greater greaterThan bigger\",\n\teq: \"equal equality\"\n};\n\nfor (let name in aliases) {\n\taliases[name].split(/\\s+/g).forEach(alias => _[alias] = _[name]);\n}\n\n// Make function names case insensitive\nMavo.Functions._Trap = self.Proxy? new Proxy(_, {\n\tget: (functions, property) => {\n\t\tif (property in functions) {\n\t\t\treturn functions[property];\n\t\t}\n\n\t\tvar propertyL = property.toLowerCase && property.toLowerCase();\n\n\t\tif (propertyL && functions.hasOwnProperty(propertyL)) {\n\t\t\treturn functions[propertyL];\n\t\t}\n\n\t\tif (property in Math || propertyL in Math) {\n\t\t\treturn Math[property] || Math[propertyL];\n\t\t}\n\n\t\tif (property in self) {\n\t\t\treturn self[property];\n\t\t}\n\n\t\t// Prevent undefined at all costs\n\t\treturn property;\n\t},\n\n\t// Super ugly hack, but otherwise data is not\n\t// the local variable it should be, but the string \"data\"\n\t// so all property lookups fail.\n\thas: (functions, property) => property != \"data\"\n}) : Mavo.Functions;\n\n/**\n * Private helper methods\n */\nfunction numbers(array, args) {\n\tarray = Array.isArray(array)? array : (args? $$(args) : [array]);\n\n\treturn array.filter(number => !isNaN(number) && number !== \"\").map(n => +n);\n}\n\n})();\n","/*\nCopyright (c) 2009 James Padolsey.  All rights reserved.\n\nRedistribution and use in source and binary forms, with or without\nmodification, are permitted provided that the following conditions\nare met:\n\n   1. Redistributions of source code must retain the above copyright\n\t  notice, this list of conditions and the following disclaimer.\n\n   2. Redistributions in binary form must reproduce the above copyright\n\t  notice, this list of conditions and the following disclaimer in the\n\t  documentation and/or other materials provided with the distribution.\n\nTHIS SOFTWARE IS PROVIDED BY James Padolsey ``AS IS\"\" AND\nANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\nIMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE\nARE DISCLAIMED. IN NO EVENT SHALL James Padolsey OR CONTRIBUTORS BE LIABLE\nFOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL\nDAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR\nSERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER\nCAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT\nLIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY\nOUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF\nSUCH DAMAGE.\n\nThe views and conclusions contained in the software and documentation are\nthose of the authors and should not be interpreted as representing official\npolicies, either expressed or implied, of James Padolsey.\n\n AUTHOR James Padolsey (http://james.padolsey.com)\n VERSION 1.03.0\n UPDATED 29-10-2011\n CONTRIBUTORS\n\tDavid Waller\n    Benjamin Drucker\n\n*/\n\nvar prettyPrint = (function() {\n\n\t/* These \"util\" functions are not part of the core\n\t   functionality but are  all necessary - mostly DOM helpers */\n\n\tvar util = {\n\n\t\ttxt: function(t) {\n\t\t\t/* Create text node */\n\t\t\tt = t + \"\";\n\t\t\treturn document.createTextNode(t);\n\t\t},\n\n\t\trow: function(cells, type, cellType) {\n\n\t\t\t/* Creates new <tr> */\n\t\t\tcellType = cellType || \"td\";\n\n\t\t\t/* colSpan is calculated by length of null items in array */\n\t\t\tvar colSpan = util.count(cells, null) + 1,\n\t\t\t\ttr = $.create(\"tr\"), td,\n\t\t\t\tattrs = {\n\t\t\t\t\tcolSpan: colSpan\n\t\t\t\t};\n\n\t\t\t$$(cells).forEach(function(cell) {\n\t\t\t\tif (cell === null) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t/* Default cell type is <td> */\n\t\t\t\ttd = $.create(cellType, attrs);\n\n\t\t\t\tif (cell.nodeType) {\n\t\t\t\t\t/* IsDomElement */\n\t\t\t\t\ttd.appendChild(cell);\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t/* IsString */\n\t\t\t\t\ttd.innerHTML = util.shorten(cell.toString());\n\t\t\t\t}\n\n\t\t\t\ttr.appendChild(td);\n\t\t\t});\n\n\t\t\treturn tr;\n\t\t},\n\n\t\thRow: function(cells, type) {\n\t\t\t/* Return new <th> */\n\t\t\treturn util.row(cells, type, \"th\");\n\t\t},\n\n\t\ttable: function(headings, type) {\n\n\t\t\theadings = headings || [];\n\n\t\t\t/* Creates new table: */\n\t\t\tvar tbl = $.create(\"table\");\n\t\t\tvar thead = $.create(\"thead\");\n\t\t\tvar tbody = $.create(\"tbody\");\n\n\t\t\ttbl.classList.add(type);\n\n\t\t\tif (headings.length) {\n\t\t\t\ttbl.appendChild(thead);\n\t\t\t\tthead.appendChild( util.hRow(headings, type) );\n\t\t\t}\n\n\t\t\ttbl.appendChild(tbody);\n\n\t\t\treturn {\n\t\t\t\t/* Facade for dealing with table/tbody\n\t\t\t\t   Actual table node is this.node: */\n\t\t\t\tnode: tbl,\n\t\t\t\ttbody: tbody,\n\t\t\t\tthead: thead,\n\t\t\t\tappendChild: function(node) {\n\t\t\t\t\tthis.tbody.appendChild(node);\n\t\t\t\t},\n\t\t\t\taddRow: function(cells, _type, cellType) {\n\t\t\t\t\tthis.appendChild(util.row(cells, (_type || type), cellType));\n\t\t\t\t\treturn this;\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\tshorten: function(str) {\n\t\t\tvar max = 40;\n\t\t\tstr = str.replace(/^\\s\\s*|\\s\\s*$|\\n/g, \"\");\n\t\t\treturn str.length > max ? (str.substring(0, max-1) + \"...\") : str;\n\t\t},\n\n\t\thtmlentities: function(str) {\n\t\t\treturn str.replace(/&/g, \"&amp;\").replace(/</g, \"&lt;\").replace(/>/g, \"&gt;\");\n\t\t},\n\n\t\tcount: function(arr, item) {\n\t\t\tvar count = 0;\n\t\t\tfor (var i = 0, l = arr.length; i< l; i++) {\n\t\t\t\tif (arr[i] === item) {\n\t\t\t\t\tcount++;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn count;\n\t\t},\n\n\t\tthead: function(tbl) {\n\t\t\treturn tbl.getElementsByTagName(\"thead\")[0];\n\t\t},\n\n\t\twithin: function(ref) {\n\t\t\t/* Check existence of a val within an object\n\t\t\t   RETURNS KEY */\n\t\t\treturn {\n\t\t\t\tis: function(o) {\n\t\t\t\t\tfor (var i in ref) {\n\t\t\t\t\t\tif (ref[i] === o) {\n\t\t\t\t\t\t\treturn i;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\treturn \"\";\n\t\t\t\t}\n\t\t\t};\n\t\t},\n\n\t\tcommon: {\n\t\t\tcircRef: function(obj, key, settings) {\n\t\t\t\treturn util.expander(\n\t\t\t\t\t\"[POINTS BACK TO <strong>\" + (key) + \"</strong>]\",\n\t\t\t\t\t\"Click to show this item anyway\",\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tthis.parentNode.appendChild(prettyPrintThis(obj, {maxDepth:1}));\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t},\n\t\t\tdepthReached: function(obj, settings) {\n\t\t\t\treturn util.expander(\n\t\t\t\t\t\"[DEPTH REACHED]\",\n\t\t\t\t\t\"Click to show this item anyway\",\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tthis.parentNode.appendChild( prettyPrintThis(obj, {maxDepth:1}) );\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (e) {\n\t\t\t\t\t\t\tthis.parentNode.appendChild(\n\t\t\t\t\t\t\t\tutil.table([\"ERROR OCCURED DURING OBJECT RETRIEVAL\"], \"error\").addRow([e.message]).node\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t);\n\t\t\t}\n\t\t},\n\n\t\texpander: function(text, title, clickFn) {\n\t\t\treturn $.create(\"a\", {\n\t\t\t\tinnerHTML:  util.shorten(text) + ' <b style=\"visibility:hidden;\">[+]</b>',\n\t\t\t\ttitle: title,\n\t\t\t\tonmouseover: function() {\n\t\t\t\t\tthis.getElementsByTagName(\"b\")[0].style.visibility = \"visible\";\n\t\t\t\t},\n\t\t\t\tonmouseout: function() {\n\t\t\t\t\tthis.getElementsByTagName(\"b\")[0].style.visibility = \"hidden\";\n\t\t\t\t},\n\t\t\t\tonclick: function() {\n\t\t\t\t\tthis.style.display = \"none\";\n\t\t\t\t\tclickFn.call(this);\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\t\t\t\tstyle: {\n\t\t\t\t\tcursor: \"pointer\"\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t};\n\n\t// Main..\n\tvar prettyPrintThis = function(obj, options) {\n\n\t\t /*\n\t\t *\t  obj :: Object to be printed\n\t\t *  options :: Options (merged with config)\n\t\t */\n\n\t\toptions = options || {};\n\n\t\tvar settings = $.extend( {}, prettyPrintThis.config, options ),\n\t\t\tcontainer = $.create(\"div\"),\n\t\t\tconfig = prettyPrintThis.config,\n\t\t\tcurrentDepth = 0,\n\t\t\tstack = {},\n\t\t\thasRunOnce = false;\n\n\t\t/* Expose per-call settings.\n\t\t   Note: \"config\" is overwritten (where necessary) by options/\"settings\"\n\t\t   So, if you need to access/change *DEFAULT* settings then go via \".config\" */\n\t\tprettyPrintThis.settings = settings;\n\n\t\tvar typeDealer = {\n\t\t\tstring : function(item) {\n\t\t\t\treturn util.txt('\"' + util.shorten(item.replace(/\"/g, '\\\\\"')) + '\"');\n\t\t\t},\n\n\t\t\tobject : function(obj, depth, key) {\n\n\t\t\t\t/* Checking depth + circular refs */\n\t\t\t\t/* Note, check for circular refs before depth; just makes more sense */\n\t\t\t\tvar stackKey = util.within(stack).is(obj);\n\n\t\t\t\tif ( stackKey ) {\n\t\t\t\t\treturn util.common.circRef(obj, stackKey, settings);\n\t\t\t\t}\n\n\t\t\t\tstack[key||\"TOP\"] = obj;\n\n\t\t\t\tif (depth === settings.maxDepth) {\n\t\t\t\t\treturn util.common.depthReached(obj, settings);\n\t\t\t\t}\n\n\t\t\t\tvar table = util.table([\"Group\", null], \"object\"),\n\t\t\t\t\tisEmpty = true;\n\n\t\t\t\tfor (var i in obj) {\n\t\t\t\t\tif (!obj.hasOwnProperty || obj.hasOwnProperty(i)) {\n\t\t\t\t\t\tvar item = obj[i],\n\t\t\t\t\t\t\ttype = $.type(item);\n\t\t\t\t\t\tisEmpty = false;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\ttable.addRow([i, typeDealer[ type ](item, depth+1, i)], type);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcatch (e) {\n\t\t\t\t\t\t\t/* Security errors are thrown on certain Window/DOM properties */\n\t\t\t\t\t\t\tif (window.console && window.console.log) {\n\t\t\t\t\t\t\t\tconsole.log(e.message);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tvar ret = (settings.expanded || hasRunOnce) ? table.node : util.expander(\n\t\t\t\t\tJSON.stringify(obj),\n\t\t\t\t\t\"Click to show more\",\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tthis.parentNode.appendChild(table.node);\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t\thasRunOnce = true;\n\n\t\t\t\treturn ret;\n\n\t\t\t},\n\n\t\t\tarray : function(arr, depth, key, jquery) {\n\n\t\t\t\t/* Checking depth + circular refs */\n\t\t\t\t/* Note, check for circular refs before depth; just makes more sense */\n\t\t\t\tvar stackKey = util.within(stack).is(arr);\n\n\t\t\t\tif ( stackKey ) {\n\t\t\t\t\treturn util.common.circRef(arr, stackKey);\n\t\t\t\t}\n\n\t\t\t\tstack[key||\"TOP\"] = arr;\n\n\t\t\t\tif (depth === settings.maxDepth) {\n\t\t\t\t\treturn util.common.depthReached(arr);\n\t\t\t\t}\n\n\t\t\t\t/* Accepts a table and modifies it */\n\t\t\t\tvar table = util.table([\"List (\" + arr.length + \" items)\", null], \"list\");\n\t\t\t\tvar isEmpty = true;\n                var count = 0;\n\n\t\t\t\t$$(arr).forEach(function (item, i) {\n                    if (settings.maxArray >= 0 && ++count > settings.maxArray) {\n                        table.addRow([\n                            i + \"..\" + (arr.length-1),\n                            typeDealer[ $.type(item) ](\"...\", depth+1, i)\n                        ]);\n                        return false;\n                    }\n\t\t\t\t\tisEmpty = false;\n\t\t\t\t\ttable.addRow([i, typeDealer[ $.type(item) ](item, depth+1, i)]);\n\t\t\t\t});\n\n\t\t\t\treturn settings.expanded ? table.node : util.expander(\n\t\t\t\t\tJSON.stringify(arr),\n\t\t\t\t\t\"Click to show more\",\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tthis.parentNode.appendChild(table.node);\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t},\n\n\t\t\t\"date\" : function(date) {\n\n\t\t\t\tvar miniTable = util.table([\"Date\", null], \"date\"),\n\t\t\t\t\tsDate = date.toString().split(/\\s/);\n\n\t\t\t\t/* TODO: Make this work well in IE! */\n\t\t\t\tminiTable\n\t\t\t\t\t.addRow([\"Time\", sDate[4]])\n\t\t\t\t\t.addRow([\"Date\", sDate.slice(0, 4).join(\"-\")]);\n\n\t\t\t\treturn settings.expanded ? miniTable.node : util.expander(\n\t\t\t\t\t\"Date (timestamp): \" + (+date),\n\t\t\t\t\t\"Click to see a little more info about this date\",\n\t\t\t\t\tfunction() {\n\t\t\t\t\t\tthis.parentNode.appendChild(miniTable.node);\n\t\t\t\t\t}\n\t\t\t\t);\n\n\t\t\t}\n\t\t};\n\n\t\ttypeDealer.number =\n\t\ttypeDealer.boolean =\n\t\ttypeDealer.undefined =\n\t\ttypeDealer.null =\n\t\ttypeDealer.default = function(value) {\n\t\t\treturn util.txt(value);\n\t\t},\n\n\t\tcontainer.appendChild(typeDealer[$.type(obj)](obj, currentDepth));\n\n\t\treturn container;\n\n\t};\n\n\t/* Configuration */\n\n\t/* All items can be overwridden by passing an\n\t   \"options\" object when calling prettyPrint */\n\tprettyPrintThis.config = {\n\t\t/* Try setting this to false to save space */\n\t\texpanded: true,\n\n\t\tmaxDepth: 10,\n\t\tmaxArray: -1  // default is unlimited\n\t};\n\n\treturn prettyPrintThis;\n\n})();\n","(function($, $$) {\n\nvar _ = Mavo.Debug = {\n\tfriendlyError: (e, expr) => {\n\t\tvar type = e.constructor.name.replace(/Error$/, \"\").toLowerCase();\n\t\tvar message = e.message;\n\n\t\t// Friendlify common errors\n\n\t\t// Non-developers don't know wtf a token is.\n\t\tmessage = message.replace(/\\s+token\\s+/g, \" \");\n\n\t\tif (message == \"Unexpected }\" && !/[{}]/.test(expr)) {\n\t\t\tmessage = \"Missing a )\";\n\t\t}\n\t\telse if (message === \"Unexpected )\") {\n\t\t\tmessage = \"Missing a (\";\n\t\t}\n\t\telse if (message === \"Invalid left-hand side in assignment\") {\n\t\t\tmessage = \"Invalid assignment. Maybe you typed = instead of == ?\";\n\t\t}\n\t\telse if (message == \"Unexpected ILLEGAL\") {\n\t\t\tmessage = \"There is an invalid character somewhere.\";\n\t\t}\n\n\t\treturn `<span class=\"type\">Oh noes, a ${type} error!</span> ${message}`;\n\t},\n\n\telementLabel: function(element, attribute) {\n\t\tvar ret = element.nodeName.toLowerCase();\n\n\t\tif (element.hasAttribute(\"property\")) {\n\t\t\tret += `[property=${element.getAttribute(\"property\")}]`;\n\t\t}\n\t\telse if (element.id) {\n\t\t\tret += `#${element.id}`;\n\t\t}\n\t\telse if (element.classList.length) {\n\t\t\tret += $$(element.classList).map(c => `.${c}`).join(\"\");\n\t\t}\n\n\t\tif (attribute) {\n\t\t\tret += `@${attribute}`;\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tprintValue: function(obj) {\n\t\tvar ret;\n\n\t\tif (typeof obj !== \"object\" || obj === null) {\n\t\t\treturn typeof obj == \"string\"? `\"${obj}\"` : obj + \"\";\n\t\t}\n\n\t\tif (Array.isArray(obj)) {\n\t\t\tif (obj.length > 0) {\n\t\t\t\tif (typeof obj[0] === \"object\") {\n\t\t\t\t\treturn `List: ${obj.length} group(s)`;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn \"List: \" + obj.map(_.printValue).join(\", \");\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn \"List: (Empty)\";\n\t\t\t}\n\t\t}\n\n\t\tif (obj.constructor === Object) {\n\t\t\treturn `Group with ${Object.keys(obj).length} properties`;\n\t\t}\n\n\t\tif (obj instanceof Mavo.Primitive) {\n\t\t\treturn _.printValue(obj.value);\n\t\t}\n\t\telse if (obj instanceof Mavo.Collection) {\n\t\t\tif (obj.children.length > 0) {\n\t\t\t\tif (obj.children[0] instanceof Mavo.Group) {\n\t\t\t\t\treturn `List: ${obj.children.length} group(s)`;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\treturn \"List: \" + obj.children.map(_.printValue).join(\", \");\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\treturn _.printValue([]);\n\t\t\t}\n\t\t}\n\t\telse if (obj instanceof Mavo.Group) {\n\t\t\t// Group\n\t\t\treturn `Group with ${Object.keys(obj).length} properties`;\n\t\t}\n\t},\n\n\ttimed: function(id, callback) {\n\t\treturn function() {\n\t\t\tconsole.time(id);\n\t\t\tcallback.apply(this, arguments);\n\t\t\tconsole.timeEnd(id);\n\t\t};\n\t},\n\n\ttime: function callee(objName, name) {\n\t\tvar obj = eval(objName);\n\t\tconsole.log(`Benchmarking ${objName}.${name}(). Run console.log(${objName}.${name}.timeTaken, ${objName}.${name}.calls) at any time to see stats.`);\n\t\tvar callback = obj[name];\n\n\t\tobj[name] = function callee() {\n\t\t\tvar before = performance.now();\n\t\t\tvar ret = callback.apply(this, arguments);\n\t\t\tcallee.timeTaken += performance.now() - before;\n\t\t\tobj[name].calls++;\n\t\t\treturn ret;\n\t\t};\n\n\t\tobj[name].timeTaken = obj[name].calls = 0;\n\n\t\tcallee.all = callee.all || [];\n\t\tcallee.all.push({obj, objName, name});\n\n\t\treturn obj[name];\n\t},\n\n\ttimes: function() {\n\t\tif (!_.time.all) {\n\t\t\treturn;\n\t\t}\n\n\t\tconsole.table(_.time.all.map(o => {\n\t\t\treturn {\n\t\t\t\t\"Function\": `${o.objName}.${o.name}`,\n\t\t\t\t\"Time (ms)\": o.obj[o.name].timeTaken,\n\t\t\t\t\"Calls\": o.obj[o.name].calls\n\t\t\t};\n\t\t}));\n\t},\n\n\treservedWords: \"as|async|await|break|case|catch|class|const|continue|debugger|default|delete|do|else|enum|export|extends|finally|for|from|function|get|if|implements|import|in|instanceof|interface|let|new|null|of|package|private|protected|public|return|set|static|super|switch|this|throw|try|typeof|var|void|while|with|yield\".split(\"|\")\n};\n\nMavo.prototype.render = _.timed(\"render\", Mavo.prototype.render);\n\nMavo.selectors.debug = \".mv-debug\";\n\nvar selector = \", .mv-debuginfo\";\n\nStretchy.selectors.filter += selector;\n\n// Add element to show saved data\nMavo.hooks.add(\"init-tree-after\", function() {\n\tif (this.root.debug) {\n\t\tthis.element.classList.add(\"mv-debug-saving\");\n\t}\n\n\tif (this.store && this.element.classList.contains(\"mv-debug-saving\")) {\n\t\tvar element;\n\n\t\tvar details = $.create(\"details\", {\n\t\t\tclassName: \"mv-debug-storage\",\n\t\t\tcontents: [\n\t\t\t\t{tag: \"Summary\", textContent: \"Saved data\"},\n\t\t\t\telement = $.create(\"pre\", {id: this.id + \"-debug-storage\"})\n\t\t\t],\n\t\t\tafter: this.element\n\t\t});\n\n\t\tthis.element.addEventListener(\"mavo:save\", evt => {\n\t\t\telement.innerHTML = \"\";\n\n\t\t\telement.appendChild(prettyPrint(evt.data));\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"render-start\", function({data}) {\n\tif (this.backend && this.element.classList.contains(\"mv-debug-saving\")) {\n\t\tvar element = $(`#${this.id}-debug-storage`);\n\n\t\tif (element) {\n\t\t\telement.innerHTML = \"\";\n\n\t\t\tif (data) {\n\t\t\t\telement.appendChild(prettyPrint(data));\n\t\t\t}\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"group-init-start\", function() {\n\tthis.debug = this.debug || this.walkUp(group => {\n\t\tif (group.debug) {\n\t\t\treturn true;\n\t\t}\n\t}) || Mavo.Functions.urlOption(\"debug\") !== null;\n\n\tif (!this.debug && this.element.closest(Mavo.selectors.debug)) {\n\t\tthis.debug = true;\n\t}\n\n\tif (this.debug) {\n\t\tthis.debug = $.create(\"tbody\", {\n\t\t\tinside: $.create(\"table\", {\n\t\t\t\tinnerHTML: `<thead><tr>\n\t\t\t\t\t<th></th>\n\t\t\t\t\t<th>Expression</th>\n\t\t\t\t\t<th>Value</th>\n\t\t\t\t\t<th>Element</th>\n\t\t\t\t</tr></thead>`,\n\t\t\t\tstyle: {\n\t\t\t\t\tdisplay: \"none\"\n\t\t\t\t},\n\t\t\t\tinside: $.create(\"details\", {\n\t\t\t\t\tclassName: \"mv-ui mv-debuginfo\",\n\t\t\t\t\tinside: this.element,\n\t\t\t\t\tcontents: $.create(\"summary\", {\n\t\t\t\t\t\ttextContent: \"Debug\"\n\t\t\t\t\t}),\n\t\t\t\t\t\"mv-expressions\": \"none\"\n\t\t\t\t})\n\t\t\t})\n\t\t});\n\t}\n}, true);\n\nMavo.hooks.add(\"node-init-end\", function() {\n\tif (this.collection) {\n\t\tthis.debug = this.collection.debug;\n\t}\n});\n\nMavo.hooks.add(\"expression-eval-beforeeval\", function() {\n\tif (this.debug) {\n\t\tthis.debug.classList.remove(\"mv-error\");\n\t}\n});\n\nMavo.hooks.add(\"expression-eval-error\", function(env) {\n\tif (this.debug) {\n\t\tthis.debug.innerHTML = _.friendlyError(env.exception, env.expression);\n\t\tthis.debug.classList.add(\"mv-error\");\n\t}\n});\n\nMavo.Group.prototype.debugRow = function({element, attribute = null, tds = []}) {\n\tif (!this.debug) {\n\t\treturn;\n\t}\n\n\tthis.debug.parentNode.style.display = \"\";\n\n\tvar type = tds[0];\n\n\ttds[0] = $.create(\"td\", {\n\t\ttitle: type\n\t});\n\n\tif (!tds[3]) {\n\t\tvar elementLabel = _.elementLabel(element, attribute);\n\n\t\ttds[3] = $.create(\"td\", {\n\t\t\ttextContent: elementLabel,\n\t\t\ttitle: elementLabel,\n\t\t\tevents: {\n\t\t\t\t\"mouseenter mouseleave\": evt => {\n\t\t\t\t\telement.classList.toggle(\"mv-highlight\", evt.type === \"mouseenter\");\n\t\t\t\t},\n\t\t\t\t\"click\": evt => {\n\t\t\t\t\telement.scrollIntoView({behavior: \"smooth\"});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\ttds = tds.map(td => {\n\t\tif (!(td instanceof Node)) {\n\t\t\treturn $.create(\"td\", typeof td == \"object\"? td : { textContent: td });\n\t\t}\n\n\t\treturn td;\n\t});\n\n\tif (type == \"Warning\") {\n\t\ttds[1].setAttribute(\"colspan\", 2);\n\t}\n\n\tvar tr = $.create(\"tr\", {\n\t\tclassName: \"mv-debug-\" + type.toLowerCase(),\n\t\tcontents: tds,\n\t\tinside: this.debug\n\t});\n};\n\nMavo.hooks.add(\"expressiontext-init-end\", function() {\n\tif (this.mavo.debug) {\n\t\tthis.debug = {};\n\n\t\tthis.parsed.forEach(expr => {\n\t\t\tif (expr instanceof Mavo.Expression && !this.element.matches(\".mv-debuginfo *\")) {\n\t\t\t\tthis.group.debugRow({\n\t\t\t\t\telement: this.element,\n\t\t\t\t\tattribute: this.attribute,\n\t\t\t\t\ttds: [\"Expression\", {\n\t\t\t\t\t\t\ttag: \"td\",\n\t\t\t\t\t\t\tcontents: {\n\t\t\t\t\t\t\t\ttag: \"textarea\",\n\t\t\t\t\t\t\t\tvalue: expr.expression,\n\t\t\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\t\t\tinput: evt => {\n\t\t\t\t\t\t\t\t\t\texpr.expression = evt.target.value;\n\t\t\t\t\t\t\t\t\t\texpr.debug = evt.target.parentNode.nextElementSibling;\n\t\t\t\t\t\t\t\t\t\tthis.update(this.data);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\tonce: {\n\t\t\t\t\t\t\t\t\tfocus: evt => Stretchy.resize(evt.target)\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\texpr.debug = $.create(\"td\")\n\t\t\t\t\t]\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"group-init-end\", function() {\n\t// TODO make properties update, collapse duplicate expressions\n\tif (this.debug instanceof Node) {\n\t\t// We have a debug table, add stuff to it\n\n\t\tvar selector = Mavo.selectors.andNot(Mavo.selectors.multiple, Mavo.selectors.property);\n\t\t$$(selector, this.element).forEach(element => {\n\t\t\tthis.debugRow({\n\t\t\t\telement,\n\t\t\t\ttds: [\"Warning\", \"mv-multiple without a property attribute\"]\n\t\t\t});\n\t\t});\n\n\t\tthis.propagate(obj => {\n\t\t\tvar value = _.printValue(obj);\n\n\t\t\tthis.debugRow({\n\t\t\t\telement: obj.element,\n\t\t\t\ttds: [\"Property\", obj.property, obj.value]\n\t\t\t});\n\n\t\t\tif (_.reservedWords.indexOf(obj.property) > -1) {\n\t\t\t\tthis.debugRow({\n\t\t\t\t\telement: obj.element,\n\t\t\t\t\ttds: [\"Warning\", `You can’t use \"${obj.property}\" as a property name, it’s a reserved word.`]\n\t\t\t\t});\n\t\t\t}\n\t\t\telse if (/^\\d|[\\W$]/.test(obj.property)) {\n\t\t\t\tthis.debugRow({\n\t\t\t\t\telement: obj.element,\n\t\t\t\t\ttds: [\"Warning\", {\n\t\t\t\t\t\ttextContent: `You can’t use \"${obj.property}\" as a property name.`,\n\t\t\t\t\t\ttitle: \"Property names can only contain letters, numbers and underscores and cannot start with a number.\"\n\t\t\t\t\t}]\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\n\t\tthis.group.element.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t$$(\"tr.debug-property\", this.debug).forEach(tr => {\n\t\t\t\tvar property = tr.cells[1].textContent;\n\t\t\t\tvar value = _.printValue(this.children[property]);\n\n\t\t\t\tif (tr.cells[2]) {\n\t\t\t\t\tvar td = tr.cells[2];\n\t\t\t\t\ttd.textContent = td.title = value;\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t}\n});\n\nMavo.hooks.add(\"expressiontext-update-beforeeval\", function(env) {\n\tif (this.debug) {\n\t\tenv.td = env.expr.debug;\n\n\t\tif (env.td) {\n\t\t\tenv.td.classList.remove(\"mv-error\");\n\t\t}\n\t}\n});\n\nMavo.hooks.add(\"expressiontext-update-aftereval\", function(env) {\n\tif (env.td && !env.td.classList.contains(\"mv-error\")) {\n\t\tvar value = _.printValue(env.value);\n\t\tenv.td.textContent = env.td.title = value;\n\t}\n});\n\n//Mavo.Debug.time(\"Mavo.Expressions.prototype\", \"update\");\n\n})(Bliss, Bliss.$);\n","(function($) {\n\nif (!self.Mavo) {\n\treturn;\n}\n\nvar dropboxURL = \"//cdnjs.cloudflare.com/ajax/libs/dropbox.js/0.10.2/dropbox.min.js\";\n\nMavo.Backend.register($.Class({\n\textends: Mavo.Backend,\n\tid: \"Dropbox\",\n\tconstructor: function() {\n\t\t// Transform the dropbox shared URL into something raw and CORS-enabled\n\t\tthis.url = new URL(this.url, location);\n\n\t\tif (this.url.protocol != \"dropbox:\") {\n\t\t\tthis.url.hostname = \"dl.dropboxusercontent.com\";\n\t\t\tthis.url.search = this.url.search.replace(/\\bdl=0|^$/, \"raw=1\");\n\t\t\tthis.permissions.on(\"read\"); // TODO check if file actually is publicly readable\n\t\t}\n\n\t\tthis.permissions.on(\"login\");\n\n\t\tthis.ready = $.include(self.Dropbox, dropboxURL).then((() => {\n\t\t\tvar referrer = new URL(document.referrer, location);\n\n\t\t\tif (referrer.hostname === \"www.dropbox.com\" && location.hash.indexOf(\"#access_token=\") === 0) {\n\t\t\t\t// We’re in an OAuth response popup, do what you need then close this\n\t\t\t\tDropbox.AuthDriver.Popup.oauthReceiver();\n\t\t\t\t$.fire(window, \"load\"); // hack because dropbox.js didn't foresee use cases like ours :/\n\t\t\t\tclose();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.path = (this.mavo.element.getAttribute(\"mv-dropbox-path\") || \"\") + (new URL(this.url)).pathname.match(/[^/]*$/)[0];\n\n\t\t\tthis.key = this.mavo.element.getAttribute(\"mv-dropbox-key\") || \"fle6gsc61w5v79j\";\n\n\t\t\tthis.client = new Dropbox.Client({ key: this.key });\n\t\t})).then(() => {\n\t\t\tthis.login(true);\n\t\t});\n\t},\n\n\t/**\n\t * Saves a file to the backend.\n\t * @param {Object} file - An object with name & data keys\n\t * @return {Promise} A promise that resolves when the file is saved.\n\t */\n\tput: function(file = this.getFile()) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.client.writeFile(file.name, file.dataString, function(error, stat) {\n\t\t\t\tif (error) {\n\t\t\t\t\treturn reject(Error(error));\n\t\t\t\t}\n\n\t\t\t\tconsole.log(\"File saved as revision \" + stat.versionTag);\n\t\t\t\tresolve(file);\n\t\t\t});\n\t\t});\n\t},\n\n\tlogin: function(passive) {\n\t\treturn this.ready.then(() => {\n\t\t\treturn this.client.isAuthenticated()? Promise.resolve() : new Promise((resolve, reject) => {\n\t\t\t\tthis.client.authDriver(new Dropbox.AuthDriver.Popup({\n\t\t\t\t    receiverUrl: new URL(location) + \"\"\n\t\t\t\t}));\n\n\t\t\t\tthis.client.authenticate({interactive: !passive}, (error, client) => {\n\n\t\t\t\t\tif (error) {\n\t\t\t\t\t\treject(Error(error));\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this.client.isAuthenticated()) {\n\t\t\t\t\t\t// TODO check if can actually edit the file\n\t\t\t\t\t\tthis.permissions.on([\"logout\", \"edit\"]);\n\n\t\t\t\t\t\tresolve();\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tthis.permissions.off([\"logout\", \"edit\", \"add\", \"delete\"]);\n\n\t\t\t\t\t\treject();\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}).then(() => {\n\t\t\t// Not returning a promise here, since processes depending on login don't need to wait for this\n\t\t\tthis.client.getAccountInfo((error, accountInfo) => {\n\t\t\t\tif (!error) {\n\t\t\t\t\t$.fire(this.mavo.element, \"mavo:login\", $.extend({backend: this}, accountInfo));\n\t\t\t\t}\n\t\t\t});\n\t\t}).catch(() => {});\n\t},\n\n\tlogout: function() {\n\t\treturn !this.client.isAuthenticated()? Promise.resolve() : new Promise((resolve, reject) => {\n\t\t\tthis.client.signOut(null, () => {\n\t\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\"]).on(\"login\");\n\n\t\t\t\tthis.mavo.element._.fire(\"mavo:logout\", {backend: this});\n\t\t\t\tresolve();\n\t\t\t});\n\t\t});\n\n\t},\n\n\tstatic: {\n\t\ttest: function(url) {\n\t\t\turl = new URL(url, location);\n\t\t\treturn /dropbox.com/.test(url.host) || url.protocol === \"dropbox:\";\n\t\t}\n\t}\n}));\n\n})(Bliss);\n","(function($) {\n\nif (!self.Mavo) {\n\treturn;\n}\n\nvar _ = Mavo.Backend.register($.Class({\n\textends: Mavo.Backend,\n\tid: \"Github\",\n\tconstructor: function() {\n\t\tthis.permissions.on(\"login\");\n\n\t\tthis.key = this.mavo.element.getAttribute(\"mv-github-key\") || \"7e08e016048000bc594e\";\n\n\t\t// Extract info for username, repo, branch, filepath from URL\n\t\tthis.url = new URL(this.url, location);\n\t\t$.extend(this, _.parseURL(this.url));\n\t\tthis.repo = this.repo || \"mv-data\";\n\t\tthis.branch = this.branch || \"master\";\n\t\tthis.path = this.path || `${this.mavo.id}.json`;\n\n\t\tthis.permissions.on(\"read\"); // TODO check if file actually is publicly readable\n\n\t\tthis.login(true);\n\t},\n\n\tget authenticated () {\n\t\treturn !!this.accessToken;\n\t},\n\n\t/**\n\t * Helper method to make a request with the Github API\n\t */\n\treq: function(call, data, method = \"GET\", o = {method: method}) {\n\t\tif (data) {\n\t\t\to.data =  JSON.stringify(data);\n\t\t}\n\n\t\tvar request = $.extend(o, {\n\t\t\tresponseType: \"json\"\n\t\t});\n\n\t\tif (this.authenticated) {\n\t\t\trequest.headers = {\n\t\t\t\t\"Authorization\": `token ${this.accessToken}`\n\t\t\t};\n\t\t}\n\n\t\treturn $.fetch(\"https://api.github.com/\" + call, request)\n\t\t.catch(err => {\n\t\t\tif (err && err.xhr) {\n\t\t\t\treturn Promise.reject(err.xhr);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.mavo.error(\"Something went wrong while connecting to Github\", err);\n\t\t\t}\n\t\t})\n\t\t.then(xhr => Promise.resolve(xhr.response));\n\t},\n\n\tget: function() {\n\t\treturn this.req(`repos/${this.username}/${this.repo}/contents/${this.path}`)\n\t\t       .then(response => Promise.resolve(_.atob(response.content)));\n\t},\n\n\t/**\n\t * Saves a file to the backend.\n\t * @param {Object} file - An object with name & data keys\n\t * @return {Promise} A promise that resolves when the file is saved.\n\t */\n\tput: function(file = this.getFile()) {\n\t\tvar fileCall = `repos/${this.username}/${this.repo}/contents/${file.path}`;\n\n\t\treturn Promise.resolve(this.repoInfo || this.req(\"user/repos\", {\n\t\t\tname: this.repo\n\t\t}, \"POST\"))\n\t\t.then(repoInfo => {\n\t\t\tthis.repoInfo = repoInfo;\n\n\t\t\treturn this.req(fileCall, {\n\t\t\t\tref: this.branch\n\t\t\t});\n\t\t})\n\t\t.then(fileInfo => {\n\t\t\treturn this.req(fileCall, {\n\t\t\t\tmessage: `Updated ${file.name || \"file\"}`,\n\t\t\t\tcontent: _.btoa(file.dataString),\n\t\t\t\tbranch: this.branch,\n\t\t\t\tsha: fileInfo.sha\n\t\t\t}, \"PUT\").then(data => file);\n\t\t}, xhr => {\n\t\t\tif (xhr.status == 404) {\n\t\t\t\t// File does not exist, create it\n\t\t\t\treturn this.req(fileCall, {\n\t\t\t\t\tmessage: \"Created file\",\n\t\t\t\t\tcontent: _.btoa(file.dataString),\n\t\t\t\t\tbranch: this.branch\n\t\t\t\t}, \"PUT\");\n\t\t\t}\n\t\t\telse {\n\t\t\t\tthis.mavo.error(xhr.status? `HTTP error ${xhr.status}` : \"Can’t connect to the Internet\", xhr);\n\t\t\t}\n\n\t\t\treturn null;\n\t\t});\n\t},\n\n\tlogin: function(passive) {\n\t\treturn this.ready.then(() => {\n\t\t\tif (this.authenticated) {\n\t\t\t\treturn Promise.resolve();\n\t\t\t}\n\n\t\t\treturn (new Promise((resolve, reject) => {\n\t\t\t\tif (passive) {\n\t\t\t\t\tthis.accessToken = localStorage[\"mavo:githubtoken\"];\n\n\t\t\t\t\tif (this.accessToken) {\n\t\t\t\t\t\tresolve(this.accessToken);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\t// Show window\n\t\t\t\t\tvar popup = {\n\t\t\t\t\t\twidth: Math.min(1000, innerWidth - 100),\n\t\t\t\t\t\theight: Math.min(800, innerHeight - 100)\n\t\t\t\t\t};\n\n\t\t\t\t\tpopup.top = (innerHeight - popup.height)/2 + (screen.top || screenTop);\n\t\t\t\t\tpopup.left = (innerWidth - popup.width)/2 + (screen.left || screenLeft);\n\n\t\t\t\t\tthis.authPopup = open(`https://github.com/login/oauth/authorize?client_id=${this.key}&scope=repo,gist&state=${location.href}`,\n\t\t\t\t\t\t\"popup\", `width=${popup.width},height=${popup.height},left=${popup.left},top=${popup.top}`);\n\n\t\t\t\t\taddEventListener(\"message\", evt => {\n\t\t\t\t\t\tif (evt.source === this.authPopup) {\n\t\t\t\t\t\t\tthis.accessToken = localStorage[\"mavo:githubtoken\"] = evt.data;\n\n\t\t\t\t\t\t\tif (!this.accessToken) {\n\t\t\t\t\t\t\t\treject(Error(\"Authentication error\"));\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tresolve(this.accessToken);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}))\n\t\t\t.then(() => this.getUser())\n\t\t\t.catch(xhr => {\n\t\t\t\tif (xhr.status == 401) {\n\t\t\t\t\t// Unauthorized. Access token we have is invalid, discard it\n\t\t\t\t\tthis.logout();\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then(u => {\n\t\t\t\tif (this.user) {\n\t\t\t\t\tthis.permissions.on(\"logout\");\n\n\t\t\t\t\treturn this.req(`repos/${this.username}/${this.repo}`)\n\t\t\t\t\t\t.then(repoInfo => {\n\t\t\t\t\t\t\tthis.repoInfo = repoInfo;\n\n\t\t\t\t\t\t\tif (repoInfo.permissions.push) {\n\t\t\t\t\t\t\t\tthis.permissions.on([\"edit\", \"save\"]);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.catch(xhr => {\n\t\t\t\t\t\t\tif (xhr.status == 404) {\n\t\t\t\t\t\t\t\t// Repo does not exist so we can't check permissions\n\t\t\t\t\t\t\t\t// Just check if authenticated user is the same as our URL username\n\t\t\t\t\t\t\t\tif (this.user.login.toLowerCase() == this.username.toLowerCase()) {\n\t\t\t\t\t\t\t\t\tthis.permissions.on([\"edit\", \"save\"]);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t});\n\t},\n\n\tlogout: function() {\n\t\tif (this.authenticated) {\n\t\t\tlocalStorage.removeItem(\"mavo:githubtoken\");\n\t\t\tdelete this.accessToken;\n\n\t\t\tthis.permissions.off([\"edit\", \"add\", \"delete\", \"save\"]).on(\"login\");\n\n\t\t\tthis.mavo.element._.fire(\"mavo:logout\", {backend: this});\n\t\t}\n\n\t\treturn Promise.resolve();\n\t},\n\n\tgetUser: function() {\n\t\treturn this.req(\"user\").then(accountInfo => {\n\t\t\tthis.user = accountInfo;\n\n\t\t\tvar name = accountInfo.name || accountInfo.login;\n\t\t\t$.fire(this.mavo.element, \"mavo:login\", {\n\t\t\t\tbackend: this,\n\t\t\t\tname: `<a href=\"https://github.com/${accountInfo.login}\" target=\"_blank\">\n\t\t\t\t\t\t\t<img class=\"mv-avatar\" src=\"${accountInfo.avatar_url}\" /> ${name}\n\t\t\t\t\t\t</a>`\n\t\t\t});\n\t\t});\n\t},\n\n\tstatic: {\n\t\ttest: function(url) {\n\t\t\turl = new URL(url, location);\n\t\t\treturn /\\bgithub.(com|io)|raw.githubusercontent.com/.test(url.host);\n\t\t},\n\n\t\t/**\n\t\t * Parse Github URLs, return username, repo, branch, path\n\t\t */\n\t\tparseURL: function(url) {\n\t\t\tvar ret = {};\n\n\t\t\turl = new URL(url, location);\n\n\t\t\tvar path = url.pathname.slice(1).split(\"/\");\n\n\t\t\tif (/github.io$/.test(url.host)) {\n\t\t\t\tret.username = url.host.match(/([\\w-]+)\\.github\\.io$/)[1];\n\n\t\t\t\tif (path.length == 1) {\n\t\t\t\t\t// Heuristic to tell apart username.github.io repos from\n\t\t\t\t\t// other gh-pages repos. This is impossible to figure out without a request.\n\t\t\t\t\t// E.g. username.github.io/foo/bar.json could be either repo = username.github.io, path = foo/bar.json\n\t\t\t\t\t// or repo = foo, path = bar.json\n\t\t\t\t\tret.repo = url.host;\n\t\t\t\t\tret.path = path[0];\n\t\t\t\t\tret.branch = \"master\";\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tret.branch = \"gh-pages\";\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret.username = path.shift();\n\t\t\t}\n\n\t\t\tret.repo = path.shift();\n\n\t\t\tif (/raw.githubusercontent.com$/.test(url.host)) {\n\t\t\t\tret.branch = path.shift();\n\t\t\t}\n\t\t\telse if (/github.com$/.test(url.host) && path[0] == \"blob\") {\n\t\t\t\tpath.shift();\n\t\t\t\tret.branch = path.shift();\n\t\t\t}\n\n\t\t\tret.path = path.join(\"/\");\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t// Fix atob() and btoa() so they can handle Unicode\n\t\tbtoa: str => btoa(unescape(encodeURIComponent(str))),\n\t\tatob: str => decodeURIComponent(escape(window.atob(str)))\n\t}\n}));\n\n})(Bliss);\n"],"sourceRoot":"/source/"}