{"version":3,"sources":["primitive.js"],"names":[],"mappings":";;;;AAAA,CAAC,UAAS,CAAT,EAAY,EAAZ,EAAgB;;AAEjB,KAAI,IAAI,KAAK,SAAL,GAAiB,EAAE,KAAF,CAAQ;AAChC,WAAS,KAAK,IADkB;AAEhC,eAAa,qBAAU,OAAV,EAAmB,IAAnB,EAAyB,CAAzB,EAA4B;AAAA;;AACxC,OAAI,CAAC,KAAK,YAAL,CAAkB,WAAlB,EAA+B,UAA/B,EAA2C,eAA3C,EAA4D,eAA5D,CAAL,EAAmF;AAClF;AACA;AACA,SAAK,SAAL,GAAiB,EAAE,iBAAF,CAAoB,KAAK,OAAzB,CAAjB;;AAEA,QAAI,KAAK,SAAT,EAAoB;AACnB,UAAK,aAAL,GAAqB,KAAK,SAAL,CAAe,aAApC;AACA;;AAED,SAAK,QAAL,GAAgB,EAAE,WAAF,CAAc,KAAK,OAAnB,EAA4B,KAAK,SAAjC,CAAhB;AACA;;AAED,QAAK,IAAL,GAAY,MAAZ;;AAEA,QAAK,QAAL,GAAgB,KAAhB;;AAEA,QAAK,KAAL,CAAW,GAAX,CAAe,sBAAf,EAAuC,IAAvC;;AAEA;;;;AAIA;AACA,OAAI,KAAK,EAAL,CAAQ,aAAR,EAAuB,KAAK,OAA5B,CAAJ,EAA0C;AACzC,SAAK,MAAL,GAAc,KAAK,OAAnB;AACA,SAAK,UAAL,GAAkB,SAAlB;;AAEA,SAAK,IAAL;AACA,IALD,MAMK,IAAI,CAAC,KAAK,QAAV,EAAoB;AACxB;AACA,SAAK,IAAL,CAAU,SAAV,GAAsB,IAAtB;AACA;;AAED;AACA,OAAI,CAAC,KAAK,MAAN,IAAgB,CAAC,KAAK,SAA1B,EAAqC;AACpC,SAAK,MAAL,GAAc,GAAG,KAAK,OAAL,CAAa,QAAhB,EAA0B,MAA1B,CAAiC,UAAU,EAAV,EAAc;AACzD,YAAO,GAAG,OAAH,CAAW,KAAK,SAAL,CAAe,WAA1B,KAA0C,CAAC,GAAG,OAAH,CAAW,KAAK,SAAL,CAAe,QAA1B,CAAlD;AACH,KAFa,EAEX,CAFW,CAAd;;AAIA,QAAI,KAAK,MAAT,EAAiB;AAChB,UAAK,UAAL,GAAkB,QAAlB;AACA,UAAK,OAAL,CAAa,WAAb,GAA2B,KAAK,WAAhC;AACA,OAAE,MAAF,CAAS,KAAK,MAAd;AACA;AACD;;AAED;AACA,OAAI,CAAC,KAAK,MAAN,IAAgB,KAAK,OAAL,CAAa,YAAb,CAA0B,WAA1B,CAApB,EAA4D;AAC3D,SAAK,UAAL,GAAkB,QAAlB;;AAEA,QAAI,WAAW,EAAE,KAAK,OAAL,CAAa,YAAb,CAA0B,WAA1B,CAAF,CAAf;;AAEA,QAAI,YAAY,KAAK,EAAL,CAAQ,aAAR,EAAuB,QAAvB,CAAhB,EAAkD;AACjD,UAAK,MAAL,GAAc,SAAS,SAAT,CAAmB,IAAnB,CAAd;;AAEA;AACA,SAAI,CAAC,KAAK,QAAV,EAAoB;AACnB,WAAK,OAAL,CAAa,QAAb,EAAuB,KAAvB,EAA8B,mBAAW;AAAA;AAAA;AAAA;;AAAA;AACxC,6BAAsB,MAAK,MAA3B,8HAAmC;AAAA,aAA1B,SAA0B;;AAClC,mBAAU,MAAV,GAAmB,SAAS,SAAT,CAAmB,IAAnB,CAAnB;AACA,mBAAU,QAAV,CAAmB,UAAU,KAA7B,EAAoC,EAAC,OAAO,IAAR,EAAc,QAAQ,IAAtB,EAApC;AACA;AAJuC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAKxC,OALD;AAMA;AACD;AACD;;AAED,QAAK,aAAL,GAAqB,KAAK,QAAL,EAArB;;AAEA,QAAK,OAAL,GAAe,KAAK,OAAL,CAAa,YAAb,CAA0B,cAA1B,CAAf;;AAEA,OAAI,KAAK,QAAL,IAAiB,KAAK,OAAL,KAAiB,EAAtC,EAA0C;AAAE;AAC3C,SAAK,OAAL,GAAe,KAAK,aAApB;AACA,IAFD,MAGK,IAAI,KAAK,OAAL,KAAiB,IAArB,EAA2B;AAAE;AACjC,SAAK,OAAL,GAAe,KAAK,MAAL,GAAa,KAAK,WAAlB,GAAgC,KAAK,UAApD;AACA,IAFI,MAGA;AACJ,SAAK,OAAL,CAAa,KAAK,OAAlB,EAA2B,cAA3B,EAA2C,kBAAU;AACpD,WAAK,OAAL,GAAe,MAAK,OAAL,CAAa,YAAb,CAA0B,cAA1B,CAAf;AACA,KAFD;AAGA;;AAED,OAAI,KAAK,UAAT,EAAqB;AACpB;AACA,QAAI,SAAS,SAAT,MAAS,WAAY;AACxB,WAAK,SAAL;AACA,SAAI,KAAK,EAAE,MAAF,CAAS,EAAE,KAAK,SAAL,CAAe,EAAjB,EAAqB,MAAK,OAA1B,CAAT,CAAT;;AAEA,SAAI,MAAM,UAAV;;AAEA,OAAE,MAAF,CAAS,EAAT,EAAa,MAAK,OAAlB;AACA,WAAK,OAAL;;AAEA,YAAO,GAAP;AACA,KAVD;;AAYA;AACA,KAAC,aAAD,EAAgB,WAAhB,EAA6B,OAA7B,CAAqC,oBAAY;AAChD,SAAI,aAAa,OAAO,wBAAP,CAAgC,KAAK,SAArC,EAAgD,QAAhD,CAAjB;;AAEA,YAAO,cAAP,CAAsB,MAAK,OAA3B,EAAoC,QAApC,EAA8C;AAC7C,WAAK,eAAW;AAAA;;AACf,cAAO,OAAO;AAAA,eAAM,WAAW,GAAX,CAAe,IAAf,QAAN;AAAA,QAAP,CAAP;AACA,OAH4C;;AAK7C,WAAK,aAAS,KAAT,EAAgB;AAAA;;AACpB,cAAO;AAAA,eAAM,WAAW,GAAX,CAAe,IAAf,SAA0B,KAA1B,CAAN;AAAA,QAAP;AACA;AAP4C,MAA9C;AASA,KAZD;AAaA;;AAED,OAAI,CAAC,KAAK,QAAV,EAAoB;AACnB,SAAK,QAAL,CAAc,KAAK,aAAnB,EAAkC,EAAC,QAAQ,IAAT,EAAlC;AACA;;AAED,QAAK,QAAL,CAAc,KAAK,QAAL,GAAe,KAAK,OAApB,GAA8B,KAAK,aAAjD,EAAgE,EAAC,QAAQ,IAAT,EAAhE;;AAEA;AACA;AACA;AACA,QAAK,OAAL;AACA,GA/H+B;;AAiIhC,MAAI,OAAJ,GAAc;AACb,UAAO,KAAK,IAAL,IAAa,MAApB;AACA,GAnI+B;;AAqIhC,MAAI,WAAJ,GAAkB;AACjB,OAAI,KAAK,cAAT,EAAyB;AACxB,QAAI,QAAQ,KAAK,cAAL,EAAZ;;AAEA,QAAI,UAAU,SAAd,EAAyB;AACxB,YAAO,KAAP;AACA;AACD;;AAED,OAAI,KAAK,MAAT,EAAiB;AAChB,QAAI,KAAK,MAAL,CAAY,OAAZ,CAAoB,KAAK,SAAL,CAAe,WAAnC,CAAJ,EAAqD;AACpD,YAAO,EAAE,QAAF,CAAW,KAAK,MAAhB,EAAwB,SAAxB,EAAmC,KAAK,QAAxC,CAAP;AACA;;AAED;AACA,QAAI,SAAS,EAAE,KAAK,SAAL,CAAe,MAAf,GAAwB,IAAxB,GAA+B,KAAK,SAAL,CAAe,WAAhD,EAA6D,KAAK,MAAlE,CAAb;;AAEA,QAAI,MAAJ,EAAY;AACX,YAAO,EAAE,GAAF,CAAM,GAAN,CAAU,MAAV,IAAmB,EAAE,GAAF,CAAM,GAAN,CAAU,MAAV,EAAkB,KAArC,GAA6C,EAAE,QAAF,CAAW,MAAX,CAApD;AACA;AACD;AACD,GA1J+B;;AA4JhC,MAAI,WAAJ,CAAgB,KAAhB,EAAuB;AACtB,OAAI,KAAK,cAAL,IAAuB,KAAK,cAAL,CAAoB,KAApB,MAA+B,SAA1D,EAAqE;AACpE;AACA;;AAED,OAAI,KAAK,MAAT,EAAiB;AAChB,QAAI,KAAK,MAAL,CAAY,OAAZ,CAAoB,KAAK,SAAL,CAAe,WAAnC,CAAJ,EAAqD;AACpD,OAAE,QAAF,CAAW,KAAK,MAAhB,EAAwB,KAAxB;AACA,KAFD,MAGK;AACJ;AACA,SAAI,SAAS,EAAE,KAAK,SAAL,CAAe,MAAf,GAAwB,IAAxB,GAA+B,KAAK,SAAL,CAAe,WAAhD,EAA6D,KAAK,MAAlE,CAAb;;AAEA,SAAI,MAAJ,EAAY;AACX,UAAI,EAAE,GAAF,CAAM,GAAN,CAAU,MAAV,CAAJ,EAAuB;AACtB,SAAE,GAAF,CAAM,GAAN,CAAU,MAAV,EAAkB,KAAlB,GAA0B,KAA1B;AACA,OAFD,MAGK;AACJ,SAAE,QAAF,CAAW,MAAX,EAAmB,KAAnB;AACA;AACD;AACD;AACD;AACD,GAnL+B;;AAqLhC,MAAI,OAAJ,GAAc;AACb,UAAO,KAAK,MAAL,KAAgB,KAAK,OAA5B;AACA,GAvL+B;;AAyLhC,WAAS,iBAAS,CAAT,EAAY;AACpB,OAAI,KAAK,EAAT;;AAEA,OAAI,MAAM,KAAK,KAAL,CAAW,OAAX,CAAmB,IAAnB,CAAwB,IAAxB,EAA8B,CAA9B,CAAV;;AAEA,OAAI,QAAQ,SAAZ,EAAuB;AACtB,WAAO,GAAP;AACA;;AAED,OAAI,MAAM,CAAC,EAAE,KAAH,IAAY,CAAC,KAAK,OAAlB,GAA2B,KAAK,UAAhC,GAA6C,KAAK,KAA5D;;AAEA,OAAI,CAAC,EAAE,KAAH,IAAY,QAAQ,EAAxB,EAA4B;AAC3B,WAAO,IAAP;AACA;;AAED,UAAO,GAAP;AACA,GAzM+B;;AA2MhC,QAAM,gBAAW;AAChB,OAAI,KAAK,WAAT,EAAsB;AACrB,WAAO,KAAP;AACA;;AAED,QAAK,UAAL,GAAkB,KAAK,KAAvB;AACA,QAAK,cAAL,GAAsB,KAAtB;AACA,GAlN+B;;AAoNhC,QAAM,gBAAY;AACjB,QAAK,SAAL;;AAEA,OAAI,KAAK,KAAT,EAAgB;AACf,SAAK,KAAL,CAAW,KAAX;AACA,IAFD,MAGK,IAAI,CAAC,KAAK,SAAN,IAAmB,CAAC,KAAK,OAAzB,IAAoC,KAAK,OAA7C,EAAsD;AAC1D,MAAE,MAAF,CAAS,KAAK,MAAd;AACA,SAAK,OAAL,CAAa,WAAb,GAA2B,KAAK,WAAhC;AACA;;AAED,OAAI,CAAC,KAAK,OAAV,EAAmB;AAClB,SAAK,IAAL,GAAY,MAAZ;AACA;;AAED;AACA,OAAI,KAAK,OAAL,CAAa,CAAb,CAAe,IAAf,CAAoB,YAApB,KAAqC,IAAzC,EAA+C;AAC9C,SAAK,OAAL,CAAa,QAAb,GAAwB,KAAK,OAAL,CAAa,CAAb,CAAe,IAAf,CAAoB,YAA5C;AACA,IAFD,MAGK;AACJ,SAAK,OAAL,CAAa,eAAb,CAA6B,UAA7B;AACA;;AAED,QAAK,OAAL;AACA,GA5O+B;;AA8OhC,UAAQ,kBAAW;AAClB,OAAI,KAAK,cAAL,IAAuB,KAAK,UAAL,KAAoB,SAA/C,EAA0D;AACzD;AACA;AACA;AACA,SAAK,KAAL,GAAa,KAAK,UAAlB;AACA,SAAK,cAAL,GAAsB,KAAtB;AACA;AACD,GAtP+B;;AAwPhC;AACA;AACA,WAAS,mBAAY;AAAA;;AACpB,OAAI,KAAK,QAAT,EAAmB;AAClB;AACA;;AAED;AACA;AACA,OAAI,KAAK,KAAL,IAAc,CAAC,KAAK,SAAxB,EAAmC;AAClC,SAAK,IAAL;AACA;AACA;;AAED,OAAI,KAAK,IAAL,IAAa,SAAjB,EAA4B;AAC3B;AACA;;AAED,QAAK,IAAL,GAAY,SAAZ;;AAEA,OAAI,KAAJ;;AAEA,QAAK,OAAL,CAAa,CAAb,CAAe,MAAf,CAAsB;AACrB;AACA,0BAAsB;AAAA,YAAK,OAAK,IAAL,EAAL;AAAA,KAFD;AAGrB,0BAAsB,6BAAK;AAC1B,YAAK,IAAL;;AAEA,SAAI,CAAC,OAAK,KAAV,EAAiB;AAChB,aAAK,MAAL,CAAY,KAAZ;AACA;AACD,KAToB;AAUrB,uBAAmB,4BAAO;AACzB;AACA;AACA,SAAI,CAAC,OAAK,OAAV,EAAmB;AAClB,UAAI,cAAJ;AACA;AACD;AAhBoB,IAAtB;;AAmBA,OAAI,CAAC,KAAK,SAAV,EAAqB;AACpB,SAAK,OAAL,CAAa,CAAb,CAAe,MAAf,CAAsB;AACrB,gCAA2B,kCAAK;AAC/B,mBAAa,KAAb;AACA,cAAQ,WAAW;AAAA,cAAM,OAAK,IAAL,EAAN;AAAA,OAAX,EAA8B,GAA9B,CAAR;AACA,MAJoB;AAKrB,gCAA2B,kCAAK;AAC/B,mBAAa,KAAb;AACA;AAPoB,KAAtB;AASA;;AAED;AACA,QAAK,OAAL,CAAa,CAAb,CAAe,IAAf,CAAoB,YAApB,GAAmC,KAAK,OAAL,CAAa,YAAb,CAA0B,UAA1B,CAAnC;AACA,QAAK,OAAL,CAAa,QAAb,GAAwB,CAAxB;AACA,GAhT+B;;AAkThC;AACA,YAAU,oBAAY;AAAA;;AACrB,OAAI,CAAC,KAAK,MAAV,EAAkB;AACjB;AACA;AACA,QAAI,SAAS,EAAE,QAAF,CAAW,KAAK,OAAhB,EAAyB,EAAE,OAA3B,CAAb;;AAEA,QAAI,OAAO,MAAX,EAAmB;AAClB,OAAE,MAAF,CAAS,IAAT,EAAe,MAAf,EAAuB;AAAA,aAAY,YAAY,QAAxB;AAAA,MAAvB;AACA;;AAED,QAAI,SAAS,OAAO,MAAP,IAAiB,MAA9B;AACA,SAAK,MAAL,GAAc,EAAE,MAAF,CAAS,EAAE,IAAF,CAAO,MAAP,MAAmB,UAAnB,GAA+B,OAAO,IAAP,CAAY,IAAZ,CAA/B,GAAmD,MAA5D,CAAd;AACA,SAAK,WAAL,GAAmB,KAAK,KAAxB;AACA,SAAK,UAAL,GAAkB,SAAlB;AACA;;AAED,QAAK,MAAL,CAAY,CAAZ,CAAc,MAAd,CAAqB;AACpB,oBAAgB,0BAAO;AACtB,SAAI,iBAAiB,OAAK,IAAL,CAAU,cAA/B;;AAEA,YAAK,KAAL,GAAa,OAAK,WAAlB;;AAEA;AACA,SACC,OAAK,OAAL,IACA,CAAC,OAAK,IAAL,CAAU,OADX,IACsB;AACnB,YAAK,IAAL,CAAU,WAAV,CAAsB,IAH1B,CAG+B;AAH/B,OAIE;AACD;AACA,cAAK,cAAL,GAAsB,KAAtB;AACA,cAAK,IAAL,CAAU,cAAV,GAA2B,cAA3B;;AAEA;AACA,WAAI,IAAI,IAAJ,IAAY,QAAhB,EAA0B;AACzB,eAAK,IAAL,GADyB,CACZ;;AAEb;AACA;AACA,eAAK,IAAL,CAAU,OAAV,CAAkB,IAAlB;;AAEA;AACA,eAAK,IAAL,CAAU,iBAAV;AACA;AACD;AACD,KA5BmB;AA6BpB,aAAS,oBAAO;AACf,YAAK,MAAL,CAAY,MAAZ,IAAsB,OAAK,MAAL,CAAY,MAAZ,EAAtB;AACA,KA/BmB;AAgCpB,uBAAmB,6BAAO;AACzB,SAAI,IAAI,QAAJ,KAAiB,QAArB,EAA+B;AAC9B,UAAI,eAAJ;AACA,QAAE,IAAF,CAAO,OAAK,MAAZ,EAAoB,OAApB;AACA;AACD;AArCmB,IAArB;;AAwCA,OAAI,iBAAiB,KAAK,MAA1B,EAAkC;AACjC,SAAK,MAAL,CAAY,WAAZ,GAA0B,MAAM,KAAK,KAAX,GAAmB,GAA7C;AACA;;AAED,OAAI,CAAC,KAAK,OAAV,EAAmB;AAClB;AACA,QAAI,YAAY,eAAhB;AACA,OAAG,KAAK,OAAL,CAAa,UAAhB,EAA4B,OAA5B,CAAoC,UAAU,SAAV,EAAqB;AACxD,SAAI,UAAU,IAAV,CAAe,UAAU,IAAzB,CAAJ,EAAoC;AACnC,WAAK,MAAL,CAAY,YAAZ,CAAyB,UAAU,IAAV,CAAe,OAAf,CAAuB,SAAvB,EAAkC,EAAlC,CAAzB,EAAgE,UAAU,KAA1E;AACA;AACD,KAJD,EAIG,IAJH;;AAMA,QAAI,KAAK,SAAT,EAAoB;AACnB,UAAK,KAAL,GAAa,IAAI,EAAE,KAAN,CAAY,IAAZ,CAAb;AACA;AACD;;AAED,OAAI,CAAC,KAAK,KAAV,EAAiB;AAChB,SAAK,MAAL,CAAY,SAAZ,CAAsB,GAAtB,CAA0B,WAA1B;AACA;;AAED,QAAK,QAAL,GAAgB,IAAhB;AACA,GAlY+B;;AAoYhC,QAAM,gBAAY;AACjB,OAAI,KAAK,QAAL,IAAiB,KAAK,OAA1B,EAAmC;AAClC;AACA;;AAED,QAAK,OAAL,CAAa,CAAb,CAAe,MAAf,CAAsB,eAAtB;;AAEA,OAAI,KAAK,QAAT,EAAmB;AAClB,SAAK,QAAL;AACA;;AAED,OAAI,KAAK,KAAT,EAAgB;AACf,SAAK,KAAL,CAAW,IAAX;AACA;;AAED,OAAI,CAAC,KAAK,SAAV,EAAqB;AACpB,QAAI,KAAK,MAAL,CAAY,UAAZ,IAA0B,KAAK,OAA/B,IAA0C,CAAC,KAAK,OAApD,EAA6D;AAC5D,UAAK,WAAL,GAAmB,KAAK,KAAxB;AACA,UAAK,OAAL,CAAa,WAAb,GAA2B,EAA3B;;AAEA,SAAI,CAAC,KAAK,OAAV,EAAmB;AAClB,WAAK,OAAL,CAAa,WAAb,CAAyB,KAAK,MAA9B;AACA;AACD;AACD;;AAED,QAAK,IAAL,GAAY,MAAZ;AACA,GA/Z+B,EA+Z7B;;AAEH,SAAO,iBAAW;AACjB,QAAK,KAAL,GAAa,KAAK,UAAlB;AACA,GAna+B;;AAqahC,UAAQ,gBAAS,IAAT,EAAe;AACtB,OAAI,MAAM,OAAN,CAAc,IAAd,CAAJ,EAAyB;AACxB,WAAO,KAAK,CAAL,CAAP,CADwB,CACR;AAChB;;AAED,OAAI,QAAO,IAAP,yCAAO,IAAP,OAAgB,QAApB,EAA8B;AAC7B,WAAO,KAAK,KAAK,QAAV,CAAP;AACA;;AAED,OAAI,SAAS,SAAb,EAAwB;AACvB;AACA,SAAK,KAAL,GAAa,KAAK,iBAAL,GAAwB,KAAK,OAA7B,GAAuC,KAAK,aAAzD;AACA,IAHD,MAIK;AACJ,SAAK,KAAL,GAAa,IAAb;AACA;;AAED,QAAK,IAAL;AACA,GAvb+B;;AAybhC,QAAM,cAAS,QAAT,EAAmB;AACxB,OAAI,KAAK,QAAL,IAAiB,QAArB,EAA+B;AAC9B,WAAO,IAAP;AACA;AACD,GA7b+B;;AA+bhC,WAAS,mBAAW;AAAA;;AACnB,OAAI,CAAC,KAAK,QAAV,EAAoB;AACnB,SAAK,QAAL,GAAgB,KAAK,OAAL,CAAa,KAAK,OAAlB,EAA2B,KAAK,SAAhC,EAA2C,KAAK,QAAL,IAAkB,kBAAU;AACtF,SAAI,OAAK,SAAL,IAAkB,CAAC,OAAK,IAAL,CAAU,OAAjC,EAA0C;AACzC,aAAK,KAAL,GAAa,OAAK,QAAL,EAAb;AACA;AACD,KAJe,CAAhB;AAKA;AACD,GAvc+B;;AAychC,aAAW,qBAAY;AACtB,QAAK,QAAL,IAAiB,KAAK,QAAL,CAAc,UAAd,EAAjB;AACA,GA3c+B;;AA6chC;;;AAGA,YAAU,kBAAS,CAAT,EAAY;AACrB,UAAO,EAAE,QAAF,CAAW,KAAK,OAAhB,EAAyB,KAAK,SAA9B,EAAyC,KAAK,QAA9C,EAAwD,CAAxD,CAAP;AACA,GAld+B;;AAodhC,QAAM;AACL,UAAO,iBAAW;AACjB,WAAO,KAAK,QAAL,CAAc,KAAK,QAAnB,CAAP;AACA,IAHI;;AAKL,eAAY,sBAAW;AACtB,YAAQ,KAAK,QAAb;AACC,UAAK,SAAL;AACC,aAAO,KAAP;AACD,UAAK,QAAL;AACC,aAAO,CAAP;AAJF;;AAOA,WAAO,EAAP;AACA;AAdI,GApd0B;;AAqehC,YAAU,kBAAU,KAAV,EAAyB;AAAA;;AAAA,OAAR,CAAQ,yDAAJ,EAAI;;AAClC,QAAK,SAAL;;AAEA,OAAI,EAAE,IAAF,CAAO,KAAP,KAAiB,QAAjB,IAA6B,WAAW,KAA5C,EAAmD;AAClD,QAAI,iBAAiB,MAAM,cAA3B;AACA,YAAQ,MAAM,KAAd;AACA;;AAED,WAAQ,SAAS,UAAU,CAAnB,GAAsB,KAAtB,GAA8B,EAAtC;AACA,WAAQ,EAAE,QAAF,CAAW,KAAX,EAAkB,KAAK,QAAvB,CAAR;;AAEA,OAAI,SAAS,KAAK,MAAd,IAAwB,CAAC,EAAE,KAA/B,EAAsC;AACrC,WAAO,KAAP;AACA;;AAED,OAAI,KAAK,MAAL,IAAe,SAAS,aAAT,IAA0B,KAAK,MAAlD,EAA0D;AACzD,SAAK,WAAL,GAAmB,KAAnB;AACA;;AAED,OAAI,KAAK,aAAL,IAAsB,KAAK,SAA/B,EAA0C;AACzC,qBAAiB,KAAK,aAAL,CAAmB,KAAnB,CAAjB;AACA;;AAED,OAAI,CAAC,KAAK,OAAN,IAAiB,KAAK,SAA1B,EAAqC;AACpC,QAAI,KAAK,MAAL,IAAe,KAAK,MAAL,CAAY,OAAZ,CAAoB,QAApB,CAAf,IAAgD,KAAK,MAAL,CAAY,eAAZ,CAA4B,CAA5B,CAApD,EAAoF;AACnF,sBAAiB,KAAK,MAAL,CAAY,eAAZ,CAA4B,CAA5B,EAA+B,WAAhD;AACA;;AAED,MAAE,QAAF,CAAW,KAAK,OAAhB,EAAyB,EAAC,YAAD,EAAQ,8BAAR,EAAzB,EAAkD,KAAK,SAAvD,EAAkE,KAAK,QAAvE;AACA;;AAED,QAAK,KAAL,GAAa,UAAU,EAAvB;;AAEA,QAAK,MAAL,GAAc,KAAd;;AAEA,OAAI,CAAC,EAAE,MAAP,EAAe;AACd,QAAI,CAAC,KAAK,QAAV,EAAoB;AACnB,UAAK,cAAL,GAAsB,KAAK,IAAL,CAAU,cAAV,GAA2B,IAAjD;AACA;;AAED,0BAAsB,YAAM;AAC3B,OAAE,IAAF,CAAO,OAAK,OAAZ,EAAqB,iBAArB,EAAwC;AACvC,gBAAU,OAAK,QADwB;AAEvC,aAAO,KAFgC;AAGvC,YAAM,OAAK,IAH4B;AAIvC,kBAJuC;AAKvC,aAAO,OAAK,OAL2B;AAMvC,cAAQ;AAN+B,MAAxC;AAQA,KATD;AAUA;;AAED,OAAI,KAAK,IAAL,IAAa,SAAjB,EAA4B;AAC3B,SAAK,OAAL;AACA;;AAED,QAAK,OAAL;;AAEA,UAAO,KAAP;AACA,GAhiB+B;;AAkiBhC,QAAM;AACL,UAAO,eAAU,MAAV,EAAiB;AACvB,WAAO,KAAK,QAAL,CAAc,MAAd,CAAP;AACA,IAHI;;AAKL,UAAO,eAAS,KAAT,EAAgB;AACtB,QAAI,OAAO,SAAS,CAAC,KAAK,OAAf,IAA0B,EAAE,KAAK,SAAL,IAAkB,EAAE,KAAK,SAAL,CAAe,QAAjB,EAA2B,KAAK,OAAhC,CAApB,CAArC;AACA,SAAK,OAAL,CAAa,SAAb,CAAuB,MAAvB,CAA8B,OAA9B,EAAuC,IAAvC;AACA,IARI;;AAUL,SAAM,cAAU,KAAV,EAAiB;AACtB,SAAK,OAAL,CAAa,SAAb,CAAuB,MAAvB,CAA8B,SAA9B,EAAyC,SAAS,MAAlD;AACA,IAZI;;AAcL,aAAU,kBAAU,KAAV,EAAiB;AAC1B,SAAK,OAAL,CAAa,SAAb,CAAuB,MAAvB,CAA8B,UAA9B,EAA0C,KAA1C;AACA;AAhBI,GAliB0B;;AAqjBhC,UAAQ;AACP,QAAK,IAAI,OAAJ,EADE;;AAGP,aAAU,kBAAU,OAAV,EAAmB,GAAnB,EAAwB;AACjC;AACA,QAAI,MAAM,IAAV;;AAEA,SAAK,IAAI,QAAT,IAAqB,GAArB,EAA0B;AACzB,SAAI,QAAQ,OAAR,CAAgB,QAAhB,CAAJ,EAA+B;AAC9B,YAAM,IAAI,QAAJ,CAAN;AACA;AACD;;AAED,WAAO,GAAP;AACA,IAdM;;AAgBP,sBAAmB,2BAAU,OAAV,EAAmB;AACrC,QAAI,MAAM,QAAQ,YAAR,CAAqB,gBAArB,KAA0C,EAAE,QAAF,CAAW,OAAX,EAAoB,EAAE,UAAtB,CAApD;;AAEA;AACA,QAAI,OAAO,IAAI,KAAf,EAAsB;AACrB,WAAM,EAAE,MAAF,CAAS,IAAI,MAAJ,CAAW,IAAI,KAAf,CAAT,EAAgC,GAAhC,CAAN;AACA;;AAED,QAAI,CAAC,GAAD,IAAQ,QAAQ,MAApB,EAA4B;AAC3B,WAAM,IAAN;AACA;;AAED,WAAO,GAAP;AACA,IA7BM;;AA+BP,gBAAa,qBAAU,OAAV,EAAmB,SAAnB,EAA8B;AAC1C,QAAI,MAAM,QAAQ,YAAR,CAAqB,UAArB,CAAV;;AAEA,QAAI,CAAC,GAAL,EAAU;AACT,UAAK,IAAI,QAAT,IAAqB,EAAE,SAAvB,EAAkC;AACjC,UAAI,QAAQ,OAAR,CAAgB,QAAhB,CAAJ,EAA+B;AAC9B,aAAM,EAAE,SAAF,CAAY,QAAZ,EAAsB,SAAtB,CAAN;AACA;AACD;AACD;;AAED,UAAM,OAAO,QAAb;;AAEA,WAAO,GAAP;AACA,IA7CM;;AA+CP;;;AAGA,aAAU,kBAAS,KAAT,EAAgB,QAAhB,EAA0B;AACnC,QAAI,sBAAsB,KAAtB,yCAAsB,KAAtB,CAAJ;AACA,QAAI,OAAO,EAAE,IAAF,CAAO,KAAP,EAAc,QAAd,CAAX;;AAEA,QAAI,UAAU,IAAV,IAAkB,UAAU,SAAhC,EAA2C;AAC1C,YAAO,KAAP;AACA;;AAED,QAAI,YAAY,SAAhB,EAA2B;AAC1B,SAAI,UAAU,OAAV,IAAqB,UAAU,CAA/B,IAAoC,UAAU,EAAlD,EAAsD;AACrD,aAAO,KAAP;AACA;;AAED,SAAI,UAAU,MAAV,IAAoB,QAAQ,CAAhC,EAAmC;AAClC,aAAO,IAAP;AACA;;AAED,YAAO,KAAP;AACA;;AAED,QAAI,YAAY,QAAhB,EAA0B;AACzB,SAAI,mBAAmB,IAAnB,CAAwB,QAAQ,EAAhC,CAAJ,EAAyC;AACxC,aAAO,IAAP;AACA;;AAED,YAAO,KAAP;AACA;;AAED,WAAO,IAAP;AACA,IA/EM;;AAiFP;;;AAGA,SAAM,cAAS,KAAT,EAAgB,QAAhB,EAA0B;AAC/B,YAAQ,QAAR;AACC,UAAK,QAAL;AAAe,aAAO,CAAC,KAAR;AACf,UAAK,SAAL;AAAgB,aAAO,CAAC,CAAC,KAAT;AAChB,UAAK,QAAL;AAAe,aAAO,QAAQ,EAAf;AAHhB;;AAMA,WAAO,KAAP;AACA,IA5FM;;AA8FP,aAAU,kBAAU,OAAV,EAAmB,SAAnB,EAA8B,QAA9B,EAAgD;AAAA,QAAR,CAAQ,yDAAJ,EAAI;;AACzD,gBAAY,aAAa,cAAc,IAA3B,GAAiC,SAAjC,GAA6C,EAAE,iBAAF,CAAoB,OAApB,CAAzD;AACA,eAAW,YAAY,EAAE,WAAF,CAAc,OAAd,EAAuB,SAAvB,CAAvB;;AAEA,QAAI,GAAJ;;AAEA,QAAI,aAAa,OAAb,IAAwB,EAAE,WAAF,CAAc,OAAd,EAAuB,SAAvB,CAA5B,EAA+D;AAC9D;AACA;AACA,WAAM,QAAQ,SAAR,CAAN;AACA,KAJD,MAKK,IAAI,SAAJ,EAAe;AACnB,WAAM,QAAQ,YAAR,CAAqB,SAArB,CAAN;AACA,KAFI,MAGA;AACJ,WAAM,QAAQ,YAAR,CAAqB,SAArB,KAAmC,QAAQ,WAA3C,IAA0D,IAAhE;AACA;;AAED,WAAO,EAAE,QAAF,CAAW,GAAX,EAAgB,QAAhB,CAAP;AACA,IAjHM;;AAmHP,aAAU,kBAAU,OAAV,EAAmB,KAAnB,EAA0B,SAA1B,EAAqC,QAArC,EAA+C;AACxD,QAAI,EAAE,IAAF,CAAO,KAAP,KAAiB,QAAjB,IAA6B,WAAW,KAA5C,EAAmD;AAClD,SAAI,iBAAiB,MAAM,cAA3B;AACA,aAAQ,MAAM,KAAd;AACA;;AAED,QAAI,cAAc,IAAlB,EAAwB;AACvB,iBAAY,aAAc,EAAE,iBAAF,CAAoB,OAApB,CAA1B;AACA;;AAED,QAAI,aAAa,OAAb,IAAwB,EAAE,WAAF,CAAc,OAAd,EAAuB,SAAvB,CAAxB,IAA6D,QAAQ,SAAR,KAAsB,KAAvF,EAA8F;AAC7F;AACA;AACA,SAAI;AACH,cAAQ,SAAR,IAAqB,KAArB;AACA,MAFD,CAGA,OAAO,CAAP,EAAU,CAAE;AACZ;;AAED;AACA;AACA,QAAI,SAAJ,EAAe;AACd,SAAI,QAAQ,YAAR,CAAqB,SAArB,KAAmC,KAAvC,EAA8C;AAAE;AAC/C,cAAQ,YAAR,CAAqB,SAArB,EAAgC,KAAhC;;AAEA,UAAI,cAAJ,EAAoB;AACnB,eAAQ,WAAR,GAAsB,cAAtB;AACA;AACD;AACD,KARD,MASK;AACJ,SAAI,aAAa,QAAb,IAAyB,CAAC,cAA9B,EAA8C;AAC7C,uBAAiB,EAAE,YAAF,CAAe,KAAf,CAAjB;AACA;;AAED,aAAQ,WAAR,GAAsB,kBAAkB,KAAxC;;AAEA,SAAI,kBAAkB,QAAQ,YAA9B,EAA4C;AAC3C,cAAQ,YAAR,CAAqB,SAArB,EAAgC,KAAhC;AACA;AACD;AACD,IA5JM;;AA8JP;;;;AAIA,gBAAa,qBAAS,OAAT,EAAkB,SAAlB,EAA6B;AACzC,QAAI,CAAC,MAAD,EAAS,KAAT,EAAgB,OAAhB,CAAwB,SAAxB,IAAqC,CAAC,CAA1C,EAA6C;AAC5C;AACA,YAAO,KAAP;AACA;;AAED,QAAI,QAAQ,YAAR,IAAwB,4BAA5B,EAA0D;AACzD;AACA,YAAO,KAAP;AACA;;AAED,WAAO,IAAP;AACA,IA9KM;;AAgLP,aAAU,kBAAS,QAAT,EAA2B;AAAA,QAAR,CAAQ,yDAAJ,EAAI;;AACpC,QAAI,EAAE,SAAN,EAAiB;AAChB,UAAK,SAAL,CAAe,UAAf,CAA0B,QAA1B,IAAsC,EAAE,SAAxC;AACA;;AAED,QAAI,EAAE,QAAN,EAAgB;AACf,UAAK,SAAL,CAAe,SAAf,CAAyB,QAAzB,IAAqC,EAAE,QAAvC;AACA;;AAED,QAAI,EAAE,MAAN,EAAc;AACb,UAAK,SAAL,CAAe,OAAf,CAAuB,QAAvB,IAAmC,EAAE,MAArC;AACA;;AAED,QAAI,EAAE,IAAN,EAAY;AACX,UAAK,KAAL,CAAW,GAAX,CAAe,sBAAf,EAAuC,YAAW;AACjD,UAAI,KAAK,OAAL,CAAa,OAAb,CAAqB,QAArB,CAAJ,EAAoC;AACnC,SAAE,IAAF,CAAO,IAAP,CAAY,IAAZ,EAAkB,KAAK,OAAvB;AACA;AACD,MAJD;AAKA;;AAnBmC;AAAA;AAAA;;AAAA;AAqBpC,2BAAe,KAAK,OAAL,CAAa,EAAE,EAAf,CAAf,mIAAmC;AAAA,UAA1B,EAA0B;;AAClC,WAAK,SAAL,CAAe,EAAf,KAAsB,OAAO,QAA7B;AACA;AAvBmC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAwBpC,IAxMM;;AA0MP,SAAM;AACL,kBAAc,wBAAM;AACnB,SAAI,eAAe,IAAI,KAAK,YAAT,CAAsB,OAAtB,EAA+B,EAAC,uBAAsB,CAAvB,EAA/B,CAAnB;;AAEA,YAAO,UAAS,KAAT,EAAgB;AACtB,UAAI,UAAU,QAAV,IAAsB,UAAU,CAAC,QAArC,EAA+C;AAC9C;AACA,cAAO,QAAQ,CAAR,GAAW,IAAX,GAAkB,GAAzB;AACA;;AAED,aAAO,aAAa,MAAb,CAAoB,KAApB,CAAP;AACA,MAPD;AAQA;AAZI;AA1MC;AArjBwB,EAAR,CAAzB;;AAgxBA;AACA,GAAE,UAAF,GAAe;AACd,uBAAqB,KADP;AAEd,aAAW,MAFG;AAGd,8CAA4C,OAH9B;AAId,0BAAwB,SAJV;AAKd,UAAQ;AACP,UAAO,UADA;AAEP,kBAAe,uBAAU,KAAV,EAAiB;AAC/B,QAAI,OAAO,IAAI,IAAJ,CAAS,KAAT,CAAX;;AAEA,QAAI,CAAC,KAAD,IAAU,MAAM,IAAN,CAAd,EAA2B;AAC1B,YAAO,SAAS,KAAK,KAAd,GAAsB,GAA7B;AACA;;AAED;AACA,QAAI,UAAU;AACb,aAAQ,EAAC,KAAK,SAAN,EAAiB,OAAO,OAAxB,EAAiC,MAAM,SAAvC,EADK;AAEb,cAAS,EAAC,OAAO,MAAR,EAFI;AAGb,aAAQ,EAAC,MAAM,SAAP,EAAkB,QAAQ,SAA1B,EAHK;AAIb,uBAAkB,EAAC,KAAK,SAAN,EAAiB,OAAO,OAAxB,EAAiC,MAAM,SAAvC,EAAkD,MAAM,SAAxD,EAAmE,QAAQ,SAA3E;AAJL,KAAd;;AAOA,QAAI,SAAS,QAAQ,KAAK,MAAL,IAAe,KAAK,MAAL,CAAY,IAAnC,KAA4C,QAAQ,IAAjE;AACA,WAAO,QAAP,GAAkB,KAAlB;;AAEA,WAAO,KAAK,cAAL,CAAoB,OAApB,EAA6B,MAA7B,CAAP;AACA;AArBM,GALM;AA4Bd,UAAQ;AA5BM,EAAf;;AA+BA;AACA;AACA,GAAE,SAAF,GAAc;AACb,0BAAwB;AACvB,cAAW;AADY,GADX;AAIb,4DAA0D;AACzD,YAAS;AADgD;AAJ7C,EAAd;;AASA,GAAE,OAAF,GAAY;AACX,OAAK,EAAC,OAAO,OAAR,EADM;;AAGX,aAAW;AACV,UAAO,OADG;AAEV,WAAQ;AAFE,GAHA;;AAQX,cAAY;AACX,UAAO,OADI;AAEX,WAAQ;AAFG,GARD;;AAaX,gCAA8B;AAC7B,UAAO,OADsB;AAE7B,WAAQ,KAFqB;AAG7B,kBAAe;AAHc,GAbnB;;AAmBX;AACA,uFAAqF;AACpF,WAAQ,kBAAW;AAClB,QAAI,UAAU,iBAAiB,KAAK,OAAtB,EAA+B,OAA7C;AACA,QAAI,MAAM,QAAQ,OAAR,CAAgB,QAAhB,MAA8B,CAA9B,GAAiC,OAAjC,GAA2C,UAArD;AACA,QAAI,SAAS,EAAE,MAAF,CAAS,GAAT,CAAb;;AAEA,QAAI,OAAO,UAAX,EAAuB;AACtB;AACA,SAAI,QAAQ,KAAK,OAAL,CAAa,WAAzB;;AAEA,SAAI,KAAJ,EAAW;AACV,aAAO,KAAP,GAAe,KAAf;AACA;AACD;;AAED,WAAO,MAAP;AACA,IAhBmF;;AAkBpF,mBAAgB,wBAAS,KAAT,EAAgB;AAC/B,QAAI,KAAK,QAAL,IAAiB,QAArB,EAA+B;AAC9B;AACA;;AAED,QAAI,KAAK,iBAAiB,KAAK,OAAtB,CAAT;AACA,YAAQ,SAAS,EAAjB;;AAEA,QAAI,CAAC,QAAD,EAAW,QAAX,EAAqB,OAArB,CAA6B,GAAG,UAAhC,IAA8C,CAAC,CAAnD,EAAsD;AACrD;AACA,aAAQ,MAAM,OAAN,CAAc,QAAd,EAAwB,GAAxB,CAAR;AACA;;AAED,QAAI,CAAC,QAAD,EAAW,QAAX,EAAqB,UAArB,EAAiC,OAAjC,CAAyC,GAAG,UAA5C,IAA0D,CAAC,CAA/D,EAAkE;AACjE;AACA,aAAQ,MAAM,OAAN,CAAc,mBAAd,EAAmC,EAAnC,EAAuC,OAAvC,CAA+C,SAA/C,EAA0D,GAA1D,CAAR;AACA;;AAED,SAAK,MAAL,CAAY,KAAZ,GAAoB,KAApB;AACA,WAAO,IAAP;AACA;AAtCmF,GApB1E;;AA6DX,qBAAmB,yBAAW;AAC7B,UAAO,EAAE,MAAF,CAAS;AACf,SAAK,OADU;AAEf,UAAM,OAFS;AAGf,SAAK,KAAK,OAAL,CAAa,YAAb,CAA0B,KAA1B,KAAoC,CAH1B;AAIf,SAAK,KAAK,OAAL,CAAa,YAAb,CAA0B,KAA1B,KAAoC;AAJ1B,IAAT,CAAP;AAMA,GApEU;;AAsEX,iBAAe,oBAAW;AACzB,OAAI,QAAQ;AACX,YAAQ,+BADG;AAEX,aAAS,sBAFE;AAGX,YAAQ,qBAHG;AAIX,YAAQ,sBAJG;AAKX,sBAAkB;AALP,IAAZ;;AAQA,OAAI,WAAW,KAAK,OAAL,CAAa,YAAb,CAA0B,UAA1B,KAAyC,YAAxD;;AAEA,QAAK,IAAI,IAAT,IAAiB,KAAjB,EAAwB;AACvB,QAAI,MAAM,IAAN,EAAY,IAAZ,CAAiB,QAAjB,CAAJ,EAAgC;AAC/B;AACA;AACD;;AAED,UAAO,EAAE,MAAF,CAAS,OAAT,EAAkB,EAAC,MAAM,IAAP,EAAlB,CAAP;AACA;AAxFU,EAAZ;;AA2FA,GAAE,KAAF,GAAU,EAAE,KAAF,CAAQ;AACjB,eAAa,qBAAS,SAAT,EAAoB;AAAA;;AAChC,QAAK,SAAL,GAAiB,SAAjB;;AAEA,QAAK,KAAL,GAAa,EAAE,MAAF,CAAS,KAAT,EAAgB;AAC5B,eAAW,UADiB;AAE5B,YAAQ,IAFoB;AAG5B,cAAU,CACT,KAAK,SAAL,CAAe,KAAf,GAAuB,GADd,EAET,KAAK,MAFI,CAHkB;AAO5B,YAAQ;AACP,YAAO,oBAAO;AACb,UAAI,IAAI,OAAJ,IAAe,EAAf,IAAqB,IAAI,OAAJ,IAAe,EAAxC,EAA4C;AAC3C,WAAI,OAAK,KAAL,CAAW,QAAX,CAAoB,SAAS,aAA7B,CAAJ,EAAiD;AAChD,eAAK,OAAL,CAAa,KAAb;AACA;;AAED,WAAI,eAAJ;AACA,cAAK,IAAL;AACA;AACD;AAVM;AAPoB,IAAhB,CAAb;;AAqBA;AACA,OAAI,KAAK,MAAL,CAAY,OAAZ,CAAoB,QAApB,CAAJ,EAAmC;AAClC,SAAK,MAAL,CAAY,IAAZ,GAAmB,KAAK,GAAL,CAAS,EAAT,EAAa,KAAK,MAAL,CAAY,QAAZ,CAAqB,MAAlC,CAAnB;AACA;AACD,GA7BgB;;AA+BjB,QAAM,gBAAW;AAAA;;AAChB,KAAE,MAAF,CAAS,CAAC,KAAK,OAAN,EAAe,KAAK,KAApB,CAAT,EAAqC,iBAArC;;AAEA,QAAK,KAAL,GAAa,IAAb;;AAEA,QAAK,YAAL,GAAoB,eAAO;AAC1B,QAAI,CAAC,OAAK,KAAL,CAAW,QAAX,CAAoB,IAAI,MAAxB,CAAD,IAAoC,CAAC,OAAK,OAAL,CAAa,QAAb,CAAsB,IAAI,MAA1B,CAAzC,EAA4E;AAC3E,YAAK,IAAL;AACA;AACD,IAJD;;AAMA,QAAK,QAAL,GAAgB,eAAO;AACtB,QAAI,SAAS,OAAK,OAAL,CAAa,qBAAb,EAAb;AACA,QAAI,IAAI,OAAO,IAAf;AACA,QAAI,IAAI,OAAO,MAAf;;AAEC;AACD,MAAE,KAAF,CAAQ,OAAK,KAAb,EAAoB,EAAE,KAAS,CAAT,OAAF,EAAkB,MAAS,CAAT,OAAlB,EAApB;AACA,IAPD;;AASA,QAAK,QAAL;;AAEA,YAAS,IAAT,CAAc,WAAd,CAA0B,KAAK,KAA/B;;AAEA,yBAAsB;AAAA,WAAK,OAAK,KAAL,CAAW,eAAX,CAA2B,QAA3B,CAAL;AAAA,IAAtB,EAxBgB,CAwBkD;;AAElE,KAAE,MAAF,CAAS,QAAT,EAAmB,aAAnB,EAAkC,KAAK,YAAvC,EAAqD,IAArD;AACA,UAAO,gBAAP,CAAwB,QAAxB,EAAkC,KAAK,QAAvC;AACA,GA3DgB;;AA6DjB,QAAM,gBAAW;AAAA;;AAChB,KAAE,MAAF,CAAS,QAAT,EAAmB,aAAnB,EAAkC,KAAK,YAAvC,EAAqD,IAArD;AACA,UAAO,mBAAP,CAA2B,QAA3B,EAAqC,KAAK,QAA1C;AACA,QAAK,KAAL,CAAW,YAAX,CAAwB,QAAxB,EAAkC,EAAlC,EAHgB,CAGuB;AACvC,QAAK,KAAL,GAAa,KAAb;;AAEA,cAAW,YAAM;AAChB,MAAE,MAAF,CAAS,QAAK,KAAd;AACA,IAFD,EAEG,WAAW,iBAAiB,KAAK,KAAtB,EAA6B,kBAAxC,IAA8D,IAA9D,IAAsE,GAFzE,EANgB,CAQ+D;;AAE/E,KAAE,MAAF,CAAS,KAAK,OAAd,EAAuB;AACtB,4BAAwB,iCAAO;AAC9B,aAAK,IAAL;AACA,KAHqB;AAItB,4BAAwB,iCAAO;AAC9B,SAAI,CAAC,EAAD,EAAK,GAAL,EAAU,OAAV,CAAkB,IAAI,OAAtB,IAAiC,CAAC,CAAtC,EAAyC;AAAE;AAC1C,cAAK,IAAL;AACA,cAAK,MAAL,CAAY,KAAZ;AACA;AACD;AATqB,IAAvB;AAWA,GAlFgB;;AAoFjB,SAAO,iBAAW;AACjB,QAAK,IAAL;AACA,KAAE,MAAF,CAAS,KAAK,OAAd,EAAuB,0CAAvB;AACA,GAvFgB;;AAyFjB,SAAO;AACN,aAAU,WADJ;AAEN,cAAW;AAFL;AAzFU,EAAR,CAAV;AA+FC,CAv/BD,EAu/BG,KAv/BH,EAu/BU,MAAM,CAv/BhB;;AAy/BA;AACA,KAAK,SAAL,CAAe,QAAf,CAAwB,kBAAxB,EAA4C;AAC3C,YAAW,cADgC;AAE3C,WAAU,QAFiC;AAG3C,KAAI,aAHuC;AAI3C,OAAM,cAAS,OAAT,EAAkB;AACvB,UAAQ,YAAR,CAAqB,cAArB,EAAqC,GAArC;;AAEA,UAAQ,gBAAR,CAAyB,OAAzB,EAAkC,eAAO;AACxC,OAAI,UAAU,CAAC,QAAQ,YAAR,CAAqB,cAArB,CAAD,IAAyC,CAAvD;AACA,WAAQ,YAAR,CAAqB,cAArB,EAAqC,UAAU,CAA/C;AACA,GAHD;AAIA;AAX0C,CAA5C","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Primitive = $.Class({\n\textends: Mavo.Unit,\n\tconstructor: function (element, mavo, o) {\n\t\tif (!this.fromTemplate(\"attribute\", \"datatype\", \"humanReadable\", \"templateValue\")) {\n\t\t\t// Which attribute holds the data, if any?\n\t\t\t// \"null\" or null for none (i.e. data is in content).\n\t\t\tthis.attribute = _.getValueAttribute(this.element);\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.humanReadable = this.attribute.humanReadable;\n\t\t\t}\n\n\t\t\tthis.datatype = _.getDatatype(this.element, this.attribute);\n\t\t}\n\n\t\tthis.view = \"read\";\n\n\t\tthis.computed = false;\n\n\t\tMavo.hooks.run(\"primitive-init-start\", this);\n\n\t\t/**\n\t\t * Set up input widget\n\t\t */\n\n\t\t// Exposed widgets (visible always)\n\t\tif (Mavo.is(\"formControl\", this.element)) {\n\t\t\tthis.editor = this.element;\n\t\t\tthis.editorType = \"exposed\";\n\n\t\t\tthis.edit();\n\t\t}\n\t\telse if (!this.computed) {\n\t\t\t// If this is NOT exposed and NOT computed, we need an edit button\n\t\t\tthis.mavo.needsEdit = true;\n\t\t}\n\n\t\t// Nested widgets\n\t\tif (!this.editor && !this.attribute) {\n\t\t\tthis.editor = $$(this.element.children).filter(function (el) {\n\t\t\t    return el.matches(Mavo.selectors.formControl) && !el.matches(Mavo.selectors.property);\n\t\t\t})[0];\n\n\t\t\tif (this.editor) {\n\t\t\t\tthis.editorType = \"nested\";\n\t\t\t\tthis.element.textContent = this.editorValue;\n\t\t\t\t$.remove(this.editor);\n\t\t\t}\n\t\t}\n\n\t\t// Linked widgets\n\t\tif (!this.editor && this.element.hasAttribute(\"data-edit\")) {\n\t\t\tthis.editorType = \"linked\";\n\n\t\t\tvar original = $(this.element.getAttribute(\"data-edit\"));\n\n\t\t\tif (original && Mavo.is(\"formControl\", original)) {\n\t\t\t\tthis.editor = original.cloneNode(true);\n\n\t\t\t\t// Update editor if original mutates\n\t\t\t\tif (!this.template) {\n\t\t\t\t\tMavo.observe(original, \"all\", records => {\n\t\t\t\t\t\tfor (let primitive of this.copies) {\n\t\t\t\t\t\t\tprimitive.editor = original.cloneNode(true);\n\t\t\t\t\t\t\tprimitive.setValue(primitive.value, {force: true, silent: true});\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.templateValue = this.getValue();\n\n\t\tthis.default = this.element.getAttribute(\"data-default\");\n\n\t\tif (this.computed || this.default === \"\") { // attribute exists, no value, default is template value\n\t\t\tthis.default = this.templateValue;\n\t\t}\n\t\telse if (this.default === null) { // attribute does not exist\n\t\t\tthis.default = this.editor? this.editorValue : this.emptyValue;\n\t\t}\n\t\telse {\n\t\t\tMavo.observe(this.element, \"data-default\", record => {\n\t\t\t\tthis.default = this.element.getAttribute(\"data-default\");\n\t\t\t});\n\t\t}\n\n\t\tif (this.collection) {\n\t\t\t// Collection of primitives, deal with setting textContent etc without the UI interfering.\n\t\t\tvar swapUI = callback => {\n\t\t\t\tthis.unobserve();\n\t\t\t\tvar ui = $.remove($(Mavo.selectors.ui, this.element));\n\n\t\t\t\tvar ret = callback();\n\n\t\t\t\t$.inside(ui, this.element);\n\t\t\t\tthis.observe();\n\n\t\t\t\treturn ret;\n\t\t\t};\n\n\t\t\t// Intercept certain properties so that any Mavo UI inside this primitive will not be destroyed\n\t\t\t[\"textContent\", \"innerHTML\"].forEach(property => {\n\t\t\t\tvar descriptor = Object.getOwnPropertyDescriptor(Node.prototype, property);\n\n\t\t\t\tObject.defineProperty(this.element, property, {\n\t\t\t\t\tget: function() {\n\t\t\t\t\t\treturn swapUI(() => descriptor.get.call(this));\n\t\t\t\t\t},\n\n\t\t\t\t\tset: function(value) {\n\t\t\t\t\t\tswapUI(() => descriptor.set.call(this, value));\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (!this.computed) {\n\t\t\tthis.setValue(this.templateValue, {silent: true});\n\t\t}\n\n\t\tthis.setValue(this.template? this.default : this.templateValue, {silent: true});\n\n\t\t// Observe future mutations to this property, if possible\n\t\t// Properties like input.checked or input.value cannot be observed that way\n\t\t// so we cannot depend on mutation observers for everything :(\n\t\tthis.observe();\n\t},\n\n\tget editing() {\n\t\treturn this.view == \"edit\";\n\t},\n\n\tget editorValue() {\n\t\tif (this.getEditorValue) {\n\t\t\tvar value = this.getEditorValue();\n\n\t\t\tif (value !== undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\treturn _.getValue(this.editor, undefined, this.datatype);\n\t\t\t}\n\n\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\tif (output) {\n\t\t\t\treturn _.all.has(output)? _.all.get(output).value : _.getValue(output);\n\t\t\t}\n\t\t}\n\t},\n\n\tset editorValue(value) {\n\t\tif (this.setEditorValue && this.setEditorValue(value) !== undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.editor) {\n\t\t\tif (this.editor.matches(Mavo.selectors.formControl)) {\n\t\t\t\t_.setValue(this.editor, value);\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// if we're here, this.editor is an entire HTML structure\n\t\t\t\tvar output = $(Mavo.selectors.output + \", \" + Mavo.selectors.formControl, this.editor);\n\n\t\t\t\tif (output) {\n\t\t\t\t\tif (_.all.has(output)) {\n\t\t\t\t\t\t_.all.get(output).value = value;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\t_.setValue(output, value);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\n\tget exposed() {\n\t\treturn this.editor === this.element;\n\t},\n\n\tgetData: function(o) {\n\t\to = o || {};\n\n\t\tvar ret = this.super.getData.call(this, o);\n\n\t\tif (ret !== undefined) {\n\t\t\treturn ret;\n\t\t}\n\n\t\tvar ret = !o.dirty && !this.exposed? this.savedValue : this.value;\n\n\t\tif (!o.dirty && ret === \"\") {\n\t\t\treturn null;\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tsave: function() {\n\t\tif (this.placeholder) {\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.savedValue = this.value;\n\t\tthis.unsavedChanges = false;\n\t},\n\n\tdone: function () {\n\t\tthis.unobserve();\n\n\t\tif (this.popup) {\n\t\t\tthis.popup.close();\n\t\t}\n\t\telse if (!this.attribute && !this.exposed && this.editing) {\n\t\t\t$.remove(this.editor);\n\t\t\tthis.element.textContent = this.editorValue;\n\t\t}\n\n\t\tif (!this.exposed) {\n\t\t\tthis.view = \"read\";\n\t\t}\n\n\t\t// Revert tabIndex\n\t\tif (this.element._.data.prevTabindex !== null) {\n\t\t\tthis.element.tabIndex = this.element._.data.prevTabindex;\n\t\t}\n\t\telse {\n\t\t\tthis.element.removeAttribute(\"tabindex\");\n\t\t}\n\n\t\tthis.observe();\n\t},\n\n\trevert: function() {\n\t\tif (this.unsavedChanges && this.savedValue !== undefined) {\n\t\t\t// FIXME if we have a collection of properties (not scopes), this will cause\n\t\t\t// cancel to not remove new unsaved items\n\t\t\t// This should be fixed by handling this on the collection level.\n\t\t\tthis.value = this.savedValue;\n\t\t\tthis.unsavedChanges = false;\n\t\t}\n\t},\n\n\t// Prepare to be edited\n\t// Called when root edit button is pressed\n\tpreEdit: function () {\n\t\tif (this.computed) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Empty properties should become editable immediately\n\t\t// otherwise they could be invisible!\n\t\tif (this.empty && !this.attribute) {\n\t\t\tthis.edit();\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.view == \"preEdit\") {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.view = \"preEdit\";\n\n\t\tvar timer;\n\n\t\tthis.element._.events({\n\t\t\t// click is needed too because it works with the keyboard as well\n\t\t\t\"click.mavo:preedit\": e => this.edit(),\n\t\t\t\"focus.mavo:preedit\": e => {\n\t\t\t\tthis.edit();\n\n\t\t\t\tif (!this.popup) {\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"click.mavo:edit\": evt => {\n\t\t\t\t// Prevent default actions while editing\n\t\t\t\t// e.g. following links etc\n\t\t\t\tif (!this.exposed) {\n\t\t\t\t\tevt.preventDefault();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (!this.attribute) {\n\t\t\tthis.element._.events({\n\t\t\t\t\"mouseenter.mavo:preedit\": e => {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t\ttimer = setTimeout(() => this.edit(), 150);\n\t\t\t\t},\n\t\t\t\t\"mouseleave.mavo:preedit\": e => {\n\t\t\t\t\tclearTimeout(timer);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\t// Make element focusable, so it can actually receive focus\n\t\tthis.element._.data.prevTabindex = this.element.getAttribute(\"tabindex\");\n\t\tthis.element.tabIndex = 0;\n\t},\n\n\t// Called only the first time this primitive is edited\n\tinitEdit: function () {\n\t\tif (!this.editor) {\n\t\t\t// No editor provided, use default for element type\n\t\t\t// Find default editor for datatype\n\t\t\tvar editor = _.getMatch(this.element, _.editors);\n\n\t\t\tif (editor.create) {\n\t\t\t\t$.extend(this, editor, property => property != \"create\");\n\t\t\t}\n\n\t\t\tvar create = editor.create || editor;\n\t\t\tthis.editor = $.create($.type(create) === \"function\"? create.call(this) : create);\n\t\t\tthis.editorValue = this.value;\n\t\t\tthis.editorType = \"created\";\n\t\t}\n\n\t\tthis.editor._.events({\n\t\t\t\"input change\": evt => {\n\t\t\t\tvar unsavedChanges = this.mavo.unsavedChanges;\n\n\t\t\t\tthis.value = this.editorValue;\n\n\t\t\t\t// Editing exposed elements outside edit mode is instantly saved\n\t\t\t\tif (\n\t\t\t\t\tthis.exposed &&\n\t\t\t\t\t!this.mavo.editing && // must not be in edit mode\n\t\t\t\t    this.mavo.permissions.save // must be able to save\n\t\t\t\t) {\n\t\t\t\t\t// TODO what if change event never fires? What if user\n\t\t\t\t\tthis.unsavedChanges = false;\n\t\t\t\t\tthis.mavo.unsavedChanges = unsavedChanges;\n\n\t\t\t\t\t// Must not save too many times (e.g. not while dragging a slider)\n\t\t\t\t\tif (evt.type == \"change\") {\n\t\t\t\t\t\tthis.save(); // Save current element\n\n\t\t\t\t\t\t// Don’t call this.mavo.save() as it will save other fields too\n\t\t\t\t\t\t// We only want to save exposed controls, so save current status\n\t\t\t\t\t\tthis.mavo.storage.save();\n\n\t\t\t\t\t\t// Are there any unsaved changes from other properties?\n\t\t\t\t\t\tthis.mavo.setUnsavedChanges();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"focus\": evt => {\n\t\t\t\tthis.editor.select && this.editor.select();\n\t\t\t},\n\t\t\t\"mavo:datachange\": evt => {\n\t\t\t\tif (evt.property === \"output\") {\n\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t$.fire(this.editor, \"input\");\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\tif (\"placeholder\" in this.editor) {\n\t\t\tthis.editor.placeholder = \"(\" + this.label + \")\";\n\t\t}\n\n\t\tif (!this.exposed) {\n\t\t\t// Copy any data-input-* attributes from the element to the editor\n\t\t\tvar dataInput = /^data-input-/i;\n\t\t\t$$(this.element.attributes).forEach(function (attribute) {\n\t\t\t\tif (dataInput.test(attribute.name)) {\n\t\t\t\t\tthis.editor.setAttribute(attribute.name.replace(dataInput, \"\"), attribute.value);\n\t\t\t\t}\n\t\t\t}, this);\n\n\t\t\tif (this.attribute) {\n\t\t\t\tthis.popup = new _.Popup(this);\n\t\t\t}\n\t\t}\n\n\t\tif (!this.popup) {\n\t\t\tthis.editor.classList.add(\"mv-editor\");\n\t\t}\n\n\t\tthis.initEdit = null;\n\t},\n\n\tedit: function () {\n\t\tif (this.computed || this.editing) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.element._.unbind(\".mavo:preedit\");\n\n\t\tif (this.initEdit) {\n\t\t\tthis.initEdit();\n\t\t}\n\n\t\tif (this.popup) {\n\t\t\tthis.popup.show();\n\t\t}\n\n\t\tif (!this.attribute) {\n\t\t\tif (this.editor.parentNode != this.element && !this.exposed) {\n\t\t\t\tthis.editorValue = this.value;\n\t\t\t\tthis.element.textContent = \"\";\n\n\t\t\t\tif (!this.exposed) {\n\t\t\t\t\tthis.element.appendChild(this.editor);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis.view = \"edit\";\n\t}, // edit\n\n\tclear: function() {\n\t\tthis.value = this.emptyValue;\n\t},\n\n\trender: function(data) {\n\t\tif (Array.isArray(data)) {\n\t\t\tdata = data[0]; // TODO what is gonna happen to the rest? Lost?\n\t\t}\n\n\t\tif (typeof data === \"object\") {\n\t\t\tdata = data[this.property];\n\t\t}\n\n\t\tif (data === undefined) {\n\t\t\t// New property has been added to the schema and nobody has saved since\n\t\t\tthis.value = this.closestCollection? this.default : this.templateValue;\n\t\t}\n\t\telse {\n\t\t\tthis.value = data;\n\t\t}\n\n\t\tthis.save();\n\t},\n\n\tfind: function(property) {\n\t\tif (this.property == property) {\n\t\t\treturn this;\n\t\t}\n\t},\n\n\tobserve: function() {\n\t\tif (!this.computed) {\n\t\t\tthis.observer = Mavo.observe(this.element, this.attribute, this.observer || (record => {\n\t\t\t\tif (this.attribute || !this.mavo.editing) {\n\t\t\t\t\tthis.value = this.getValue();\n\t\t\t\t}\n\t\t\t}));\n\t\t}\n\t},\n\n\tunobserve: function () {\n\t\tthis.observer && this.observer.disconnect();\n\t},\n\n\t/**\n\t * Get value from the DOM\n\t */\n\tgetValue: function(o) {\n\t\treturn _.getValue(this.element, this.attribute, this.datatype, o);\n\t},\n\n\tlazy: {\n\t\tlabel: function() {\n\t\t\treturn Mavo.readable(this.property);\n\t\t},\n\n\t\temptyValue: function() {\n\t\t\tswitch (this.datatype) {\n\t\t\t\tcase \"boolean\":\n\t\t\t\t\treturn false;\n\t\t\t\tcase \"number\":\n\t\t\t\t\treturn 0;\n\t\t\t}\n\n\t\t\treturn \"\";\n\t\t}\n\t},\n\n\tsetValue: function (value, o = {}) {\n\t\tthis.unobserve();\n\n\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\tvar presentational = value.presentational;\n\t\t\tvalue = value.value;\n\t\t}\n\n\t\tvalue = value || value === 0? value : \"\";\n\t\tvalue = _.safeCast(value, this.datatype);\n\n\t\tif (value == this._value && !o.force) {\n\t\t\treturn value;\n\t\t}\n\n\t\tif (this.editor && document.activeElement != this.editor) {\n\t\t\tthis.editorValue = value;\n\t\t}\n\n\t\tif (this.humanReadable && this.attribute) {\n\t\t\tpresentational = this.humanReadable(value);\n\t\t}\n\n\t\tif (!this.editing || this.attribute) {\n\t\t\tif (this.editor && this.editor.matches(\"select\") && this.editor.selectedOptions[0]) {\n\t\t\t\tpresentational = this.editor.selectedOptions[0].textContent;\n\t\t\t}\n\n\t\t\t_.setValue(this.element, {value, presentational}, this.attribute, this.datatype);\n\t\t}\n\n\t\tthis.empty = value === \"\";\n\n\t\tthis._value = value;\n\n\t\tif (!o.silent) {\n\t\t\tif (!this.computed) {\n\t\t\t\tthis.unsavedChanges = this.mavo.unsavedChanges = true;\n\t\t\t}\n\n\t\t\trequestAnimationFrame(() => {\n\t\t\t\t$.fire(this.element, \"mavo:datachange\", {\n\t\t\t\t\tproperty: this.property,\n\t\t\t\t\tvalue: value,\n\t\t\t\t\tmavo: this.mavo,\n\t\t\t\t\tnode: this,\n\t\t\t\t\tdirty: this.editing,\n\t\t\t\t\taction: \"propertychange\"\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (this.view == \"preEdit\") {\n\t\t\tthis.preEdit();\n\t\t}\n\n\t\tthis.observe();\n\n\t\treturn value;\n\t},\n\n\tlive: {\n\t\tvalue: function (value) {\n\t\t\treturn this.setValue(value);\n\t\t},\n\n\t\tempty: function(value) {\n\t\t\tvar hide = value && !this.exposed && !(this.attribute && $(Mavo.selectors.property, this.element));\n\t\t\tthis.element.classList.toggle(\"empty\", hide);\n\t\t},\n\n\t\tview: function (value) {\n\t\t\tthis.element.classList.toggle(\"editing\", value == \"edit\");\n\t\t},\n\n\t\tcomputed: function (value) {\n\t\t\tthis.element.classList.toggle(\"computed\", value);\n\t\t}\n\t},\n\n\tstatic: {\n\t\tall: new WeakMap(),\n\n\t\tgetMatch: function (element, all) {\n\t\t\t// TODO specificity\n\t\t\tvar ret = null;\n\n\t\t\tfor (var selector in all) {\n\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\tret = all[selector];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetValueAttribute: function (element) {\n\t\t\tvar ret = element.getAttribute(\"data-attribute\") || _.getMatch(element, _.attributes);\n\n\t\t\t// TODO refactor this\n\t\t\tif (ret && ret.value) {\n\t\t\t\tret = $.extend(new String(ret.value), ret);\n\t\t\t}\n\n\t\t\tif (!ret || ret === \"null\") {\n\t\t\t\tret = null;\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t},\n\n\t\tgetDatatype: function (element, attribute) {\n\t\t\tvar ret = element.getAttribute(\"datatype\");\n\n\t\t\tif (!ret) {\n\t\t\t\tfor (var selector in _.datatypes) {\n\t\t\t\t\tif (element.matches(selector)) {\n\t\t\t\t\t\tret = _.datatypes[selector][attribute];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tret = ret || \"string\";\n\n\t\t\treturn ret;\n\t\t},\n\n\t\t/**\n\t\t * Only cast if conversion is lossless\n\t\t */\n\t\tsafeCast: function(value, datatype) {\n\t\t\tvar existingType = typeof value;\n\t\t\tvar cast = _.cast(value, datatype);\n\n\t\t\tif (value === null || value === undefined) {\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"boolean\") {\n\t\t\t\tif (value === \"false\" || value === 0 || value === \"\") {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif (value === \"true\" || value > 0) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tif (datatype == \"number\") {\n\t\t\t\tif (/^[-+]?[0-9.e]+$/i.test(value + \"\")) {\n\t\t\t\t\treturn cast;\n\t\t\t\t}\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\treturn cast;\n\t\t},\n\n\t\t/**\n\t\t * Cast to a different primitive datatype\n\t\t */\n\t\tcast: function(value, datatype) {\n\t\t\tswitch (datatype) {\n\t\t\t\tcase \"number\": return +value;\n\t\t\t\tcase \"boolean\": return !!value;\n\t\t\t\tcase \"string\": return value + \"\";\n\t\t\t}\n\n\t\t\treturn value;\n\t\t},\n\n\t\tgetValue: function (element, attribute, datatype, o = {}) {\n\t\t\tattribute = attribute || attribute === null? attribute : _.getValueAttribute(element);\n\t\t\tdatatype = datatype || _.getDatatype(element, attribute);\n\n\t\t\tvar ret;\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute)) {\n\t\t\t\t// Returning properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\tret = element[attribute];\n\t\t\t}\n\t\t\telse if (attribute) {\n\t\t\t\tret = element.getAttribute(attribute);\n\t\t\t}\n\t\t\telse {\n\t\t\t\tret = element.getAttribute(\"content\") || element.textContent || null;\n\t\t\t}\n\n\t\t\treturn _.safeCast(ret, datatype);\n\t\t},\n\n\t\tsetValue: function (element, value, attribute, datatype) {\n\t\t\tif ($.type(value) == \"object\" && \"value\" in value) {\n\t\t\t\tvar presentational = value.presentational;\n\t\t\t\tvalue = value.value;\n\t\t\t}\n\n\t\t\tif (attribute !== null) {\n\t\t\t\tattribute = attribute ||  _.getValueAttribute(element);\n\t\t\t}\n\n\t\t\tif (attribute in element && _.useProperty(element, attribute) && element[attribute] != value) {\n\t\t\t\t// Setting properties (if they exist) instead of attributes\n\t\t\t\t// is needed for dynamic elements such as checkboxes, sliders etc\n\t\t\t\ttry {\n\t\t\t\t\telement[attribute] = value;\n\t\t\t\t}\n\t\t\t\tcatch (e) {}\n\t\t\t}\n\n\t\t\t// Set attribute anyway, even if we set a property because when\n\t\t\t// they're not in sync it gets really fucking confusing.\n\t\t\tif (attribute) {\n\t\t\t\tif (element.getAttribute(attribute) != value) { // intentionally non-strict, e.g. \"3.\" !== 3\n\t\t\t\t\telement.setAttribute(attribute, value);\n\n\t\t\t\t\tif (presentational) {\n\t\t\t\t\t\telement.textContent = presentational;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (datatype === \"number\" && !presentational) {\n\t\t\t\t\tpresentational = _.formatNumber(value);\n\t\t\t\t}\n\n\t\t\t\telement.textContent = presentational || value;\n\n\t\t\t\tif (presentational && element.setAttribute) {\n\t\t\t\t\telement.setAttribute(\"content\", value);\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t *  Set/get a property or an attribute?\n\t\t * @return {Boolean} true to use a property, false to use the attribute\n\t\t */\n\t\tuseProperty: function(element, attribute) {\n\t\t\tif ([\"href\", \"src\"].indexOf(attribute) > -1) {\n\t\t\t\t// URL properties resolve \"\" as location.href, fucking up emptiness checks\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tif (element.namespaceURI == \"http://www.w3.org/2000/svg\") {\n\t\t\t\t// SVG has a fucked up DOM, do not use these properties\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn true;\n\t\t},\n\n\t\tregister: function(selector, o = {}) {\n\t\t\tif (o.attribute) {\n\t\t\t\tMavo.Primitive.attributes[selector] = o.attribute;\n\t\t\t}\n\n\t\t\tif (o.datatype) {\n\t\t\t\tMavo.Primitive.datatypes[selector] = o.datatype;\n\t\t\t}\n\n\t\t\tif (o.editor) {\n\t\t\t\tMavo.Primitive.editors[selector] = o.editor;\n\t\t\t}\n\n\t\t\tif (o.init) {\n\t\t\t\tMavo.hooks.add(\"primitive-init-start\", function() {\n\t\t\t\t\tif (this.element.matches(selector)) {\n\t\t\t\t\t\to.init.call(this, this.element);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tfor (let id of Mavo.toArray(o.is)) {\n\t\t\t\tMavo.selectors[id] += \", \" + selector;\n\t\t\t}\n\t\t},\n\n\t\tlazy: {\n\t\t\tformatNumber: () => {\n\t\t\t\tvar numberFormat = new Intl.NumberFormat(\"en-US\", {maximumFractionDigits:2});\n\n\t\t\t\treturn function(value) {\n\t\t\t\t\tif (value === Infinity || value === -Infinity) {\n\t\t\t\t\t\t// Pretty print infinity\n\t\t\t\t\t\treturn value < 0? \"-∞\" : \"∞\";\n\t\t\t\t\t}\n\n\t\t\t\t\treturn numberFormat.format(value);\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t}\n});\n\n// Define default attributes\n_.attributes = {\n\t\"img, video, audio\": \"src\",\n\t\"a, link\": \"href\",\n\t\"select, input, textarea, meter, progress\": \"value\",\n\t\"input[type=checkbox]\": \"checked\",\n\t\"time\": {\n\t\tvalue: \"datetime\",\n\t\thumanReadable: function (value) {\n\t\t\tvar date = new Date(value);\n\n\t\t\tif (!value || isNaN(date)) {\n\t\t\t\treturn \"(No \" + this.label + \")\";\n\t\t\t}\n\n\t\t\t// TODO do this properly (account for other datetime datatypes and different formats)\n\t\t\tvar options = {\n\t\t\t\t\"date\": {day: \"numeric\", month: \"short\", year: \"numeric\"},\n\t\t\t\t\"month\": {month: \"long\"},\n\t\t\t\t\"time\": {hour: \"numeric\", minute: \"numeric\"},\n\t\t\t\t\"datetime-local\": {day: \"numeric\", month: \"short\", year: \"numeric\", hour: \"numeric\", minute: \"numeric\"}\n\t\t\t};\n\n\t\t\tvar format = options[this.editor && this.editor.type] || options.date;\n\t\t\tformat.timeZone = \"UTC\";\n\n\t\t\treturn date.toLocaleString(\"en-GB\", format);\n\t\t}\n\t},\n\t\"meta\": \"content\"\n};\n\n// Basic datatypes per attribute\n// Only number, boolean\n_.datatypes = {\n\t\"input[type=checkbox]\": {\n\t\t\"checked\": \"boolean\"\n\t},\n\t\"input[type=range], input[type=number], meter, progress\": {\n\t\t\"value\": \"number\"\n\t}\n};\n\n_.editors = {\n\t\"*\": {\"tag\": \"input\"},\n\n\t\".number\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"number\"\n\t},\n\n\t\".boolean\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"checkbox\"\n\t},\n\n\t\"a, img, video, audio, .url\": {\n\t\t\"tag\": \"input\",\n\t\t\"type\": \"url\",\n\t\t\"placeholder\": \"http://\"\n\t},\n\n\t// Block elements\n\t\"p, div, li, dt, dd, h1, h2, h3, h4, h5, h6, article, section, address, .multiline\": {\n\t\tcreate: function() {\n\t\t\tvar display = getComputedStyle(this.element).display;\n\t\t\tvar tag = display.indexOf(\"inline\") === 0? \"input\" : \"textarea\";\n\t\t\tvar editor = $.create(tag);\n\n\t\t\tif (tag == \"textarea\") {\n\t\t\t\t// Actually multiline\n\t\t\t\tvar width = this.element.offsetWidth;\n\n\t\t\t\tif (width) {\n\t\t\t\t\teditor.width = width;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn editor;\n\t\t},\n\n\t\tsetEditorValue: function(value) {\n\t\t\tif (this.datatype != \"string\") {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvar cs = getComputedStyle(this.element);\n\t\t\tvalue = value || \"\";\n\n\t\t\tif ([\"normal\", \"nowrap\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse lines\n\t\t\t\tvalue = value.replace(/\\r?\\n/g, \" \");\n\t\t\t}\n\n\t\t\tif ([\"normal\", \"nowrap\", \"pre-line\"].indexOf(cs.whiteSpace) > -1) {\n\t\t\t\t// Collapse whitespace\n\t\t\t\tvalue = value.replace(/^[ \\t]+|[ \\t]+$/gm, \"\").replace(/[ \\t]+/g, \" \");\n\t\t\t}\n\n\t\t\tthis.editor.value = value;\n\t\t\treturn true;\n\t\t}\n\t},\n\n\t\"meter, progress\": function() {\n\t\treturn $.create({\n\t\t\ttag: \"input\",\n\t\t\ttype: \"range\",\n\t\t\tmin: this.element.getAttribute(\"min\") || 0,\n\t\t\tmax: this.element.getAttribute(\"max\") || 100\n\t\t});\n\t},\n\n\t\"time, .date\": function() {\n\t\tvar types = {\n\t\t\t\"date\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2}$/i,\n\t\t\t\"month\": /^[Y\\d]{4}-[M\\d]{2}$/i,\n\t\t\t\"time\": /^[H\\d]{2}:[M\\d]{2}/i,\n\t\t\t\"week\": /[Y\\d]{4}-W[W\\d]{2}$/i,\n\t\t\t\"datetime-local\": /^[Y\\d]{4}-[M\\d]{2}-[D\\d]{2} [H\\d]{2}:[M\\d]{2}/i\n\t\t};\n\n\t\tvar datetime = this.element.getAttribute(\"datetime\") || \"YYYY-MM-DD\";\n\n\t\tfor (var type in types) {\n\t\t\tif (types[type].test(datetime)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn $.create(\"input\", {type: type});\n\t}\n};\n\n_.Popup = $.Class({\n\tconstructor: function(primitive) {\n\t\tthis.primitive = primitive;\n\n\t\tthis.popup = $.create(\"div\", {\n\t\t\tclassName: \"mv-popup\",\n\t\t\thidden: true,\n\t\t\tcontents: [\n\t\t\t\tthis.primitive.label + \":\",\n\t\t\t\tthis.editor\n\t\t\t],\n\t\t\tevents: {\n\t\t\t\tkeyup: evt => {\n\t\t\t\t\tif (evt.keyCode == 13 || evt.keyCode == 27) {\n\t\t\t\t\t\tif (this.popup.contains(document.activeElement)) {\n\t\t\t\t\t\t\tthis.element.focus();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tevt.stopPropagation();\n\t\t\t\t\t\tthis.hide();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\t// No point in having a dropdown in a popup\n\t\tif (this.editor.matches(\"select\")) {\n\t\t\tthis.editor.size = Math.min(10, this.editor.children.length);\n\t\t}\n\t},\n\n\tshow: function() {\n\t\t$.unbind([this.element, this.popup], \".mavo:showpopup\");\n\n\t\tthis.shown = true;\n\n\t\tthis.hideCallback = evt => {\n\t\t\tif (!this.popup.contains(evt.target) && !this.element.contains(evt.target)) {\n\t\t\t\tthis.hide();\n\t\t\t}\n\t\t};\n\n\t\tthis.position = evt => {\n\t\t\tvar bounds = this.element.getBoundingClientRect();\n\t\t\tvar x = bounds.left;\n\t\t\tvar y = bounds.bottom;\n\n\t\t\t // TODO what if it doesn’t fit?\n\t\t\t$.style(this.popup, { top:  `${y}px`, left: `${x}px` });\n\t\t};\n\n\t\tthis.position();\n\n\t\tdocument.body.appendChild(this.popup);\n\n\t\trequestAnimationFrame(e => this.popup.removeAttribute(\"hidden\")); // trigger transition\n\n\t\t$.events(document, \"focus click\", this.hideCallback, true);\n\t\twindow.addEventListener(\"scroll\", this.position);\n\t},\n\n\thide: function() {\n\t\t$.unbind(document, \"focus click\", this.hideCallback, true);\n\t\twindow.removeEventListener(\"scroll\", this.position);\n\t\tthis.popup.setAttribute(\"hidden\", \"\"); // trigger transition\n\t\tthis.shown = false;\n\n\t\tsetTimeout(() => {\n\t\t\t$.remove(this.popup);\n\t\t}, parseFloat(getComputedStyle(this.popup).transitionDuration) * 1000 || 400); // TODO transition-duration could override this\n\n\t\t$.events(this.element, {\n\t\t\t\"click.mavo:showpopup\": evt => {\n\t\t\t\tthis.show();\n\t\t\t},\n\t\t\t\"keyup.mavo:showpopup\": evt => {\n\t\t\t\tif ([13, 113].indexOf(evt.keyCode) > -1) { // Enter or F2\n\t\t\t\t\tthis.show();\n\t\t\t\t\tthis.editor.focus();\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\tclose: function() {\n\t\tthis.hide();\n\t\t$.unbind(this.element, \".mavo:edit .mavo:preedit .mavo:showpopup\");\n\t},\n\n\tproxy: {\n\t\t\"editor\": \"primitive\",\n\t\t\"element\": \"primitive\"\n\t}\n});\n\n})(Bliss, Bliss.$);\n\n// Example plugin: button\nMavo.Primitive.register(\"button, .counter\", {\n\tattribute: \"data-clicked\",\n\tdatatype: \"number\",\n\tis: \"formControl\",\n\tinit: function(element) {\n\t\telement.setAttribute(\"data-clicked\", \"0\");\n\n\t\telement.addEventListener(\"click\", evt => {\n\t\t\tlet clicked = +element.getAttribute(\"data-clicked\") || 0;\n\t\t\telement.setAttribute(\"data-clicked\", clicked + 1);\n\t\t});\n\t}\n});\n"],"sourceRoot":"/source/"}