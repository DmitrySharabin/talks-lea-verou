{"version":3,"sources":["expressions.js"],"names":[],"mappings":"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","file":"mavo.es5.js","sourcesContent":["(function($, $$) {\n\nvar _ = Mavo.Expressions = $.Class({\n\tconstructor: function(mavo) {\n\t\tthis.mavo = mavo;\n\n\t\tthis.expressions = [];\n\n\t\tvar syntax = Mavo.Expression.Syntax.create(this.mavo.element.closest(\"[mv-expressions]\")) || Mavo.Expression.Syntax.default;\n\t\tthis.traverse(this.mavo.element, undefined, syntax);\n\n\t\tthis.scheduled = new Set();\n\n\t\t// Watch changes and update value\n\t\tthis.mavo.treeBuilt.then(() => {\n\t\t\tfor (let et of this.expressions) {\n\t\t\t\tet.item = Mavo.Node.get(et.element.closest(Mavo.selectors.multiple + \", \" + Mavo.selectors.group));\n\t\t\t\tet.item.expressions = et.item.expressions || [];\n\t\t\t\tet.item.expressions.push(et);\n\n\t\t\t\tvar mavoNode = Mavo.Node.get(et.element, true);\n\n\t\t\t\tif (mavoNode && mavoNode instanceof Mavo.Primitive && mavoNode.attribute == et.attribute) {\n\t\t\t\t\tet.primitive = mavoNode;\n\t\t\t\t\tmavoNode.store = mavoNode.store || \"none\";\n\t\t\t\t\tmavoNode.modes = \"read\";\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.mavo.element.addEventListener(\"mavo:datachange\", evt => {\n\t\t\t\tif (evt.action == \"propertychange\" && evt.node.closestCollection) {\n\t\t\t\t\t// Throttle propertychange events in collections\n\t\t\t\t\tif (!this.scheduled.has(evt.property)) {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tthis.scheduled.delete(evt.property);\n\t\t\t\t\t\t\tthis.update(evt);\n\t\t\t\t\t\t}, _.PROPERTYCHANGE_THROTTLE);\n\n\t\t\t\t\t\tthis.scheduled.add(evt.property);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\trequestAnimationFrame(() => this.update(evt));\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.update();\n\t\t});\n\t},\n\n\tupdate: function callee(evt) {\n\t\tvar root, rootGroup;\n\n\t\tif (evt instanceof Element) {\n\t\t\troot = evt.closest(Mavo.selectors.group);\n\t\t\tevt = null;\n\t\t}\n\n\t\troot = root || this.mavo.element;\n\t\trootGroup = Mavo.Node.get(root);\n\n\t\tvar data = rootGroup.getData({\n\t\t\trelative: true,\n\t\t\tstore: \"*\",\n\t\t\tnull: true,\n\t\t\tunhandled: this.mavo.unhandled\n\t\t});\n\n\t\trootGroup.walk((obj, path) => {\n\t\t\tif (obj.expressions && obj.expressions.length && !obj.isDeleted()) {\n\t\t\t\tlet env = { context: this, data: $.value(data, ...path) };\n\n\t\t\t\tMavo.hooks.run(\"expressions-update-start\", env);\n\n\t\t\t\tfor (let et of obj.expressions) {\n\t\t\t\t\tif (et.changedBy(evt)) {\n\t\t\t\t\t\tet.update(env.data, evt);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t},\n\n\textract: function(node, attribute, path, syntax) {\n\t\tif (attribute && attribute.name == \"mv-expressions\") {\n\t\t\treturn;\n\t\t}\n\n\t\tif ((attribute && _.directives.indexOf(attribute.name) > -1) ||\n\t\t    syntax.test(attribute? attribute.value : node.textContent)\n\t\t) {\n\t\t\tthis.expressions.push(new Mavo.ExpressionText({\n\t\t\t\tnode, syntax,\n\t\t\t\tpath: path? path.slice(1).split(\"/\").map(i => +i) : [],\n\t\t\t\tattribute: attribute && attribute.name,\n\t\t\t\tmavo: this.mavo\n\t\t\t}));\n\t\t}\n\t},\n\n\t// Traverse an element, including attribute nodes, text nodes and all descendants\n\ttraverse: function(node, path = \"\", syntax) {\n\t\tif (node.nodeType === 8) {\n\t\t\t// We don't want expressions to be picked up from comments!\n\t\t\t// Commenting stuff out is a common debugging technique\n\t\t\treturn;\n\t\t}\n\n\t\tif (node.nodeType === 3) { // Text node\n\t\t\t// Leaf node, extract references from content\n\t\t\tthis.extract(node, null, path, syntax);\n\t\t}\n\t\telse {\n\t\t\tnode.normalize();\n\n\t\t\tsyntax = Mavo.Expression.Syntax.create(node) || syntax;\n\n\t\t\tif (syntax === Mavo.Expression.Syntax.ESCAPE) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (Mavo.is(\"multiple\", node)) {\n\t\t\t\tpath = \"\";\n\t\t\t}\n\n\t\t\t$$(node.attributes).forEach(attribute => this.extract(node, attribute, path, syntax));\n\t\t\t$$(node.childNodes).forEach((child, i) => this.traverse(child, `${path}/${i}`, syntax));\n\t\t}\n\t},\n\n\tstatic: {\n\t\tdirectives: [],\n\n\t\tPROPERTYCHANGE_THROTTLE: 50,\n\n\t\tdirective: function(name, o) {\n\t\t\t_.directives.push(name);\n\t\t\tMavo.attributes.push(name);\n\n\t\t\tMavo.plugin(o);\n\t\t}\n\t}\n});\n\nif (self.Proxy) {\n\tMavo.hooks.add(\"node-getdata-end\", function(env) {\n\t\tif (env.options.relative && (env.data && typeof env.data === \"object\" || this.collection)) {\n\t\t\tvar data = env.data;\n\n\t\t\tif (this instanceof Mavo.Primitive) {\n\t\t\t\tenv.data = {\n\t\t\t\t\t[Symbol.toPrimitive]: () => data,\n\t\t\t\t\t[this.property]: data\n\t\t\t\t};\n\t\t\t}\n\n\t\t\tenv.data = new Proxy(env.data, {\n\t\t\t\tget: (data, property, proxy) => {\n\t\t\t\t\t// Checking if property is in proxy might add it to the data\n\t\t\t\t\tif (property in data || (property in proxy && property in data)) {\n\t\t\t\t\t\treturn data[property];\n\t\t\t\t\t}\n\t\t\t\t},\n\n\t\t\t\thas: (data, property) => {\n\t\t\t\t\tif (property in data) {\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Property does not exist, look for it elsewhere\n\n\t\t\t\t\tif (property == \"$index\") {\n\t\t\t\t\t\treturn data[property] = (this.index || 0) + 1;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$all\") {\n\t\t\t\t\t\treturn data[property] = this.closestCollection? this.closestCollection.getData(env.options) : [env.data];\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == \"$next\" || property == \"$previous\") {\n\t\t\t\t\t\tif (this.closestCollection) {\n\t\t\t\t\t\t\treturn data[property] = this.closestCollection.getData(env.options)[this.index + (property == \"$next\"? 1 : -1)];\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn data[property] = null;\n\t\t\t\t\t}\n\n\t\t\t\t\tif (property == this.mavo.id) {\n\t\t\t\t\t\treturn data[property] = this.mavo.root.getData(env.options);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (this instanceof Mavo.Group && property == this.property && this.collection) {\n\t\t\t\t\t\treturn data[property] = env.data;\n\t\t\t\t\t}\n\n\t\t\t\t\t// First look in ancestors\n\t\t\t\t\tvar ret = this.walkUp(group => {\n\t\t\t\t\t\tif (property in group.children) {\n\t\t\t\t\t\t\treturn group.children[property];\n\t\t\t\t\t\t};\n\t\t\t\t\t});\n\n\t\t\t\t\tif (ret === undefined) {\n\t\t\t\t\t\t// Still not found, look in descendants\n\t\t\t\t\t\tret = this.find(property);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (ret !== undefined) {\n\t\t\t\t\t\tif (Array.isArray(ret)) {\n\t\t\t\t\t\t\tret = ret.map(item => item.getData(env.options))\n\t\t\t\t\t\t\t\t\t .filter(item => item !== null);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (ret instanceof Mavo.Node) {\n\t\t\t\t\t\t\tret = ret.getData(env.options);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdata[property] = ret;\n\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\n\t\t\t\t\treturn false;\n\t\t\t\t},\n\n\t\t\t\tset: function(data, property, value) {\n\t\t\t\t\tthrow Error(\"You can’t set data via expressions.\");\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nMavo.hooks.add(\"init-tree-before\", function() {\n\tthis.expressions = new Mavo.Expressions(this);\n});\n\n// Must be at a hook that collections don't have a marker yet which messes up paths\nMavo.hooks.add(\"node-init-end\", function() {\n\tvar template = this.template;\n\n\tif (template && template.expressions) {\n\t\t// We know which expressions we have, don't traverse again\n\t\tthis.expressions = template.expressions.map(et => new Mavo.ExpressionText({\n\t\t\ttemplate: et,\n\t\t\titem: this,\n\t\t\tmavo: this.mavo\n\t\t}));\n\t}\n});\n\n// TODO what about granular rendering?\nMavo.hooks.add(\"render-end\", function() {\n\tthis.expressions.update();\n});\n\nMavo.hooks.add(\"collection-add-end\", function(env) {\n\tthis.mavo.expressions.update(env.item.element);\n});\n\n})(Bliss, Bliss.$);\n\n// mv-value plugin\nMavo.Expressions.directive(\"mv-value\", {\n\thooks: {\n\t\t\"expressiontext-init-start\": function() {\n\t\t\tif (this.attribute == \"mv-value\") {\n\t\t\t\tthis.attribute = Mavo.Primitive.getValueAttribute(this.element);\n\t\t\t\tthis.fallback = this.fallback || Mavo.Primitive.getValue(this.element, {attribute: this.attribute});\n\t\t\t\tthis.expression = this.element.getAttribute(\"mv-value\");\n\n\t\t\t\tthis.parsed = [new Mavo.Expression(this.expression)];\n\t\t\t\tthis.expression = this.syntax.start + this.expression + this.syntax.end;\n\t\t\t}\n\t\t}\n\t}\n});\n"],"sourceRoot":"/source/"}